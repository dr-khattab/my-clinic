<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head><link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Nabed%20-%20%D9%86%D8%A7%D8%A8%D8%B6%22%2C%22short_name%22%3A%22Nabed%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%232e8b57%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22logo.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2e8b57">
<link rel="apple-touch-icon" href="logo.png">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
// إعدادات Firebase الخاصة بك
const firebaseConfig = {
    apiKey: "AIzaSyDkOlGVZRR-YJL5iYxTgoMgTq2eICKAFIs",
    authDomain: "clinicsystem-84678.firebaseapp.com",
    projectId: "clinicsystem-84678",
    storageBucket: "clinicsystem-84678.firebasestorage.app",
    messagingSenderId: "470631564686",
    appId: "1:470631564686:web:8af6ef47f8cda48b60d0df"
};

// تشغيل قاعدة البيانات مع تفعيل المزامنة المحلية (Offline Persistence)
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

// تفعيل ميزة العمل بدون إنترنت - الخطوة الأولى في الخطة
db.enablePersistence({ synchronizeTabs: true })
  .catch((err) => {
      if (err.code == 'failed-precondition') {
          console.warn("إشعار: المزامنة تعمل في تبويب واحد فقط حالياً");
      } else if (err.code == 'unimplemented') {
          console.warn("المتصفح لا يدعم ميزة الأوفلاين");
      }
  });
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nabed - نابض | Pulse of Medical Clinics</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* --- التنسيقات الأساسية للسيستم (بدون تغيير) --- */
:root{--primary:#2E86C1;--secondary:#27AE60;--accent:#F39C12;--light:#F8F9FA;--dark:#2C3E50;--danger:#E74C3C;--gray:#7F8C8D;--light-gray:#ECF0F1;}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;}
body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;position:relative;}
body::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:url('https://images.unsplash.com/photo-1559757175-0eb30cd8c063?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80') no-repeat center center;background-size:cover;opacity:0.1;z-index:-1;}
.system-container{width:100%;max-width:1400px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.2);overflow:hidden;}

/* --- تعديل واجهة تسجيل الدخول (Modern Nabed Style) --- */
.login-container {
    padding: 60px 40px;
    text-align: center;
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
}
.login-container::before { display: none; } /* إلغاء الطبقة القديمة */

.clinic-logo-new {
    width: 130px; height: 130px;
    background: white;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.clinic-logo-new img { width: 80%; height: auto; object-fit: contain; }

.clinic-name { 
    color: white; font-size: 42px; font-weight: 800; 
    letter-spacing: 2px; margin-bottom: 5px; 
}
.doctor-name { color: rgba(255,255,255,0.8); font-size: 16px; letter-spacing: 1px; margin-bottom: 40px; font-weight: 300; }

.user-selector { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
.user-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 20px; padding: 25px; width: 180px;
    cursor: pointer; transition: all 0.3s ease; color: white;
}
.user-card:hover { transform: translateY(-10px); background: rgba(255,255,255,0.2); border-color: white; }
.user-title { font-weight: 700; color: white; font-size: 18px; text-transform: uppercase; }
.user-desc { color: rgba(255,255,255,0.7); font-size: 11px; }

/* --- تعديل أيقونة المحادثة (Floating & Draggable) --- */
.comm-icon {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 65px;
    height: 65px;
    background: #3498db;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 30px;
    cursor: grab; /* يد للسحب */
    z-index: 9999;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    border: 3px solid white;
    transition: transform 0.1s ease;
    touch-action: none; /* مهم للموبايل */
}
.comm-icon:active { cursor: grabbing; }

/* تنبيه الرسالة الجديدة (النقطة النباضة) */
.comm-icon.has-message::after {
    content: '';
    position: absolute;
    top: 2px;
    right: 2px;
    width: 18px;
    height: 18px;
    background: #ff4757;
    border-radius: 50%;
    border: 2px solid white;
    animation: pulse-red 1.5s infinite;
}

@keyframes pulse-red {
    0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
    100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
}

/* --- باقي تنسيقات السيستم الأصلية (بدون أي تغيير) --- */
.login-form{max-width:400px;margin:0 auto;background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
.form-group{margin-bottom:25px;}
.form-label{display:block;text-align:right;margin-bottom:8px;font-weight:600;color:var(--dark);}
.form-input{width:100%;padding:15px;border:2px solid var(--light-gray);border-radius:10px;font-size:16px;transition:all 0.3s;}
.form-input:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(46,134,193,0.2);}
.login-btn{padding:15px 30px;background:linear-gradient(135deg,var(--primary)0%,#1B4F72 100%);color:white;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;justify-content:center;gap:8px;}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(46,134,193,0.3);}
.dashboard{display:none;}
.header{background:linear-gradient(135deg,var(--primary)0%,#1B4F72 100%);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;}
.nav-menu{display:flex;gap:15px;padding:20px;background:var(--light);border-bottom:1px solid var(--light-gray);flex-wrap:wrap;}
.nav-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;}
.nav-btn:hover{background:#1B4F72;transform:translateY(-2px);}
.nav-btn.active{background:var(--secondary);}
.content-area{padding:30px;min-height:600px;}
.form-container{background:white;padding:25px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.1);margin-bottom:25px;}
.form-title{color:var(--primary);margin-bottom:20px;font-size:24px;border-bottom:2px solid var(--light-gray);padding-bottom:10px;}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px;}
.data-table{width:100%;border-collapse:collapse;margin-top:20px;background:white;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.data-table th{background:var(--primary);color:white;padding:15px;text-align:right;font-weight:600;}
.data-table td{padding:12px 15px;border-bottom:1px solid var(--light-gray);}
.data-table tr:hover{background:#f8f9fa;}
.action-btn{padding:6px 12px;border:none;border-radius:5px;cursor:pointer;font-size:14px;margin:0 3px;}
.edit-btn{background:var(--accent);color:white;}
.delete-btn{background:var(--danger);color:white;}
.record-btn{background:var(--secondary);color:white;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;}
.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:15px;max-width:90%;max-height:90%;overflow-y:auto;}
.close-btn{position:absolute;top:15px;left:15px;font-size:24px;cursor:pointer;color:var(--gray);}
.autocomplete{position:relative;}
.autocomplete-items{position:absolute;border:1px solid var(--light-gray);border-top:none;z-index:99;top:100%;left:0;right:0;background:white;max-height:200px;overflow-y:auto;border-radius:0 0 10px 10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.autocomplete-item{padding:12px 15px;cursor:pointer;border-bottom:1px solid var(--light-gray);transition:background 0.2s;}
.autocomplete-item:hover{background:var(--light);}
.visit-section{background:white;padding:20px;border-radius:10px;margin-bottom:20px;border-left:4px solid var(--primary);}
.patient-info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;}
.info-item{background:var(--light);padding:15px;border-radius:8px;}
.info-label{font-weight:600;color:var(--gray);margin-bottom:5px;}
.info-value{font-weight:700;color:var(--dark);}
.age-inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.print-prescription{background:white;padding:25px;border:2px dashed var(--light-gray);border-radius:10px;margin-top:20px;}
.prescription-header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--primary);}
.prescription-medications{margin:20px 0;}
.medication-form{background:var(--light);padding:20px;border-radius:10px;margin-bottom:15px;}
.medication-preview{background:white;border:1px solid var(--light-gray);border-radius:8px;padding:15px;margin-bottom:10px;}
.previous-visits{background:#fff9e6;border-left:4px solid var(--accent);}
.visit-item{background:white;padding:15px;border-radius:8px;margin-bottom:10px;border:1px solid var(--light-gray);}
.visit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.visit-date{font-weight:600;color:var(--primary);}
.prescription-item{margin-bottom:15px;padding:10px;border-bottom:1px solid #eee;}
.prescription-item-main{font-weight:bold;margin-bottom:5px;}
.prescription-item-details{padding-right:20px;color:#555;}
.format-toolbar{background:#f5f5f5;padding:10px;border-radius:8px;margin-bottom:15px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border:1px solid #ddd;}
.format-toolbar button{padding:6px 12px;background:white;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;min-width:36px;height:36px;}
.format-toolbar button:hover{background:#e9e9e9;}
.format-toolbar button.active{background:var(--primary);color:white;border-color:var(--primary);}
.format-toolbar select{padding:6px;border:1px solid #ddd;border-radius:4px;background:white;min-width:120px;height:36px;}
.format-toolbar input[type="color"]{width:36px;height:36px;padding:2px;border:1px solid #ddd;border-radius:4px;cursor:pointer;}
.format-toolbar input[type="number"]{width:60px;padding:6px;border:1px solid #ddd;border-radius:4px;text-align:center;}
.format-toolbar .toolbar-group{display:flex;align-items:center;gap:5px;padding:0 10px;border-right:1px solid #ddd;}
.format-toolbar .toolbar-group:last-child{border-right:none;}
.margin-controls{background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0;border:1px dashed #ccc;}
.margin-inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;}
.margin-input{display:flex;flex-direction:column;}
.margin-input label{font-size:12px;color:#666;margin-bottom:4px;}
.format-templates{background:#f0f7ff;padding:15px;border-radius:8px;margin:15px 0;border:1px solid #cce5ff;}
.template-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.prescription-format-container{background:white;padding:20px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,0.1);margin-bottom:20px;}
#formattingContainer{min-height:400px;padding:20px;border:1px solid #ddd;border-radius:8px;background:white;margin-top:15px;outline:none;overflow-y:auto;max-height:500px;position:relative;}
#formattingContainer font[size="1"]{font-size:8px !important;}
#formattingContainer font[size="2"]{font-size:10px !important;}
#formattingContainer font[size="3"]{font-size:12px !important;}
#formattingContainer font[size="4"]{font-size:14px !important;}
#formattingContainer font[size="5"]{font-size:18px !important;}
#formattingContainer font[size="6"]{font-size:24px !important;}
#formattingContainer font[size="7"]{font-size:36px !important;}
#formattingContainer font[size="8"]{font-size:48px !important;}
#formattingContainer font[size="9"]{font-size:60px !important;}
.instructions-section{margin:20px 0;padding:15px;background:#f9f9f9;border-radius:8px;border-left:4px solid var(--secondary);}
.additional-instructions{margin:30px 0;padding:20px;background:#fff8e1;border-radius:8px;border:2px dashed #ffd54f;}
.saved-prescriptions-section{background:#e8f5e9;padding:20px;border-radius:10px;margin-bottom:20px;border-left:4px solid var(--secondary);}
.saved-prescriptions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;margin-top:15px;}
.saved-prescription-card{background:white;padding:15px;border-radius:8px;border:1px solid #c8e6c9;transition:all 0.3s;}
.saved-prescription-card:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.saved-prescription-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.prescription-name{font-weight:bold;color:var(--primary);font-size:16px;}
.prescription-meds-list{margin-top:10px;padding-top:10px;border-top:1px dashed #eee;}
.prescription-med-item{padding:5px 0;font-size:13px;color:#555;display:flex;justify-content:space-between;}
.drug-interaction-alert{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#ffebee;border:2px solid #e57373;border-radius:10px;padding:20px;z-index:2000;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,0.3);animation:alertPop 0.3s;}
@keyframes alertPop{from{opacity:0;transform:translate(-50%,-60%);}to{opacity:1;transform:translate(-50%,-50%);}}
.drug-interaction-alert h4{color:#d32f2f;margin-bottom:10px;}
.drug-interaction-details{background:white;padding:10px;border-radius:5px;margin:10px 0;border-left:3px solid #f44336;}
.alert-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:15px;}
.prescriptions-select{margin-bottom:20px;padding:15px;background:#f0f7ff;border-radius:8px;}
.prescriptions-select select{width:100%;padding:10px;border:2px solid var(--primary);border-radius:8px;font-size:16px;}
.quick-color-buttons{display:flex;gap:5px;margin-left:10px;}
.quick-color-btn{width:24px;height:24px;border-radius:50%;border:2px solid white;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.2);}
.quick-color-btn:hover{transform:scale(1.1);}
.clinic-settings-btn{background:var(--accent);color:white;border:none;border-radius:8px;padding:8px 15px;cursor:pointer;font-weight:600;margin-right:10px;transition:all 0.3s;}
.clinic-settings-btn:hover{background:#e67e22;transform:translateY(-2px);}
.search-group{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px;}
.search-group .form-input{margin-bottom:0;}
.whatsapp-btn{background:#25D366;color:white;border:none;border-radius:8px;padding:12px 24px;cursor:pointer;font-weight:600;transition:all 0.3s;}
.whatsapp-btn:hover{background:#128C7E;transform:translateY(-2px);}
.format-btn-group{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap;}
.format-btn{padding:5px 10px;background:white;border:1px solid #ddd;border-radius:3px;cursor:pointer;font-size:14px;}
.format-btn:hover{background:#f5f5f5;}
.format-btn.active{background:var(--primary);color:white;border-color:var(--primary);}
.visit-details-modal{width:90%!important;max-width:1000px!important;max-height:90%!important;}
.medicine-type-select,.concentration-group,.volume-group,.dose-group,.maxdose-group,.form-grid-2,.form-grid-3,.form-grid-4{display:grid;grid-template-columns:2fr 1fr;gap:10px;}
.interaction-item{background:#f8f9fa;padding:10px;border-radius:5px;margin-bottom:5px;border:1px solid #ddd;}
.interaction-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
.interaction-item-details{font-size:12px;color:#666;}
.max-dose-alert{background:#fff3cd;border:1px solid #ffeaa7;border-radius:5px;padding:10px;margin-top:10px;}
.print-format-header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--primary);}
.print-format-footer{margin-top:30px;padding-top:15px;border-top:1px solid #ccc;text-align:center;font-size:12px;}
.medication-details-section{background:#f0f7ff;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #cce5ff;}
.dose-calculation-section{background:#f0fff4;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #c6f6d5;}
.interactions-section{background:#fff5f5;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #fed7d7;}
.age-dose-container{background:#fff8e1;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #ffd54f;}
.age-dose-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr 1fr 0.5fr;gap:8px;margin-bottom:10px;align-items:center;}
.age-dose-header{font-weight:bold;color:var(--primary);margin-bottom:10px;}
.add-age-dose-btn{background:var(--secondary);color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin-top:10px;}
.remove-age-dose-btn{background:var(--danger);color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;}
.text-editor-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:3000;width:90%;max-width:800px;max-height:90%;display:none;}
.text-editor-toolbar{background:#f5f5f5;padding:10px;border-bottom:1px solid #ddd;display:flex;gap:5px;flex-wrap:wrap;}
.text-editor-content{padding:20px;min-height:300px;outline:none;overflow-y:auto;}
.text-editor-actions{padding:15px;border-top:1px solid #ddd;text-align:left;}
.interaction-search-container{position:relative;}
.interaction-search-results{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:0 0 5px 5px;max-height:200px;overflow-y:auto;z-index:1000;display:none;}
.interaction-search-item{padding:10px;cursor:pointer;border-bottom:1px solid #eee;}
.interaction-search-item:hover{background:#f5f5f5;}
.medication-edit-list{max-height:400px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:10px;}
.medication-edit-item{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
.age-dose-frequency-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:5px;}
.appointment-date-selector{display:flex;align-items:center;justify-content:center;gap:20px;margin:20px 0;padding:15px;background:#f0f7ff;border-radius:10px;}
.appointment-date-selector button{padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer;}
.appointment-date-selector input{padding:10px;border:2px solid var(--primary);border-radius:8px;font-size:16px;}
.appointment-list{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.appointment-section{background:white;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.appointment-item{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid var(--accent);}
.appointment-item.completed{border-left-color:var(--secondary);}
.appointment-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.appointment-item-actions{display:flex;gap:5px;}
.appointment-type{background:var(--accent);color:white;padding:3px 8px;border-radius:4px;font-size:12px;}
.appointment-status{background:var(--primary);color:white;padding:3px 8px;border-radius:4px;font-size:12px;}
.appointment-status.completed{background:var(--secondary);}
.appointment-status.pending{background:var(--danger);}
.clinic-logo-options{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
.clinic-logo-option{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;border:2px solid transparent;transition:all 0.3s;}
.clinic-logo-option:hover{border-color:var(--primary);transform:scale(1.1);}
.clinic-logo-option.selected{border-color:var(--secondary);box-shadow:0 0 0 2px var(--secondary);}

/* --- تم تعديل تنسيق المحادثة في الأعلى --- */
.comm-modal{position:fixed;bottom:100px;left:30px;width:350px;height:500px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:1001;display:none;flex-direction:column;}
.comm-header{background:var(--primary);color:white;padding:15px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between;align-items:center;}
.comm-header h4{margin:0;}
.comm-close{font-size:24px;cursor:pointer;}
.comm-messages{flex:1;padding:15px;overflow-y:auto;background:#f8f9fa;}
.message{margin-bottom:15px;display:flex;flex-direction:column;}
.message.sender{align-items:flex-end;}
.message.receiver{align-items:flex-start;}
.message-content{max-width:80%;padding:10px 15px;border-radius:15px;word-wrap:break-word;}
.message.sender .message-content{background:var(--primary);color:white;}
.message.receiver .message-content{background:#e9ecef;color:black;}
.message-time{font-size:11px;color:var(--gray);margin-top:3px;}
.comm-input{display:flex;padding:15px;border-top:1px solid #ddd;}
.comm-input input{flex:1;padding:10px;border:1px solid #ddd;border-radius:20px;outline:none;}
.comm-input button{padding:10px 20px;margin-right:10px;background:var(--primary);color:white;border:none;border-radius:20px;cursor:pointer;}
#formattingContainer img.resizable{max-width:100%;cursor:move;position:relative;}
#formattingContainer img.resizable.selected{outline:2px dashed var(--primary);}
.resize-handle{position:absolute;width:8px;height:8px;background:var(--primary);border-radius:50%;}
.resize-handle.top-left{top:-4px;left:-4px;cursor:nw-resize;}
.resize-handle.top-right{top:-4px;right:-4px;cursor:ne-resize;}
.resize-handle.bottom-left{bottom:-4px;left:-4px;cursor:sw-resize;}
.resize-handle.bottom-right{bottom:-4px;right:-4px;cursor:se-resize;}
.rotate-handle{position:absolute;top:-25px;left:50%;transform:translateX(-50%);width:16px;height:16px;background:var(--accent);border-radius:50%;cursor:grab;}
@media (max-width:768px){.nav-menu,.search-group,.form-row,.appointment-list{grid-template-columns:1fr;flex-direction:column;}.modal-content{width:95%;padding:20px;}.age-inputs,.medicine-type-select,.concentration-group,.volume-group,.dose-group,.maxdose-group,.form-grid-2,.form-grid-3,.form-grid-4,.age-dose-row,.age-dose-frequency-row{grid-template-columns:1fr;}.visit-header{flex-direction:column;align-items:flex-start;gap:10px;}.format-toolbar{flex-direction:column;align-items:stretch;}.toolbar-group{justify-content:center;border-right:none!important;border-bottom:1px solid #ddd;padding-bottom:8px;margin-bottom:8px;}.toolbar-group:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}.saved-prescriptions-grid{grid-template-columns:1fr;}.comm-modal{width:90%;left:5%;bottom:20px;}}
</style>
</head>
<body>
<div class="system-container">
<div class="login-container" id="loginPage">
    <div class="clinic-header">
        <div class="clinic-logo-new" id="loginClinicLogo">
            <img src="https://cdn-icons-png.flaticon.com/512/3063/3063822.png" alt="Logo">
        </div>
        <h1 class="clinic-name" id="loginClinicName">NABED - نابض</h1>
        <div class="doctor-name" id="loginDoctorName">Pulse of Medical Clinics</div>
    </div>
    
    <div class="user-selector" id="userSelector">
        <div class="user-card" onclick="selectUser('doctor')" id="doctorCard">
            <div class="user-icon">👨‍⚕️</div>
            <div class="user-title">DOCTOR</div>
            <div class="user-desc">الدخول كطبيب رئيسي</div>
        </div>
        <div class="user-card" onclick="selectUser('secretary')" id="secretaryCard">
            <div class="user-icon">👨‍💼</div>
            <div class="user-title">SECRETARY</div>
            <div class="user-desc">الدخول كسكرتارية العيادة</div>
        </div>
    </div>

    <form class="login-form" id="loginForm" style="display:none;">
        <div class="form-group">
            <label class="form-label">كلمة المرور</label>
            <input type="password" class="form-input" id="password" required>
        </div>
        <button type="button" class="login-btn" onclick="handleLogin()">ENTER SYSTEM</button>
        <button type="button" class="login-btn" onclick="showUserSelector()" style="background:var(--gray);margin-top:10px;">رجوع</button>
    </form>
    
    <div style="background:rgba(255,255,255,0.1); border-radius:10px; padding:15px; margin-top:20px; text-align:center; color:white; font-weight:300; font-size:12px; letter-spacing:1px;">
        🏥 NABED MEDICAL MANAGEMENT SYSTEM IS READY
    </div>
</div>

<div class="dashboard" id="dashboard">
<div class="header">
<h2 id="dashboardClinicName">Nabed - نابض - نظام إدارة العيادة</h2>
<div><span id="currentUser">دكتور محمد خطاب</span><button class="clinic-settings-btn" onclick="showClinicSettings()">⚙️ تعديل بيانات العيادة</button><button class="login-btn" onclick="logout()" style="margin-right:15px;padding:8px 15px;">تسجيل الخروج</button></div>
</div>
<div class="nav-menu">
<button class="nav-btn active" onclick="showSection('patients')">👥 إدارة المرضى</button>
<button class="nav-btn" onclick="showSection('appointments')">📅 الحجوزات</button>
<button class="nav-btn" onclick="showSection('medications')">💊 بنك الأدوية</button>
<button class="nav-btn" onclick="showSection('reports')">📊 التقارير</button>
</div>
<div class="content-area" id="contentArea">
<div id="patientsSection">
<div class="form-container">
<h3 class="form-title">كشف جديد</h3>
<div class="search-group">
<div class="autocomplete">
<label class="form-label">اسم المريض</label>
<input type="text" class="form-input" id="patientSearch" placeholder="اكتب اسم المريض..." autocomplete="off">
<div class="autocomplete-items" id="patientSearchResults" style="display:none;"></div>
</div>
<div class="autocomplete">
<label class="form-label">رقم الملف</label>
<input type="text" class="form-input" id="fileNumberSearch" placeholder="ابحث برقم الملف..." autocomplete="off">
<div class="autocomplete-items" id="fileNumberSearchResults" style="display:none;"></div>
</div>
<div class="autocomplete">
<label class="form-label">رقم الهاتف</label>
<input type="text" class="form-input" id="phoneSearch" placeholder="ابحث برقم الهاتف..." autocomplete="off">
<div class="autocomplete-items" id="phoneSearchResults" style="display:none;"></div>
</div>
</div>
<div style="font-size:12px;color:var(--gray);margin-top:5px;">ابدأ بالكتابة في أي خانة للبحث عن مريض موجود</div>
<button class="login-btn" onclick="startNewVisit()" style="margin-top:15px;">كشف جديد</button>
</div>
<div class="form-container">
<h3 class="form-title">قائمة المرضى</h3>
<div class="search-group">
<input type="text" class="form-input" id="searchPatient" placeholder="ابحث باسم المريض..." onkeyup="searchPatients()">
<input type="text" class="form-input" id="searchFileNumber" placeholder="ابحث برقم الملف..." onkeyup="searchPatients()">
<input type="text" class="form-input" id="searchPhone" placeholder="ابحث برقم الهاتف..." onkeyup="searchPatients()">
</div>
<table class="data-table" id="patientsTable">
<thead><tr><th>رقم الملف</th><th>اسم المريض</th><th>العمر</th><th>الوزن</th><th>الهاتف</th><th>الإجراءات</th></tr></thead>
<tbody id="patientsList"></tbody>
</table>
</div>
</div>
<div id="appointmentsSection" style="display:none;">
<div class="form-container">
<h3 class="form-title">نظام الحجوزات</h3>
<div class="appointment-date-selector">
<button onclick="changeAppointmentDate(-1)">⬅️ يوم سابق</button>
<input type="date" id="appointmentDate" value="" onchange="loadAppointments()">
<button onclick="changeAppointmentDate(1)">يوم تالي ➡️</button>
</div>
<button class="login-btn" onclick="showAddAppointmentModal()" style="width:100%;margin-bottom:20px;">➕ إضافة حجز جديد</button>
<div class="appointment-list">
<div class="appointment-section">
<h4 class="form-title">✅ الحجوزات الفعلية</h4>
<div id="confirmedAppointmentsList"></div>
</div>
<div class="appointment-section">
<h4 class="form-title">⏳ الحجوزات المحتملة</h4>
<div id="pendingAppointmentsList"></div>
</div>
</div>
</div>
</div>
<div id="medicationsSection" style="display:none;">
<div class="form-container">
<h3 class="form-title">إدارة الأدوية</h3>
<div class="form-row">
<button class="login-btn" onclick="showAddMedicationModal()">إضافة دواء جديد</button>
<button class="login-btn" onclick="showEditMedicationModal()" style="background:var(--accent);">تعديل الأدوية</button>
</div>
</div>
<div class="saved-prescriptions-section">
<h3 class="form-title">📋 الروشتات المحفوظة</h3>
<button class="login-btn" onclick="showAddPrescriptionModal()" style="background:var(--secondary);margin-bottom:15px;">➕ إضافة روشتة محفوظة</button>
<div class="saved-prescriptions-grid" id="savedPrescriptionsGrid"></div>
</div>
<div class="form-container">
<h3 class="form-title">قائمة الأدوية</h3>
<table class="data-table">
<thead><tr><th>اسم الدواء</th><th>النوع</th><th>التركيز</th><th>الجرعة/كجم</th><th>التكرار</th><th>الإجراءات</th></tr></thead>
<tbody id="medicationsList"></tbody>
</table>
</div>
</div>
<div id="reportsSection" style="display:none;">
<div class="form-container">
<h3 class="form-title">التقارير والإحصائيات</h3>
<div class="form-row">
<div class="form-container" style="text-align:center;">
<h4 style="color:var(--primary);">إجمالي المرضى</h4>
<div style="font-size:48px;color:var(--secondary);font-weight:bold;" id="totalPatients">0</div>
</div>
<div class="form-container" style="text-align:center;">
<h4 style="color:var(--primary);">الزيارات اليوم</h4>
<div style="font-size:48px;color:var(--accent);font-weight:bold;" id="todayVisits">0</div>
</div>
<div class="form-container" style="text-align:center;">
<h4 style="color:var(--primary);">إجمالي الأدوية</h4>
<div style="font-size:48px;color:var(--primary);font-weight:bold;" id="totalMedications">0</div>
</div>
</div>
<div id="reportsContent">
<div class="form-row">
<button class="nav-btn" onclick="showReportType('daily')">📅 تقارير يومية</button>
<button class="nav-btn" onclick="showReportType('weekly')">📆 تقارير أسبوعية</button>
<button class="nav-btn" onclick="showReportType('monthly')">📅 تقارير شهرية</button>
</div>
<div id="dailyReport" class="form-container" style="display:none;">
<h4>التقارير اليومية</h4>
<div id="dailyReportContent"></div>
<div class="form-group">
<label class="form-label">اختر يوم معين</label>
<input type="date" class="form-input" id="specificDay" onchange="generateDailyReport()">
</div>
</div>
<div id="weeklyReport" class="form-container" style="display:none;">
<h4>التقارير الأسبوعية</h4>
<div id="weeklyReportContent"></div>
<div class="form-group">
<label class="form-label">اختر أسبوع معين</label>
<input type="week" class="form-input" id="specificWeek" onchange="generateWeeklyReport()">
</div>
</div>
<div id="monthlyReport" class="form-container" style="display:none;">
<h4>التقارير الشهرية</h4>
<div id="monthlyReportContent"></div>
<div class="form-group">
<label class="form-label">اختر شهر معين</label>
<input type="month" class="form-input" id="specificMonth" onchange="generateMonthlyReport()">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="modal" id="patientRecordModal">
<div class="modal-content" style="width:90%;max-width:1000px;">
<span class="close-btn" onclick="closeModal('patientRecordModal')">&times;</span>
<h3 class="form-title">السجل المرضي</h3>
<div id="patientRecordContent"></div>
</div>
</div>
<div class="modal" id="visitModal">
<div class="modal-content" style="width:95%;max-width:1200px;max-height:95%;">
<span class="close-btn" onclick="closeVisitModal()">&times;</span>
<div id="visitContent"></div>
</div>
</div>
<div class="modal" id="addMedicationModal">
<div class="modal-content" style="width:95%;max-width:900px;">
<span class="close-btn" onclick="closeModal('addMedicationModal')">&times;</span>
<h3 class="form-title">إضافة دواء جديد</h3>
<div class="medication-details-section">
<h4>تفاصيل الدواء</h4>
<div class="form-row">
<div class="form-group">
<label class="form-label">اسم الدواء التجاري</label>
<input type="text" class="form-input" id="newMedName" placeholder="أدخل اسم الدواء">
</div>
<div class="form-group">
<label class="form-label">نوع الدواء</label>
<select class="form-input" id="newMedType" onchange="updateMedicineFields()">
<option value="">اختر نوع الدواء</option>
<option value="Syrup">Syrup (شراب)</option>
<option value="Suspension">Suspension (معلق)</option>
<option value="Ampule">Ampule (أمبولة)</option>
<option value="Vial">Vial (قارورة)</option>
<option value="Tab">Tab (قرص)</option>
<option value="Cap">Cap (كبسولة)</option>
<option value="Sachets">Sachets (كيس)</option>
<option value="Oral Film">Oral Film (لزقة في الفم)</option>
<option value="Supp">Supp (لبوس)</option>
<option value="cream">cream (كريم)</option>
<option value="ointment">ointment (مرهم)</option>
<option value="lotion">lotion (لوشن)</option>
<option value="Iv Fluid">Iv Fluid (محلول وريدي)</option>
<option value="Other">Other (أخرى)</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">تركيز الدواء</label>
<div class="concentration-group">
<input type="number" class="form-input" id="newMedConcentration" placeholder="التركيز" step="0.1" min="0">
<select class="form-input" id="newMedConcentrationUnit">
<option value="mcg">ميكروجرام (mcg)</option>
<option value="mg">ملليجرام (mg)</option>
<option value="g">جرام (g)</option>
<option value="I.U">وحدة دولية (I.U)</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">حجم الدواء المحتوي على التركيز</label>
<div class="volume-group">
<input type="number" class="form-input" id="newMedVolume" placeholder="الحجم" step="0.1" min="0" value="1">
<select class="form-input" id="newMedVolumeUnit" onchange="updateVolumeField()">
<option value="ml">مل (ml)</option>
<option value="drops">نقطة (drops)</option>
<option value="tab">قرص (tab)</option>
<option value="cap">كبسولة (cap)</option>
<option value="supp">لبوسة (supp)</option>
<option value="gram">جرام (gram)</option>
<option value="sachet">كيس (sachet)</option>
<option value="oral film">لزقة في الفم (oral film)</option>
</select>
</div>
<div style="font-size:12px;color:var(--gray);margin-top:5px;" id="volumeHelperText">سيتم حساب الجرعة بناءً على هذا الحجم</div>
</div>
</div>
<div class="form-group">
<label class="form-label">الاسم العلمي للمادة الفعالة</label>
<input type="text" class="form-input" id="newMedScientificName" placeholder="المادة الفعالة">
</div>
</div>
<div class="dose-calculation-section">
<h4>حساب جرعة الدواء</h4>
<div class="form-row">
<div class="form-group">
<label class="form-label">نوع حساب الجرعة</label>
<select class="form-input" id="doseCalculationType" onchange="toggleDoseCalculationType()">
<option value="weight">حسب الوزن (كجم)</option>
<option value="age">حسب العمر</option>
</select>
</div>
</div>
<div id="weightDoseSection">
<div class="form-row">
<div class="form-group">
<label class="form-label" id="doseLabel">جرعة الدواء لكل كيلو من وزن الطفل</label>
<div class="dose-group" id="doseInputGroup">
<input type="number" class="form-input" id="newMedDose" placeholder="الجرعة" step="0.1" min="0">
<select class="form-input" id="newMedDoseUnit">
<option value="mcg">ميكروجرام (mcg)</option>
<option value="mg">ملليجرام (mg)</option>
<option value="g">جرام (g)</option>
<option value="ml">مل (ml)</option>
<option value="oral film">لزقة في الفم</option>
<option value="sachet">كيس</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">التكرار</label>
<select class="form-input" id="newMedFrequency">
<option value="">اختر التكرار</option>
<option value="عند اللزوم">عند اللزوم</option>
<option value="مرة واحدة فقط">مرة واحدة فقط</option>
<option value="كل 2 ساعة">كل 2 ساعة</option>
<option value="كل 3 ساعات">كل 3 ساعات</option>
<option value="كل 4 ساعات">كل 4 ساعات</option>
<option value="كل 6 ساعات">كل 6 ساعات</option>
<option value="كل 8 ساعات">كل 8 ساعات</option>
<option value="كل 12 ساعة">كل 12 ساعة</option>
<option value="كل 24 ساعة">كل 24 ساعة</option>
<option value="كل 48 ساعة">كل 48 ساعة</option>
<option value="كل 3 أيام">كل 3 أيام</option>
<option value="كل أسبوع">كل أسبوع</option>
<option value="كل شهر">كل شهر</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">المدة</label>
<select class="form-input" id="newMedDuration">
<option value="">اختر المدة</option>
<option value="لمدة يوم واحد">لمدة يوم واحد</option>
<option value="لمدة يومين">لمدة يومين</option>
<option value="لمدة 3 أيام">لمدة 3 أيام</option>
<option value="لمدة 4 أيام">لمدة 4 أيام</option>
<option value="لمدة 5 أيام">لمدة 5 أيام</option>
<option value="لمدة 6 أيام">لمدة 6 أيام</option>
<option value="لمدة اسبوع">لمدة اسبوع</option>
<option value="لمدة 10 أيام">لمدة 10 أيام</option>
<option value="لمدة اسبوعين">لمدة اسبوعين</option>
<option value="لمدة شهر">لمدة شهر</option>
<option value="لمدة شهرين">لمدة شهرين</option>
<option value="لمدة 3 شهور">لمدة 3 شهور</option>
<option value="باستمرار">باستمرار</option>
</select>
</div>
<div class="form-group">
<label class="form-label">ملاحظات الجرعة</label>
<input type="text" class="form-input" id="newMedDoseNotes" placeholder="ملاحظات حول الجرعة">
</div>
</div>
</div>
<div id="ageDoseSection" style="display:none;">
<div class="age-dose-container">
<div class="age-dose-header">جرعة الدواء حسب العمر</div>
<div id="ageDoseRows">
<div class="age-dose-row">
<div><label style="font-size:12px;">من عمر (سنوات)</label><input type="number" class="form-input" placeholder="0" min="0" max="70" step="1" style="padding:6px;"></div>
<div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="0" min="0" max="11" step="1" style="padding:6px;"></div>
<div><label style="font-size:12px;">إلى عمر (سنوات)</label><input type="number" class="form-input" placeholder="70" min="0" max="70" step="1" style="padding:6px;"></div>
<div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="11" min="0" max="11" step="1" style="padding:6px;"></div>
<div><label style="font-size:12px;">الجرعة</label><input type="number" class="form-input" placeholder="الجرعة" step="0.1" min="0" style="padding:6px;"></div>
<div><label style="font-size:12px;">تمييز الجرعة</label>
<select class="form-input" style="padding:6px;">
<option value="ml">مل (ml)</option>
<option value="drops">نقطة (drops)</option>
<option value="tab">قرص (tab)</option>
<option value="cap">كبسولة (cap)</option>
<option value="supp">لبوسة (supp)</option>
<option value="gram">جرام (gram)</option>
<option value="sachet">كيس (sachet)</option>
<option value="oral film">لزقة في الفم (oral film)</option>
</select>
</div>
<div><label style="font-size:12px;">التكرار</label>
<select class="form-input" style="padding:6px;">
<option value="">اختر</option>
<option value="كل 6 ساعات">كل 6 ساعات</option>
<option value="كل 8 ساعات">كل 8 ساعات</option>
<option value="كل 12 ساعة">كل 12 ساعة</option>
<option value="كل 24 ساعة">كل 24 ساعة</option>
</select>
</div>
<div><label style="font-size:12px;">المدة</label>
<select class="form-input" style="padding:6px;">
<option value="">اختر</option>
<option value="لمدة 3 أيام">لمدة 3 أيام</option>
<option value="لمدة 5 أيام">لمدة 5 أيام</option>
<option value="لمدة اسبوع">لمدة اسبوع</option>
<option value="لمدة 10 أيام">لمدة 10 أيام</option>
</select>
</div>
<div><label style="font-size:12px;visibility:hidden;">إزالة</label><button type="button" class="remove-age-dose-btn" onclick="removeAgeDoseRow(this)">-</button></div>
</div>
</div>
<button type="button" class="add-age-dose-btn" onclick="addAgeDoseRow()">+ إضافة فئة عمرية</button>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">الجرعة القصوى (الحد الأقصى للجرعة الواحدة)</label>
<div class="maxdose-group">
<input type="number" class="form-input" id="newMedMaxDose" placeholder="الحد الأقصى" step="0.1" min="0">
<select class="form-input" id="newMedMaxDoseUnit">
<option value="ml">مل (ml)</option>
<option value="drops">نقطة (drops)</option>
<option value="tab">قرص (tab)</option>
<option value="cap">كبسولة (cap)</option>
<option value="supp">لبوسة (supp)</option>
<option value="gram">جرام (gram)</option>
<option value="sachet">كيس (sachet)</option>
<option value="oral film">لزقة في الفم (oral film)</option>
</select>
</div>
<div style="font-size:12px;color:var(--gray);margin-top:5px;">سيتم تنبيهك إذا تجاوزت الجرعة المحسوبة هذا الرقم</div>
</div>
</div>
</div>
<div class="interactions-section">
<h4>التداخلات الدوائية</h4>
<div class="form-row">
<div class="form-group interaction-search-container">
<label class="form-label">اختر دواء للتداخل</label>
<input type="text" class="form-input" id="interactionSearch" placeholder="ابحث عن دواء..." autocomplete="off">
<div class="interaction-search-results" id="interactionSearchResults"></div>
</div>
<div class="form-group">
<label class="form-label">سبب التداخل</label>
<input type="text" class="form-input" id="interactionReason" placeholder="سبب التداخل">
</div>
</div>
<button type="button" class="action-btn" onclick="addDrugInteraction()" style="background:var(--primary);color:white;margin-bottom:15px;">⚠️ إضافة تداخل</button>
<div id="interactionsList"></div>
</div>
<button class="login-btn" onclick="addNewMedication()" style="width:100%;">💊 حفظ الدواء</button>
</div>
</div>
<div class="modal" id="editMedicationModal">
<div class="modal-content" style="width:90%;max-width:800px;">
<span class="close-btn" onclick="closeModal('editMedicationModal')">&times;</span>
<h3 class="form-title">تعديل الأدوية</h3>
<div class="form-group">
<label class="form-label">ابحث عن الدواء</label>
<input type="text" class="form-input" id="searchMedication" placeholder="اكتب اسم الدواء..." onkeyup="searchMedicationsEdit()">
</div>
<div class="medication-edit-list" id="medicationEditList"></div>
</div>
</div>
<div class="modal" id="editSingleMedModal">
<div class="modal-content" style="width:95%;max-width:900px;">
<span class="close-btn" onclick="closeModal('editSingleMedModal')">&times;</span>
<h3 class="form-title">تعديل الدواء</h3>
<div class="medication-details-section">
<h4>تفاصيل الدواء</h4>
<div class="form-row">
<div class="form-group">
<label class="form-label">اسم الدواء التجاري</label>
<input type="text" class="form-input" id="editMedName">
</div>
<div class="form-group">
<label class="form-label">نوع الدواء</label>
<select class="form-input" id="editMedType" onchange="updateEditMedicineFields()">
<option value="">اختر نوع الدواء</option>
<option value="Syrup">Syrup (شراب)</option>
<option value="Suspension">Suspension (معلق)</option>
<option value="Ampule">Ampule (أمبولة)</option>
<option value="Vial">Vial (قارورة)</option>
<option value="Tab">Tab (قرص)</option>
<option value="Cap">Cap (كبسولة)</option>
<option value="Sachets">Sachets (كيس)</option>
<option value="Oral Film">Oral Film (لزقة في الفم)</option>
<option value="Supp">Supp (لبوس)</option>
<option value="cream">cream (كريم)</option>
<option value="ointment">ointment (مرهم)</option>
<option value="lotion">lotion (لوشن)</option>
<option value="Iv Fluid">Iv Fluid (محلول وريدي)</option>
<option value="Other">Other (أخرى)</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">تركيز الدواء</label>
<div class="concentration-group">
<input type="number" class="form-input" id="editMedConcentration" step="0.1" min="0">
<select class="form-input" id="editMedConcentrationUnit">
<option value="mcg">ميكروجرام (mcg)</option>
<option value="mg">ملليجرام (mg)</option>
<option value="g">جرام (g)</option>
<option value="I.U">وحدة دولية (I.U)</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">حجم الدواء المحتوي على التركيز</label>
<div class="volume-group">
<input type="number" class="form-input" id="editMedVolume" step="0.1" min="0" value="1">
<select class="form-input" id="editMedVolumeUnit" onchange="updateEditVolumeField()">
<option value="ml">مل (ml)</option>
<option value="drops">نقطة (drops)</option>
<option value="tab">قرص (tab)</option>
<option value="cap">كبسولة (cap)</option>
<option value="supp">لبوسة (supp)</option>
<option value="gram">جرام (gram)</option>
<option value="sachet">كيس (sachet)</option>
<option value="oral film">لزقة في الفم (oral film)</option>
</select>
</div>
</div>
</div>
<div class="form-group">
<label class="form-label">الاسم العلمي للمادة الفعالة</label>
<input type="text" class="form-input" id="editMedScientificName">
</div>
</div>
<div class="dose-calculation-section">
<h4>حساب جرعة الدواء</h4>
<div class="form-row">
<div class="form-group">
<label class="form-label">نوع حساب الجرعة</label>
<select class="form-input" id="editDoseCalculationType" onchange="toggleEditDoseCalculationType()">
<option value="weight">حسب الوزن (كجم)</option>
<option value="age">حسب العمر</option>
</select>
</div>
</div>
<div id="editWeightDoseSection">
<div class="form-row">
<div class="form-group">
<label class="form-label" id="editDoseLabel">جرعة الدواء لكل كيلو من وزن الطفل</label>
<div class="dose-group" id="editDoseInputGroup">
<input type="number" class="form-input" id="editMedDose" step="0.1" min="0">
<select class="form-input" id="editMedDoseUnit">
<option value="mcg">ميكروجرام (mcg)</option>
<option value="mg">ملليجرام (mg)</option>
<option value="g">جرام (g)</option>
<option value="ml">مل (ml)</option>
<option value="oral film">لزقة في الفم</option>
<option value="sachet">كيس</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">التكرار</label>
<select class="form-input" id="editMedFrequency">
<option value="">اختر التكرار</option>
<option value="عند اللزوم">عند اللزوم</option>
<option value="مرة واحدة فقط">مرة واحدة فقط</option>
<option value="كل 2 ساعة">كل 2 ساعة</option>
<option value="كل 3 ساعات">كل 3 ساعات</option>
<option value="كل 4 ساعات">كل 4 ساعات</option>
<option value="كل 6 ساعات">كل 6 ساعات</option>
<option value="كل 8 ساعات">كل 8 ساعات</option>
<option value="كل 12 ساعة">كل 12 ساعة</option>
<option value="كل 24 ساعة">كل 24 ساعة</option>
<option value="كل 48 ساعة">كل 48 ساعة</option>
<option value="كل 3 أيام">كل 3 أيام</option>
<option value="كل أسبوع">كل أسبوع</option>
<option value="كل شهر">كل شهر</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">المدة</label>
<select class="form-input" id="editMedDuration">
<option value="">اختر المدة</option>
<option value="لمدة يوم واحد">لمدة يوم واحد</option>
<option value="لمدة يومين">لمدة يومين</option>
<option value="لمدة 3 أيام">لمدة 3 أيام</option>
<option value="لمدة 4 أيام">لمدة 4 أيام</option>
<option value="لمدة 5 أيام">لمدة 5 أيام</option>
<option value="لمدة 6 أيام">لمدة 6 أيام</option>
<option value="لمدة اسبوع">لمدة اسبوع</option>
<option value="لمدة 10 أيام">لمدة 10 أيام</option>
<option value="لمدة اسبوعين">لمدة اسبوعين</option>
<option value="لمدة شهر">لمدة شهر</option>
<option value="لمدة شهرين">لمدة شهرين</option>
<option value="لمدة 3 شهور">لمدة 3 شهور</option>
<option value="باستمرار">باستمرار</option>
</select>
</div>
<div class="form-group">
<label class="form-label">ملاحظات الجرعة</label>
<input type="text" class="form-input" id="editMedDoseNotes" placeholder="ملاحظات حول الجرعة">
</div>
</div>
</div>
<div id="editAgeDoseSection" style="display:none;">
<div class="age-dose-container">
<div class="age-dose-header">جرعة الدواء حسب العمر</div>
<div id="editAgeDoseRows"></div>
<button type="button" class="add-age-dose-btn" onclick="addEditAgeDoseRow()">+ إضافة فئة عمرية</button>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">الجرعة القصوى (الحد الأقصى للجرعة الواحدة)</label>
<div class="maxdose-group">
<input type="number" class="form-input" id="editMedMaxDose" step="0.1" min="0">
<select class="form-input" id="editMedMaxDoseUnit">
<option value="ml">مل (ml)</option>
<option value="drops">نقطة (drops)</option>
<option value="tab">قرص (tab)</option>
<option value="cap">كبسولة (cap)</option>
<option value="supp">لبوسة (supp)</option>
<option value="gram">جرام (gram)</option>
<option value="sachet">كيس (sachet)</option>
<option value="oral film">لزقة في الفم (oral film)</option>
</select>
</div>
</div>
</div>
</div>
<div class="interactions-section">
<h4>التداخلات الدوائية</h4>
<div class="form-row">
<div class="form-group interaction-search-container">
<label class="form-label">اختر دواء للتداخل</label>
<input type="text" class="form-input" id="editInteractionSearch" placeholder="ابحث عن دواء..." autocomplete="off">
<div class="interaction-search-results" id="editInteractionSearchResults"></div>
</div>
<div class="form-group">
<label class="form-label">سبب التداخل</label>
<input type="text" class="form-input" id="editInteractionReason" placeholder="سبب التداخل">
</div>
</div>
<button type="button" class="action-btn" onclick="addEditDrugInteraction()" style="background:var(--primary);color:white;margin-bottom:15px;">⚠️ إضافة تداخل</button>
<div id="editInteractionsList"></div>
</div>
<button class="login-btn" onclick="updateMedication()" style="width:100%;">💊 تحديث الدواء</button>
</div>
</div>
<div class="modal" id="addPrescriptionModal">
<div class="modal-content" style="width:95%;max-width:900px;">
<span class="close-btn" onclick="closeModal('addPrescriptionModal')">&times;</span>
<h3 class="form-title">إضافة روشتة محفوظة</h3>
<div class="form-group">
<label class="form-label">اسم الروشتة</label>
<input type="text" class="form-input" id="prescriptionName" placeholder="مثال: روشتة نزلات البرد - روشتة المغص">
</div>
<div class="form-group">
<label class="form-label">اختر الأدوية للروشتة</label>
<div style="max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:15px;">
<div id="availableMedicationsList"></div>
</div>
</div>
<div class="form-group">
<label class="form-label">الأدوية المختارة</label>
<div id="selectedMedicationsList" style="background:#f8f9fa;padding:15px;border-radius:8px;min-height:100px;">
<p style="color:#666;text-align:center;">لم يتم اختيار أي أدوية بعد</p>
</div>
</div>
<button class="login-btn" onclick="savePrescriptionTemplate()" style="background:var(--secondary);">حفظ الروشتة</button>
</div>
</div>
<div class="modal" id="editPrescriptionModal">
<div class="modal-content" style="width:95%;max-width:900px;">
<span class="close-btn" onclick="closeModal('editPrescriptionModal')">&times;</span>
<h3 class="form-title">تعديل الروشتة المحفوظة</h3>
<div class="form-group">
<label class="form-label">اسم الروشتة</label>
<input type="text" class="form-input" id="editPrescriptionName">
</div>
<div class="form-group">
<label class="form-label">اختر الأدوية للروشتة</label>
<div style="max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:15px;">
<div id="editAvailableMedicationsList"></div>
</div>
</div>
<div class="form-group">
<label class="form-label">الأدوية المختارة</label>
<div id="editSelectedMedicationsList" style="background:#f8f9fa;padding:15px;border-radius:8px;min-height:100px;"></div>
</div>
<button class="login-btn" onclick="updatePrescriptionTemplate()" style="background:var(--secondary);">تحديث الروشتة</button>
<button class="login-btn" onclick="deletePrescriptionTemplate()" style="background:var(--danger);margin-right:10px;">حذف الروشتة</button>
</div>
</div>
<div class="modal" id="prescriptionModal">
<div class="modal-content" style="width:95%;max-width:1000px;">
<span class="close-btn" onclick="closeModal('prescriptionModal')">&times;</span>
<div id="prescriptionContent"></div>
</div>
</div>
<div class="modal" id="clinicSettingsModal">
<div class="modal-content" style="width:95%;max-width:600px;">
<span class="close-btn" onclick="closeModal('clinicSettingsModal')">&times;</span>
<h3 class="form-title">⚙️ تعديل بيانات العيادة</h3>
<div class="form-container">
<h4>بيانات العيادة</h4>
<div class="form-group">
<label class="form-label">اسم العيادة</label>
<input type="text" class="form-input" id="clinicNameInput" value="Nabed - نابض">
</div>
<div class="form-group">
<label class="form-label">اسم الدكتور</label>
<input type="text" class="form-input" id="doctorNameInput" value="Pulse of Medical Clinics">
</div>
<div class="form-group">
<label class="form-label">شعار العيادة</label>
<div style="display:flex;align-items:center;gap:15px;">
<div id="currentClinicLogo" style="width:80px;height:80px;background:linear-gradient(135deg,var(--primary)0%,#1B4F72 100%);border-radius:20px;display:flex;align-items:center;justify-content:center;color:white;font-size:40px;cursor:pointer;" onclick="document.getElementById('logoUpload').click()">👨‍⚕️</div>
<input type="file" id="logoUpload" accept="image/*" style="display:none;" onchange="uploadClinicLogo(this)">
<button type="button" class="action-btn" onclick="openLogoSelection()">اختيار رمز</button>
</div>
<div class="clinic-logo-options" id="logoOptions" style="display:none;">
<div class="clinic-logo-option" onclick="selectClinicLogo('👨‍⚕️')">👨‍⚕️</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('🏥')">🏥</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('❤️')">❤️</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('⚕️')">⚕️</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('🩺')">🩺</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('💊')">💊</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('🩸')">🩸</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('🏩')">🏩</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('👩‍⚕️')">👩‍⚕️</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('🧑‍⚕️')">🧑‍⚕️</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('🤖')">🤖</div>
<div class="clinic-logo-option" onclick="selectClinicLogo('💡')">💡</div>
</div>
</div>
<button class="login-btn" onclick="saveClinicSettings()" style="margin-top:15px;width:100%;">💾 حفظ بيانات العيادة</button>
</div>
<div class="form-container" style="margin-top:20px;">
<h4>تغيير بيانات تسجيل الدخول</h4>
<div class="form-group">
<label class="form-label">اسم المستخدم الجديد</label>
<input type="text" class="form-input" id="newUsername" placeholder="أدخل اسم المستخدم الجديد">
</div>
<div class="form-group">
<label class="form-label">كلمة المرور الجديدة</label>
<input type="password" class="form-input" id="newPassword" placeholder="أدخل كلمة المرور الجديدة">
</div>
<div class="form-group">
<label class="form-label">تأكيد كلمة المرور</label>
<input type="password" class="form-input" id="confirmPassword" placeholder="أعد إدخال كلمة المرور">
</div>
<button class="login-btn" onclick="changeLoginCredentials()" style="background:var(--secondary);">🔐 تغيير بيانات الدخول</button>
</div>
<div class="form-container" style="margin-top:20px;">
<h4>إعدادات السكرتير</h4>
<div class="form-group">
<label class="form-label">اسم مستخدم السكرتير</label>
<input type="text" class="form-input" id="secretaryUsername" value="secretary">
</div>
<div class="form-group">
<label class="form-label">كلمة مرور السكرتير</label>
<input type="password" class="form-input" id="secretaryPassword" value="mohamed2010">
</div>
<div class="form-group">
<label class="form-label">صلاحيات السكرتير</label>
<div style="padding:15px;background:#f8f9fa;border-radius:8px;">
<div><label><input type="checkbox" id="permPatients" checked> إدارة المرضى</label></div>
<div><label><input type="checkbox" id="permAppointments" checked> الحجوزات</label></div>
<div><label><input type="checkbox" id="permMedications"> بنك الأدوية</label></div>
<div><label><input type="checkbox" id="permReports"> التقارير</label></div>
</div>
</div>
<button class="login-btn" onclick="saveSecretarySettings()" style="background:var(--accent);">👨‍💼 حفظ إعدادات السكرتير</button>
</div>
</div>
</div>
<div class="modal" id="formatPrescriptionModal">
<div class="modal-content" style="width:95%;max-width:1200px;max-height:95%;">
<span class="close-btn" onclick="closeModal('formatPrescriptionModal')">&times;</span>
<h3 class="form-title">تنسيق الطباعة - الروشتة الطبية</h3>
<div class="format-templates">
<h4>التنسيقات المحفوظة</h4>
<div class="template-controls">
<select class="form-input" id="savedFormats" style="width:200px;" onchange="loadFormatTemplate()">
<option value="">اختر تنسيق محفوظ</option>
</select>
<input type="text" id="newFormatName" class="form-input" placeholder="اسم التنسيق الجديد" style="width:150px;">
<button class="action-btn" onclick="saveCurrentFormat()" style="background:var(--secondary);color:white;">💾 حفظ التنسيق</button>
<button class="action-btn" onclick="deleteFormat()" style="background:var(--danger);color:white;">🗑️ حذف التنسيق</button>
<button class="action-btn" onclick="setAsDefaultFormat()" style="background:var(--accent);color:white;">⭐ تعيين كافتراضي</button>
<button class="action-btn" onclick="restoreSystemDefaultFormat()" style="background:var(--primary);color:white;">🔄 استعادة تنسيق النظام</button>
</div>
</div>
<div class="format-toolbar" id="formatToolbar">
<div class="toolbar-group">
<select id="fontFamily" onchange="applyFormat('fontFamily', this.value)">
<option value="Cairo">Cairo</option>
<option value="Arial">Arial</option>
<option value="Times New Roman">Times New Roman</option>
<option value="Tahoma">Tahoma</option>
<option value="Georgia">Georgia</option>
</select>
</div>
<div class="toolbar-group">
<select id="fontSize" onchange="applyFormat('fontSize', this.value)">
<option value="1">8px</option>
<option value="2">10px</option>
<option value="3">12px</option>
<option value="4">14px</option>
<option value="5" selected>70px</option>
<option value="6">24px</option>
<option value="7">36px</option>
<option value="8">48px</option>
<option value="9">60px</option>
</select>
</div>
<div class="toolbar-group">
<button id="boldBtn" onclick="toggleBold()" title="عريض"><strong>B</strong></button>
<button id="italicBtn" onclick="toggleItalic()" title="مائل"><em>I</em></button>
<button id="underlineBtn" onclick="toggleUnderline()" title="تحته خط"><u>U</u></button>
</div>
<div class="toolbar-group">
<button onclick="applyFormat('justifyLeft')" title="محاذاة لليسار">⬅️</button>
<button onclick="applyFormat('justifyCenter')" title="محاذاة للوسط">🔘</button>
<button onclick="applyFormat('justifyRight')" title="محاذاة لليمين">➡️</button>
</div>
<div class="toolbar-group">
<input type="color" id="fontColor" value="#000000" onchange="applyFormat('foreColor', this.value)" title="لون الخط">
<div class="quick-color-buttons">
<div class="quick-color-btn" style="background:#000000;" onclick="setQuickColor('#000000')" title="أسود"></div>
<div class="quick-color-btn" style="background:#FF0000;" onclick="setQuickColor('#FF0000')" title="أحمر"></div>
<div class="quick-color-btn" style="background:#0000FF;" onclick="setQuickColor('#0000FF')" title="أزرق"></div>
<div class="quick-color-btn" style="background:#008000;" onclick="setQuickColor('#008000')" title="أخضر"></div>
<div class="quick-color-btn" style="background:#800080;" onclick="setQuickColor('#800080')" title="بنفسجي"></div>
<div class="quick-color-btn" style="background:#FFA500;" onclick="setQuickColor('#FFA500')" title="برتقالي"></div>
<div class="quick-color-btn" style="background:#A52A2A;" onclick="setQuickColor('#A52A2A')" title="بني"></div>
<div class="quick-color-btn" style="background:#FF00FF;" onclick="setQuickColor('#FF00FF')" title="وردي"></div>
</div>
</div>
<div class="toolbar-group">
<button id="imageBtn" onclick="insertImageIntoFormat()" title="إدراج صورة">🖼️</button>
<button id="signatureBtn" onclick="toggleSignature()" title="إضافة/إخفاء توقيع العيادة">🖋️</button>
<button id="nextVisitBtn" onclick="toggleNextVisit()" title="إظهار/إخفاء ميعاد الزيارة القادمة">📅</button>
</div>
<div class="toolbar-group">
<button onclick="clearFormatting()" title="إزالة التنسيق">🗑️</button>
</div>
</div>
<div class="margin-controls">
<h4>ضبط هوامش الصفحة (مم)</h4>
<div class="margin-inputs">
<div class="margin-input"><label>الهامش العلوي</label><input type="number" id="topMargin" value="20" min="0" max="100" step="1" class="form-input" onchange="updatePrintMargins()"></div>
<div class="margin-input"><label>الهامش السفلي</label><input type="number" id="bottomMargin" value="20" min="0" max="100" step="1" class="form-input" onchange="updatePrintMargins()"></div>
<div class="margin-input"><label>الهامش الأيمن</label><input type="number" id="rightMargin" value="15" min="0" max="100" step="1" class="form-input" onchange="updatePrintMargins()"></div>
<div class="margin-input"><label>الهامش الأيسر</label><input type="number" id="leftMargin" value="15" min="0" max="100" step="1" class="form-input" onchange="updatePrintMargins()"></div>
</div>
</div>
<div class="prescription-format-container">
<div id="formattingContainer" contenteditable="true" oninput="updateFormattingPreview()" onkeyup="updateFormattingPreview()" onmouseup="updateFormattingPreview()"></div>
</div>
<div class="form-row" style="margin-top:20px;">
<button class="login-btn" onclick="generateFormattedPDF()" style="background:var(--secondary);">📄 حفظ PDF</button>
<button class="login-btn" onclick="printCurrentFormatPreview()" style="background:var(--primary);">🖨️ طباعة مباشرة</button>
<button class="login-btn" onclick="closeModal('formatPrescriptionModal')" style="background:var(--gray);">إغلاق</button>
</div>
</div>
</div>
<div class="modal" id="addAppointmentModal">
<div class="modal-content" style="width:95%;max-width:800px;">
<span class="close-btn" onclick="closeModal('addAppointmentModal')">&times;</span>
<h3 class="form-title">إضافة حجز جديد</h3>
<div class="search-group">
<div class="autocomplete">
<label class="form-label">اسم المريض</label>
<input type="text" class="form-input" id="appointmentPatientSearch" placeholder="اكتب اسم المريض..." autocomplete="off">
<div class="autocomplete-items" id="appointmentPatientSearchResults" style="display:none;"></div>
</div>
<div class="autocomplete">
<label class="form-label">رقم الملف</label>
<input type="text" class="form-input" id="appointmentFileNumberSearch" placeholder="ابحث برقم الملف..." autocomplete="off">
<div class="autocomplete-items" id="appointmentFileNumberSearchResults" style="display:none;"></div>
</div>
<div class="autocomplete">
<label class="form-label">رقم الهاتف</label>
<input type="text" class="form-input" id="appointmentPhoneSearch" placeholder="ابحث برقم الهاتف..." autocomplete="off">
<div class="autocomplete-items" id="appointmentPhoneSearchResults" style="display:none;"></div>
</div>
</div>
<div class="patient-info-grid" id="appointmentPatientInfo">
<div class="info-item">
<div class="info-label">الاسم</div>
<div class="info-value"><input type="text" class="form-input" id="appointmentPatientName"></div>
</div>
<div class="info-item">
<div class="info-label">العمر</div>
<div class="info-value">
<div class="age-inputs">
<input type="number" class="form-input" id="appointmentAgeYears" placeholder="السنوات" min="0" max="70">
<input type="number" class="form-input" id="appointmentAgeMonths" placeholder="الأشهر" min="0" max="11">
</div>
</div>
</div>
<div class="info-item">
<div class="info-label">الوزن (كجم)</div>
<div class="info-value"><input type="number" class="form-input" id="appointmentWeight" placeholder="أدخل الوزن" step="0.1"></div>
</div>
<div class="info-item">
<div class="info-label">رقم الهاتف</div>
<div class="info-value"><input type="tel" class="form-input" id="appointmentPhone" placeholder="أدخل رقم الهاتف"></div>
</div>
<div class="info-item">
<div class="info-label">رقم الملف</div>
<div class="info-value"><input type="text" class="form-input" id="appointmentFileNumber" readonly></div>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">نوع الحجز</label>
<select class="form-input" id="appointmentType">
<option value="كشف">كشف</option>
<option value="استشارة">استشارة</option>
</select>
</div>
</div>
<div class="form-row">
<button class="login-btn" onclick="addAppointmentToConfirmed()" style="background:var(--secondary);">✅ إضافة للحجوزات الفعلية</button>
<button class="login-btn" onclick="addAppointmentToPending()" style="background:var(--accent);">⏳ إضافة للحجوزات المحتملة</button>
</div>
</div>
</div>
<div class="text-editor-modal" id="textEditorModal">
<div class="text-editor-toolbar">
<select id="textEditorFontSize" onchange="applyTextEditorFormat('fontSize', this.value + 'px')">
<option value="12">12</option>
<option value="14" selected>14</option>
<option value="16">16</option>
<option value="70">70</option>
<option value="20">20</option>
<option value="24">24</option>
</select>
<button onclick="applyTextEditorFormat('bold')" title="عريض"><strong>B</strong></button>
<button onclick="applyTextEditorFormat('italic')" title="مائل"><em>I</em></button>
<button onclick="applyTextEditorFormat('underline')" title="تحته خط"><u>U</u></button>
<input type="color" id="textEditorColor" onchange="applyTextEditorFormat('foreColor', this.value)" title="لون الخط">
<button onclick="applyTextEditorFormat('justifyRight')" title="محاذاة لليمين">➡️</button>
<button onclick="applyTextEditorFormat('justifyCenter')" title="محاذاة للوسط">🔘</button>
<button onclick="applyTextEditorFormat('justifyLeft')" title="محاذاة لليسار">⬅️</button>
</div>
<div class="text-editor-content" id="textEditorContent" contenteditable="true"></div>
<div class="text-editor-actions">
<button class="login-btn" onclick="saveTextEditorContent()" style="background:var(--secondary);">💾 حفظ</button>
<button class="login-btn" onclick="closeTextEditor()" style="background:var(--gray);margin-right:10px;">❌ إلغاء</button>
</div>
</div>
<div class="drug-interaction-alert" id="drugInteractionAlert" style="display:none;">
<h4>⚠️ تنبيه: تداخل دوائي محتمل</h4>
<div class="drug-interaction-details" id="interactionDetails"></div>
<div class="alert-buttons">
<button class="action-btn" onclick="ignoreDrugInteraction()" style="background:var(--gray);">تجاهل والمتابعة</button>
<button class="action-btn" onclick="cancelDrugInteraction()" style="background:var(--danger);">إلغاء الإضافة</button>
</div>
</div>
<div class="drug-interaction-alert" id="maxDoseAlert" style="display:none;">
<h4>⚠️ تنبيه: تجاوز الجرعة القصوى</h4>
<div class="drug-interaction-details" id="maxDoseDetails"></div>
<div class="alert-buttons">
<button class="action-btn" onclick="ignoreMaxDose()" style="background:var(--gray);">تجاهل والمتابعة</button>
<button class="action-btn" onclick="cancelMaxDose()" style="background:var(--danger);">إلغاء الإضافة</button>
</div>
</div>
<div class="modal" id="visitDetailsModal">
<div class="modal-content visit-details-modal">
<span class="close-btn" onclick="closeModal('visitDetailsModal')">&times;</span>
<div id="visitDetailsContent"></div>
</div>
</div>
<div id="printContainer" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;padding:20mm;font-family:'Cairo',sans-serif;direction:rtl;">
<div style="width:100%;height:100%;position:relative;">
<div style="text-align:center;margin-bottom:30px;">
<div style="display:flex;justify-content:space-around;margin-bottom:15px;">
<div style="font-size:14px;"><strong>الاسم:</strong> <span id="printName"></span></div>
<div style="font-size:14px;"><strong>رقم الملف:</strong> <span id="printFileNo"></span></div>
</div>
<div style="display:flex;justify-content:space-around;">
<div style="font-size:14px;"><strong>العمر:</strong> <span id="printAge"></span></div>
<div style="font-size:14px;"><strong>تاريخ الزيارة:</strong> <span id="printDate"></span></div>
</div>
</div>
<hr style="border:1px solid #ccc;margin:20px 0;">
<div id="printMeds" style="min-height:200px;padding:20px;text-align:center;"></div>
<div style="position:absolute;bottom:0;right:0;text-align:right;width:100%;">
<div id="printNextVisitDate" style="margin-bottom:15px;font-size:12px;"></div>
<div style="border-top:1px solid #000;padding-top:10px;font-size:12px;">
<strong id="printClinicName">Nabed - نابض</strong><br>
<span id="printDoctorName">Dr / Mohamed Khattab</span>
</div>
</div>
</div>
</div>
<input type="file" id="imageUploadInput" accept="image/*" style="display:none;">
<input type="file" id="imageInsertInput" accept="image/*" style="display:none;">
<input type="file" id="imageUploadInputNew" accept="image/*" style="display:none;">
<input type="file" id="logoUpload" accept="image/*" style="display:none;"><div class="comm-icon" id="commIcon" onclick="toggleCommModal()" style="position: relative; cursor: pointer; display: inline-block;">💬</div>
<div class="comm-modal" id="commModal">
<div class="comm-header">
<h4>💬 محادثة</h4>
<span class="comm-close" onclick="toggleCommModal()">&times;</span>
</div>
<div class="comm-messages" id="commMessages"></div>
<div class="comm-input">
<input type="text" id="commInput" placeholder="اكتب رسالة...">
<button onclick="sendMessage()">إرسال</button>
</div>
</div>
<script>
let patients=JSON.parse(localStorage.getItem('clinicPatients'))||[],
visits=JSON.parse(localStorage.getItem('clinicVisits'))||[],
medications=JSON.parse(localStorage.getItem('clinicMedications'))||[],
prescriptionFormats=JSON.parse(localStorage.getItem('prescriptionFormats'))||[],
prescriptionTemplates=JSON.parse(localStorage.getItem('prescriptionTemplates'))||[],
clinicSettings=JSON.parse(localStorage.getItem('clinicSettings'))||{
clinicName:"Nabed - نابض",
doctorName:"Pulse of Medical Clinics",
clinicLogo:"👨‍⚕️",
username:"doctor",
password:"test123",
secretaryUsername:"secretary",
secretaryPassword:"mohamed2010",
permissions:{patients:true,appointments:true,medications:false,reports:false}
},
currentPatient=null,
currentPrescription=[],
editingMedicationId=null,
editingPrescriptionId=null,
additionalInstructions='',
currentFormat={fontFamily:'Cairo',fontSize:'16px',fontColor:'#000000',lineHeight:'1.5',topMargin:20,bottomMargin:20,leftMargin:15,rightMargin:15,isDefault:false},
pendingMedication=null,
pendingMaxDoseMedication=null,
checkDrugInteraction=true,
showSignatureInFormat=false,
showNextVisitInFormat=true,
currentAgeDisplay='غير محدد',
currentHeader={elements:[],height:80,showSeparator:true,html:'',preview:''},
currentFooter={elements:[],height:60,showSeparator:true,html:'',preview:''},
selectedElement=null,
selectedElementType=null,
headerTemplates=JSON.parse(localStorage.getItem('headerTemplates'))||[],
footerTemplates=JSON.parse(localStorage.getItem('footerTemplates'))||[],
currentImageUploadFor='',
currentInteractions=[],
currentEditInteractions=[],
currentTextEditorElement=null,
ageDoseRows=[],
editAgeDoseRows=[],
headerElements=[],
footerElements=[],
selectedHeaderElement=null,
selectedFooterElement=null,
headerTemplatesNew=JSON.parse(localStorage.getItem('headerTemplatesNew'))||[],
footerTemplatesNew=JSON.parse(localStorage.getItem('footerTemplatesNew'))||[],
appointments=JSON.parse(localStorage.getItem('clinicAppointments'))||[],
currentAppointmentPatient=null,
currentUserType='doctor',
selectedLoginUser='doctor',
messages=JSON.parse(localStorage.getItem('clinicMessages'))||[],
resizingImage=null,rotatingImage=null,imageHandles=[],
commIconDraggable={isDragging:false,offsetX:0,offsetY:0};

const medicineTypeTranslations={
'Syrup':'Syrup (شراب)',
'Suspension':'Suspension (معلق)',
'Ampule':'Ampule (أمبولة)',
'Vial':'Vial (قارورة)',
'Tab':'Tab (قرص)',
'Cap':'Cap (كبسولة)',
'Sachets':'Sachets (كيس)',
'Oral Film':'Oral Film (لزقة في الفم)',
'Supp':'Supp (لبوس)',
'cream':'cream (كريم)',
'ointment':'ointment (مرهم)',
'lotion':'lotion (لوشن)',
'Iv Fluid':'Iv Fluid (محلول وريدي)',
'Other':'Other (أخرى)'
};

function setupDoctorDashboard(){
document.getElementById('loginPage').style.display='none';
document.getElementById('dashboard').style.display='block';

// تأمين كود العيادة وتفعيل المزامنة السحابية فوراً
if(!clinicID) clinicID = localStorage.getItem('nabed_clinic_id');
document.getElementById('currentUser').textContent=clinicSettings.doctorName;
document.getElementById('dashboardClinicName').textContent = "عيادة: " + (clinicID || "نابض");

if(typeof syncFromCloud === 'function') syncFromCloud();

showAllSections();
renderPatientsList();
renderMedicationsList();
updateStats();
loadFormatTemplates();
renderSavedPrescriptions();
const savedHeader=localStorage.getItem('currentHeader');
const savedFooter=localStorage.getItem('currentFooter');
if(savedHeader)currentHeader=JSON.parse(savedHeader);
if(savedFooter)currentFooter=JSON.parse(savedFooter);
const today=new Date().toISOString().split('T')[0];
document.getElementById('appointmentDate').value=today;
loadAppointments();
loadMessages();
}

function setupSecretaryDashboard(){
document.getElementById('loginPage').style.display='none';
document.getElementById('dashboard').style.display='block';

// تأمين كود العيادة وتفعيل المزامنة السحابية فوراً
if(!clinicID) clinicID = localStorage.getItem('nabed_clinic_id');
document.getElementById('currentUser').textContent='سكرتير العيادة';
document.getElementById('dashboardClinicName').textContent= (clinicID || clinicSettings.clinicName) +' - نظام السكرتير';

if(typeof syncFromCloud === 'function') syncFromCloud();

setupSecretarySections();
const today=new Date().toISOString().split('T')[0];
document.getElementById('appointmentDate').value=today;
loadAppointments();
loadMessages();
}

function setupSecretarySections(){
const navButtons=document.querySelectorAll('.nav-btn');
navButtons.forEach(btn=>{
const btnText=btn.textContent;
if(btnText.includes('إدارة المرضى')&&!clinicSettings.permissions.patients){
btn.style.display='none';
}else if(btnText.includes('الحجوزات')&&!clinicSettings.permissions.appointments){
btn.style.display='none';
}else if(btnText.includes('بنك الأدوية')&&!clinicSettings.permissions.medications){
btn.style.display='none';
}else if(btnText.includes('التقارير')&&!clinicSettings.permissions.reports){
btn.style.display='none';
}
});
document.querySelector('.clinic-settings-btn').style.display='none';
showSection('appointments');
}

function showAllSections(){
const navButtons=document.querySelectorAll('.nav-btn');
navButtons.forEach(btn=>{
btn.style.display='flex';
});
document.querySelector('.clinic-settings-btn').style.display='inline-block';
}

function showSection(sectionName){
const sections=['patients','appointments','medications','reports'];
sections.forEach(section=>{
const sectionElement=document.getElementById(section+'Section');
if(sectionElement){
sectionElement.style.display='none';
}
});
const targetSection=document.getElementById(sectionName+'Section');
if(targetSection){
targetSection.style.display='block';
}
document.querySelectorAll('.nav-btn').forEach(btn=>{
btn.classList.remove('active');
});
const navButtons=document.querySelectorAll('.nav-btn');
navButtons.forEach((btn,index)=>{
if(btn.textContent.includes(getSectionName(sectionName))){
btn.classList.add('active');
}
});
if(sectionName==='patients'){
renderPatientsList();
}else if(sectionName==='medications'){
renderMedicationsList();
renderSavedPrescriptions();
}else if(sectionName==='reports'){
updateStats();
}else if(sectionName==='appointments'){
loadAppointments();
}
}

function getSectionName(sectionId){
const sectionNames={
'patients':'إدارة المرضى',
'appointments':'الحجوزات',
'medications':'بنك الأدوية',
'reports':'التقارير'
};
return sectionNames[sectionId]||sectionId;
}

function closeModal(modalId){
document.getElementById(modalId).style.display='none';
}

function closeVisitModal(){
document.getElementById('visitModal').style.display='none';
currentPrescription=[];
additionalInstructions='';
}

// --- محرك نابض النهائي (بدون تكرار) ---
// ملاحظة: المتغيرات معرفة مرة واحدة فقط هنا
// تأكد من عدم وجود let currentUserType = ... فوق هذا السطر أو تحته
function selectUser(user) {
    selectedLoginUser = user;
    
    // إخفاء واجهة الاختيار وإظهار واجهة الباسورد
    document.getElementById('userSelector').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';

    // تحديث النصوص
    const label = document.querySelector('#loginForm .form-label');
    if(label) label.innerText = "أدخل كود تفعيل العيادة (Clinic ID)";
    
    // تحسين بصري (اختياري)
    const docCard = document.getElementById('doctorCard');
    const secCard = document.getElementById('secretaryCard');
    if(docCard) docCard.classList.remove('selected');
    if(secCard) secCard.classList.remove('selected');
    if(user === 'doctor' && docCard) docCard.classList.add('selected');
    if(user === 'secretary' && secCard) secCard.classList.add('selected');
}

function showUserSelector() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('userSelector').style.display = 'flex';
    document.getElementById('password').value = '';
}

function handleLogin() {
    const inputCode = document.getElementById('password').value.trim();
    
    if (inputCode.length < 3) {
        alert("من فضلك أدخل كود العيادة بشكل صحيح");
        return;
    }

    // 1. تعيين كود العيادة
    clinicID = inputCode;
    currentUserType = selectedLoginUser;

    // 2. الحفظ في الذاكرة
    localStorage.setItem('nabed_clinic_id', clinicID);
    localStorage.setItem('nabed_user_role', currentUserType);
    
    // للحفاظ على توافق الكود القديم (احتياطي)
    localStorage.setItem('activeClinicId', clinicID); 

    // 3. توجيه المستخدم
    if (currentUserType === 'doctor') {
        setupDoctorDashboard();
    } else {
        setupSecretaryDashboard();
    }

    // 4. فتح السيستم
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    
    // تحديث اسم العيادة في الأعلى
    const title = document.getElementById('dashboardClinicName');
    if(title) title.innerText = `عيادة: ${clinicID}`;

    console.log("تم الدخول بنجاح. معرف العيادة: " + clinicID);
}

function logout() {
    if(confirm("هل تريد تسجيل الخروج؟")) {
        localStorage.removeItem('nabed_user_role');
        // لا نحذف كود العيادة (nabed_clinic_id) لنسهل الدخول المرة القادمة، أو نحذفه لو أردت أماناً أعلى
        location.reload();
    }
}function renderPatientsList(){
const tbody=document.getElementById('patientsList');
tbody.innerHTML='';
patients.forEach(patient=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${patient.fileNumber}</td><td>${patient.fullName}</td><td>${getAgeDisplay(patient)}</td><td>${patient.weight||'-'}</td><td>${patient.phone||'-'}</td><td><button class="action-btn record-btn" onclick="showPatientRecord(${patient.id})">السجل المرضي</button><button class="action-btn delete-btn" onclick="deletePatient(${patient.id})">حذف</button></td>`;
tbody.appendChild(tr);
});
}

function getAgeDisplay(patient){
const years=patient.ageYears||'';
const months=patient.ageMonths||'';
if(years&&months){
return `${years} سنة و ${months} شهر`;
}else if(years){
return `${years} سنة`;
}else if(months){
return `${months} شهر`;
}else{
return 'غير محدد';
}
}

function startNewVisit(){
let patientName=document.getElementById('patientSearch').value.trim();
let fileNumber=document.getElementById('fileNumberSearch').value.trim();
let phoneNumber=document.getElementById('phoneSearch').value.trim();
let patient=null;
if(patientName){
patient=patients.find(p=>p.fullName===patientName);
}else if(fileNumber){
patient=patients.find(p=>p.fileNumber===fileNumber);
}else if(phoneNumber){
patient=patients.find(p=>p.phone===phoneNumber);
}
if(!patient&&patientName){
patient={
id:Date.now(),
fullName:patientName,
ageYears:'',
ageMonths:'',
weight:'',
phone:phoneNumber||'',
chronicHistory:'',
fileNumber:'P-'+(patients.length+1001),
createdAt:new Date().toLocaleDateString('ar-EG')
};
patients.push(patient);
saveToStorage();
renderPatientsList();
}else if(!patient){
alert('الرجاء إدخال بيانات المريض');
return;
}
currentPatient=patient;
currentPrescription=[];
additionalInstructions='';
showVisitModal();
}

function showVisitModal(){
if(!currentPatient){
alert('الرجاء اختيار مريض أولاً');
return;
}
const previousVisits=visits.filter(v=>v.patientId===currentPatient.id).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
const visitContent=document.getElementById('visitContent');
visitContent.innerHTML=`<div class="form-container"><h3 class="form-title">كشف جديد - ${currentPatient.fullName}</h3><div class="visit-section"><h4>بيانات المريض</h4><div class="patient-info-grid"><div class="info-item"><div class="info-label">الاسم</div><div class="info-value">${currentPatient.fullName}</div></div><div class="info-item"><div class="info-label">العمر</div><div class="info-value"><div class="age-inputs"><input type="number" class="form-input" id="visitAgeYears" value="${currentPatient.ageYears||''}" placeholder="السنوات" min="0" max="70" oninput="updatePatientAgeInVisit()"><input type="number" class="form-input" id="visitAgeMonths" value="${currentPatient.ageMonths||''}" placeholder="الأشهر" min="0" max="11" oninput="updatePatientAgeInVisit()"></div></div></div><div class="info-item"><div class="info-label">الوزن (كجم)</div><div class="info-value"><input type="number" class="form-input" id="visitWeight" value="${currentPatient.weight||''}" placeholder="أدخل الوزن" onchange="updatePrescriptionWeight()" step="0.1"></div></div><div class="info-item"><div class="info-label">رقم الهاتف</div><div class="info-value"><input type="tel" class="form-input" id="visitPhone" value="${currentPatient.phone||''}" placeholder="أدخل رقم الهاتف" onchange="updatePatientPhone()"></div></div><div class="info-item"><div class="info-label">رقم الملف</div><div class="info-value">${currentPatient.fileNumber}</div></div></div></div><div class="visit-section"><h4>التاريخ المرضي المزمن</h4><textarea class="form-input" id="chronicHistory" rows="3">${currentPatient.chronicHistory||''}</textarea></div><div class="visit-section previous-visits"><h4>الزيارات الطبية السابقة</h4>${generatePreviousVisits(previousVisits)}</div><div class="visit-section"><h4>التاريخ المرضي للزيارة الحالية</h4><textarea class="form-input" id="visitHistory" rows="3" placeholder="وصف الأعراض والشكوى الحالية..."></textarea></div><div class="visit-section"><h4>التشخيص النهائي</h4><textarea class="form-input" id="visitDiagnosis" rows="3" placeholder="التشخيص الطبي النهائي..."></textarea></div><div class="visit-section"><h4>الروشتة الطبية</h4><button class="login-btn" onclick="showPrescriptionModal()">فتح الروشتة</button><div id="currentPrescription" class="print-prescription" style="margin-top:20px;${currentPrescription.length>0?'':'display:none;'}"><div class="prescription-medications" id="prescriptionMedicationsList">${generatePrescriptionMedications()}</div>${additionalInstructions?`<div class="additional-instructions">${additionalInstructions}</div>`:''}<div class="form-row"><div><label class="form-label">ميعاد الزيارة القادمة</label><input type="date" class="form-input" id="nextVisitDate"></div></div></div></div><div class="form-row"><button class="login-btn" onclick="saveVisit()" style="background:var(--secondary);">حفظ الكشف</button><button class="login-btn" onclick="generatePrescriptionPDF()" style="background:var(--accent);">📄 حفظ الروشتة PDF</button><button class="login-btn" onclick="sendPrescriptionViaWhatsApp()" style="background:#25D366;color:white;">📱 إرسال عبر WhatsApp</button><button class="login-btn" onclick="showFormatPrescriptionModal()" style="background:var(--primary);">تنسيق الطباعة</button><button class="login-btn" onclick="printDirectPrescriptionWithDefaultFormat()" style="background:#9b59b6;color:white;">🖨️ طباعة مباشرة</button></div></div>`;
document.getElementById('visitModal').style.display='block';
updatePatientAgeInVisit();
}

function updatePatientAgeInVisit(){
const ageYears=document.getElementById('visitAgeYears')?.value||'';
const ageMonths=document.getElementById('visitAgeMonths')?.value||'';
if(ageYears&&ageMonths){
currentAgeDisplay=`${ageYears} سنة و ${ageMonths} شهر`;
}else if(ageYears){
currentAgeDisplay=`${ageYears} سنة`;
}else if(ageMonths){
currentAgeDisplay=`${ageMonths} شهر`;
}else{
currentAgeDisplay='غير محدد';
}
if(currentPatient){
currentPatient.ageYears=ageYears;
currentPatient.ageMonths=ageMonths;
}
}

function generatePreviousVisits(visits){
if(visits.length===0){
return '<p style="text-align:center;color:#666;padding:20px;">لا توجد زيارات سابقة</p>';
}
let html='';
visits.forEach(visit=>{
html+=`<div class="visit-item"><div class="visit-header"><div class="visit-date">${visit.date}</div><button class="action-btn edit-btn" onclick="showVisitDetails(${visit.id})">عرض الزيارة</button></div><div class="visit-diagnosis"><strong>التشخيص:</strong> ${visit.diagnosis||'غير محدد'}</div></div>`;
});
return html;
}

function generatePrescriptionMedications(){
if(currentPrescription.length===0){
return '<p style="text-align:center;color:#666;padding:20px;">لا توجد أدوية مضافة</p>';
}
let html='';
currentPrescription.forEach((med,index)=>{
let doseText=med.dose;
if(med.ageUnit&&!doseText.includes(med.ageUnit)){
doseText+=' '+med.ageUnit;
}
const details=med.notes?`${doseText} ${med.frequency?med.frequency:''}${med.duration?' '+med.duration:''} - ${med.notes}`:`${doseText} ${med.frequency?med.frequency:''}${med.duration?' '+med.duration:''}`;
html+=`<div class="prescription-item"><div class="prescription-item-main">R/ ${med.displayName||med.name}</div><div class="prescription-item-details">${details}</div></div>`;
});
return html;
}

function showPrescriptionModal(){
if(!currentPatient){
alert('الرجاء اختيار مريض أولاً');
return;
}
const prescriptionContent=document.getElementById('prescriptionContent');
prescriptionContent.innerHTML=`<div class="form-container"><h3 class="form-title">الروشتة الطبية - ${currentPatient.fullName}</h3><div class="prescriptions-select"><label class="form-label">📋 الروشتات المحفوظة (لإضافة أدوية سريعة)</label><select class="form-input" id="savedPrescriptionsSelect" onchange="loadPrescriptionTemplate()"><option value="">اختر روشتة محفوظة...</option>${prescriptionTemplates.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div><div class="medication-form"><h4>إضافة دواء جديد</h4><div class="form-row"><div><label class="form-label">اسم الدواء</label><select class="form-input" id="medicationSelect" onchange="onMedicationSelect()"><option value="">اختر من بنك الأدوية</option>${medications.map(med=>{const displayName=generateMedicationDisplayName(med);return `<option value="${med.id}" data-type="${med.type}">${displayName}</option>`;}).join('')}<option value="custom">+ إضافة دواء جديد</option></select></div><div id="customMedication" style="display:none;"><label class="form-label">اسم الدواء الجديد</label><input type="text" class="form-input" id="customMedName" placeholder="أدخل اسم الدواء"></div></div><div class="form-row"><div><label class="form-label">الجرعة (قابلة للتعديل)</label><input type="text" class="form-input" id="medicationDose" placeholder="سيتم حساب الجرعة تلقائياً"></div><div><label class="form-label">التكرار</label><select class="form-input" id="medicationFrequency"><option value="">اختر التكرار</option><option value="عند اللزوم">عند اللزوم</option><option value="مرة واحدة فقط">مرة واحدة فقط</option><option value="كل 2 ساعة">كل 2 ساعة</option><option value="كل 3 ساعات">كل 3 ساعات</option><option value="كل 4 ساعات">كل 4 ساعات</option><option value="كل 6 ساعات">كل 6 ساعات</option><option value="كل 8 ساعات">كل 8 ساعات</option><option value="كل 12 ساعة">كل 12 ساعة</option><option value="كل 24 ساعة">كل 24 ساعة</option><option value="كل 48 ساعة">كل 48 ساعة</option><option value="كل 3 أيام">كل 3 أيام</option><option value="كل أسبوع">كل أسبوع</option><option value="كل شهر">كل شهر</option></select></div><div><label class="form-label">المدة</label><select class="form-input" id="medicationDuration"><option value="">اختر المدة</option><option value="لمدة يوم واحد">لمدة يوم واحد</option><option value="لمدة يومين">لمدة يومين</option><option value="لمدة 3 أيام">لمدة 3 أيام</option><option value="لمدة 4 أيام">لمدة 4 أيام</option><option value="لمدة 5 أيام">لمدة 5 أيام</option><option value="لمدة 6 أيام">لمدة 6 أيام</option><option value="لمدة اسبوع">لمدة اسبوع</option><option value="لمدة 10 أيام">لمدة 10 أيام</option><option value="لمدة اسبوعين">لمدة اسبوعين</option><option value="لمدة شهر">لمدة شهر</option><option value="لمدة شهرين">لمدة شهرين</option><option value="لمدة 3 شهور">لمدة 3 شهور</option><option value="باستمرار">باستمرار</option></select></div></div><div class="form-group"><label class="form-label">ملاحظات</label><textarea class="form-input" id="medicationNotes" rows="2" placeholder="ملاحظات إضافية..."></textarea></div><button class="login-btn" onclick="addMedicationToPrescription()" style="background:var(--secondary);">إضافة للروشتة</button></div><div class="instructions-section"><h4>تعليمات خارجية إضافية</h4><div class="form-group"><label class="form-label">اكتب تعليمات إضافية (ستظهر في الروشتة المطبوعة فقط إذا كتبت شيئاً)</label><textarea class="form-input" id="additionalInstructions" rows="3" placeholder="مثال: يجب مراجعة الطبيب في حالة ارتفاع درجة الحرارة عن 38.5..." oninput="updateAdditionalInstructions()">${additionalInstructions}</textarea></div></div><div class="medication-preview"><h4>الأدوية المضافة (${currentPrescription.length})</h4><div id="prescriptionPreview">${generatePrescriptionPreview()}</div></div><div class="form-row"><button class="login-btn" onclick="closeModal('prescriptionModal')" style="background:var(--primary);">حفظ وإغلاق</button></div></div>`;
document.getElementById('prescriptionModal').style.display='block';
}

function onMedicationSelect(){
const select=document.getElementById('medicationSelect');
const customDiv=document.getElementById('customMedication');
const doseInput=document.getElementById('medicationDose');
const frequencySelect=document.getElementById('medicationFrequency');
const durationSelect=document.getElementById('medicationDuration');
const notesInput=document.getElementById('medicationNotes');
if(select.value==='custom'){
customDiv.style.display='block';
doseInput.readOnly=false;
doseInput.value='';
frequencySelect.selectedIndex=0;
durationSelect.selectedIndex=0;
notesInput.value='';
}else{
customDiv.style.display='none';
doseInput.readOnly=false;
if(select.value){
const selectedMed=medications.find(med=>med.id==select.value);
const weight=parseFloat(document.getElementById('visitWeight')?.value)||currentPatient.weight||0;
const ageYears=parseInt(currentPatient.ageYears)||0;
const ageMonths=parseInt(currentPatient.ageMonths)||0;
if(selectedMed){
let doseInfo={};
let ageUnit='';
if(selectedMed.doseCalculationType==='age'&&selectedMed.ageDoses){
const totalMonths=(ageYears*12)+ageMonths;
const ageDose=selectedMed.ageDoses.find(dose=>{
const fromMonths=(dose.fromYears*12)+dose.fromMonths;
const toMonths=(dose.toYears*12)+dose.toMonths;
return totalMonths>=fromMonths&&totalMonths<=toMonths;
});
if(ageDose){
doseInfo={dose:ageDose.dose,unit:getArabicUnit(ageDose.unit||''),calculated:true};
ageUnit=getArabicUnit(ageDose.unit||'');
frequencySelect.value=ageDose.frequency||'';
durationSelect.value=ageDose.duration||'';
}
}else{
doseInfo=calculateMedicationDose(selectedMed,weight);
frequencySelect.value=selectedMed.frequency||'';
durationSelect.value=selectedMed.duration||'';
}
if(ageUnit){
doseInput.value=doseInfo.calculated?`${doseInfo.dose} ${ageUnit}`:`${selectedMed.dosePerKg} ${getArabicUnit(selectedMed.doseUnit)}`;
}else{
doseInput.value=doseInfo.calculated?`${doseInfo.dose} ${doseInfo.unit}`:`${selectedMed.dosePerKg} ${getArabicUnit(selectedMed.doseUnit)}`;
}
if(doseInfo.exceedsMax){
doseInput.title=`تحذير: الجرعة المحسوبة (${doseInfo.dose} ${doseInfo.unit}) تتجاوز الحد الأقصى (${doseInfo.maxDose})`;
doseInput.style.borderColor='var(--danger)';
}else{
doseInput.title=`الجرعة المحسوبة: ${doseInfo.dose} ${doseInfo.unit}`;
doseInput.style.borderColor='';
}
notesInput.value=selectedMed.doseNotes||'';
}
}
}
}

function getArabicUnit(unit){
const units={
'ml':'مل',
'drops':'نقطة',
'tab':'قرص',
'cap':'كبسولة',
'supp':'لبوسة',
'gram':'جرام',
'sachet':'كيس',
'oral film':'لزقة في الفم',
'mcg':'ميكروجرام',
'mg':'ملليجرام',
'g':'جرام'
};
return units[unit]||unit;
}

function calculateMedicationDose(med,weight){
if(med.type==='cream'||med.type==='ointment'||med.type==='lotion'){
return{dose:'دهان',unit:'',calculated:true};
}
if(!weight||weight<=0||!med.dosePerKg||med.dosePerKg<=0){
return{dose:med.dosePerKg||0,unit:getArabicUnit(med.doseUnit||''),calculated:false};
}
let calculatedDose=(weight*med.dosePerKg*med.volume)/med.concentration;
const maxDoseCheck=checkMaxDose(med,calculatedDose);
if(maxDoseCheck.exceeds){
return{dose:calculatedDose.toFixed(2),unit:getArabicUnit(med.volumeUnit),calculated:true,exceedsMax:true,maxDose:maxDoseCheck.max};
}
return{dose:calculatedDose.toFixed(2),unit:getArabicUnit(med.volumeUnit),calculated:true};
}

function checkMaxDose(med,calculatedDose){
if(med.maxDose&&med.maxDose>0&&med.maxDoseUnit){
if(med.maxDoseUnit===med.volumeUnit){
if(calculatedDose>med.maxDose){
return{exceeds:true,max:med.maxDose,unit:med.maxDoseUnit};
}
}
}
return{exceeds:false};
}

function getVolumeUnitName(unit){
const units={
'ml':'مل',
'drops':'نقطة',
'tab':'قرص',
'cap':'كبسولة',
'supp':'لبوسة',
'gram':'جرام',
'sachet':'كيس',
'oral film':'لزقة في الفم'
};
return units[unit]||unit;
}

function addMedicationToPrescription(){
const select=document.getElementById('medicationSelect');
const customName=document.getElementById('customMedName').value;
const dose=document.getElementById('medicationDose').value;
const frequency=document.getElementById('medicationFrequency').value;
const duration=document.getElementById('medicationDuration').value;
const notes=document.getElementById('medicationNotes').value;
let medicationName='',scientificName='',medicationType='',displayName='',ageUnit='';
if(select.value==='custom'){
if(!customName){
alert('الرجاء إدخال اسم الدواء');
return;
}
medicationName=customName;
displayName=customName;
medicationType='Other';
}else if(select.value){
const selectedMed=medications.find(med=>med.id==select.value);
medicationName=selectedMed.name;
scientificName=selectedMed.scientificName||'';
medicationType=selectedMed.type;
displayName=generateMedicationDisplayName(selectedMed);
const weight=parseFloat(document.getElementById('visitWeight')?.value)||currentPatient.weight||0;
const ageYears=parseInt(currentPatient.ageYears)||0;
const ageMonths=parseInt(currentPatient.ageMonths)||0;
const doseInfo=calculateMedicationDose(selectedMed,weight);
if(selectedMed.doseCalculationType==='age'&&selectedMed.ageDoses){
const totalMonths=(ageYears*12)+ageMonths;
const ageDose=selectedMed.ageDoses.find(dose=>{
const fromMonths=(dose.fromYears*12)+dose.fromMonths;
const toMonths=(dose.toYears*12)+dose.toMonths;
return totalMonths>=fromMonths&&totalMonths<=toMonths;
});
if(ageDose){
ageUnit=getArabicUnit(ageDose.unit||'');
}
}
if(doseInfo.exceedsMax){
pendingMaxDoseMedication={
name:medicationName,
displayName:displayName,
dose:dose,
frequency:frequency,
duration:duration,
notes:notes,
scientificName:scientificName,
type:medicationType,
calculatedDose:doseInfo.dose,
maxDose:doseInfo.maxDose,
unit:doseInfo.unit,
ageUnit:ageUnit
};
showMaxDoseAlert(doseInfo);
return;
}
}else{
alert('الرجاء اختيار دواء');
return;
}
if(!dose){
alert('الرجاء إدخال الجرعة');
return;
}
const medication={
name:medicationName,
displayName:displayName,
dose:dose,
frequency:frequency,
duration:duration,
notes:notes,
scientificName:scientificName,
type:medicationType,
ageUnit:ageUnit
};
const interaction=checkDrugInteractions(medication);
if(interaction){
pendingMedication=medication;
showDrugInteractionAlert(interaction);
return;
}
currentPrescription.push(medication);
updatePrescriptionDisplay();
select.value='';
document.getElementById('customMedName').value='';
document.getElementById('medicationDose').value='';
document.getElementById('medicationFrequency').selectedIndex=0;
document.getElementById('medicationDuration').selectedIndex=0;
document.getElementById('medicationNotes').value='';
document.getElementById('customMedication').style.display='none';
}

function generateMedicationDisplayName(med){
let displayName=med.name;
if(med.concentration&&med.concentrationUnit){
displayName+=` ${med.concentration}${med.concentrationUnit}`;
}
if(med.volume&&med.volumeUnit){
displayName+=`/${med.volume}${med.volumeUnit}`;
}
if(med.type&&med.type!=='Other'){
displayName+=` (${med.type})`;
}
return displayName;
}

function getMedicineTypeName(type){
return medicineTypeTranslations[type]||type;
}

function generatePrescriptionPreview(){
if(currentPrescription.length===0){
return '<p style="color:#666;text-align:center;">لم يتم إضافة أي أدوية بعد</p>';
}
let html='';
currentPrescription.forEach((med,index)=>{
let doseText=med.dose;
if(med.ageUnit&&!doseText.includes(med.ageUnit)){
doseText+=' '+med.ageUnit;
}
const durationText=med.duration?med.duration:'';
html+=`<div class="prescription-item"><div class="prescription-item-main">R/ ${med.displayName||med.name}</div><div class="prescription-item-details">${doseText} ${med.frequency?med.frequency:''}${durationText?` ${durationText}`:''} ${med.notes?' - '+med.notes:''}</div><button class="action-btn delete-btn" onclick="removeMedicationFromPrescription(${index})" style="margin-top:5px;">حذف</button></div>`;
});
return html;
}

function removeMedicationFromPrescription(index){
currentPrescription.splice(index,1);
updatePrescriptionDisplay();
}

function updatePrescriptionDisplay(){
const preview=document.getElementById('prescriptionPreview');
if(preview){
preview.innerHTML=generatePrescriptionPreview();
}
const prescriptionMedications=document.getElementById('prescriptionMedicationsList');
if(prescriptionMedications){
prescriptionMedications.innerHTML=generatePrescriptionMedications();
}
const prescriptionDiv=document.getElementById('currentPrescription');
if(prescriptionDiv){
prescriptionDiv.style.display=currentPrescription.length>0?'block':'none';
}
if(document.getElementById('formatPrescriptionModal').style.display==='block'){
updateFormattingContainer();
}
}

function updateAdditionalInstructions(){
const instructionsInput=document.getElementById('additionalInstructions');
if(instructionsInput){
additionalInstructions=instructionsInput.value.trim();
localStorage.setItem('tempAdditionalInstructions',additionalInstructions);
updateFormattingContainer();
}
}

function saveVisit(){
const visit={
id:Date.now(),
patientId:currentPatient.id,
patientName:currentPatient.fullName,
date:new Date().toLocaleDateString('ar-EG'),
ageYears:document.getElementById('visitAgeYears').value,
ageMonths:document.getElementById('visitAgeMonths').value,
weight:document.getElementById('visitWeight').value,
phone:document.getElementById('visitPhone').value,
chronicHistory:document.getElementById('chronicHistory').value,
visitHistory:document.getElementById('visitHistory').value,
diagnosis:document.getElementById('visitDiagnosis').value,
prescription:currentPrescription,
additionalInstructions:additionalInstructions,
nextVisit:document.getElementById('nextVisitDate')?document.getElementById('nextVisitDate').value:''
};
currentPatient.ageYears=visit.ageYears;
currentPatient.ageMonths=visit.ageMonths;
currentPatient.weight=visit.weight;
currentPatient.phone=visit.phone;
currentPatient.chronicHistory=visit.chronicHistory;
visits.push(visit);
saveToStorage();
if(visit.nextVisit){
addAppointmentFromVisit(visit);
}
const appointmentDate=document.getElementById('appointmentDate').value;
const todayAppointments=appointments.filter(a=>a.date===appointmentDate);
const todayAppointment=todayAppointments.find(a=>a.patientId===currentPatient.id&&(a.status==='منتظر'||a.status==='مؤكد'));
if(todayAppointment){
todayAppointment.status='تمت الزيارة';
saveAppointments();
loadAppointments();
}
alert('تم حفظ الكشف بنجاح!');
closeVisitModal();
renderPatientsList();
updateStats();
}

function addAppointmentFromVisit(visit){
if(!visit.nextVisit)return;
const appointmentDate=new Date(visit.nextVisit).toISOString().split('T')[0];
const appointment={
id:Date.now(),
patientId:visit.patientId,
patientName:visit.patientName,
date:appointmentDate,
type:'استشارة',
status:'منتظر',
ageYears:visit.ageYears,
ageMonths:visit.ageMonths,
weight:visit.weight,
phone:visit.phone,
fileNumber:currentPatient.fileNumber
};
appointments.push(appointment);
saveAppointments();
}

function generatePrescriptionPDF(){
if(currentPrescription.length===0){
alert('لا توجد أدوية في الروشتة للطباعة');
return;
}
const nextVisitInput=document.getElementById('nextVisitDate');
let nextVisitDate='';
if(nextVisitInput&&nextVisitInput.value){
const date=new Date(nextVisitInput.value);
nextVisitDate=date.toLocaleDateString('ar-EG');
}
document.getElementById('printName').textContent=currentPatient.fullName;
document.getElementById('printFileNo').textContent=currentPatient.fileNumber;
document.getElementById('printAge').textContent=currentAgeDisplay;
document.getElementById('printDate').textContent=new Date().toLocaleDateString('ar-EG');
const medsContainer=document.getElementById('printMeds');
medsContainer.innerHTML='';
currentPrescription.forEach((med,index)=>{
const medDiv=document.createElement('div');
medDiv.style.marginBottom='15px';
medDiv.style.textAlign='center';
let doseText=med.dose;
if(med.ageUnit&&!doseText.includes(med.ageUnit)){
doseText+=' '+med.ageUnit;
}
const durationText=med.duration?med.duration:'';
const details=med.notes?`${doseText} ${med.frequency?med.frequency:''}${durationText?` ${durationText}`:''} - ${med.notes}`:`${doseText} ${med.frequency?med.frequency:''}${durationText?` ${durationText}`:''}`;
medDiv.innerHTML=`<div style="font-weight:bold;font-size:16px;margin-bottom:5px;color:#000;">R/ ${med.displayName||med.name}</div><div style="font-size:14px;color:#333;">${details}</div>`;
medsContainer.appendChild(medDiv);
});
if(additionalInstructions){
const instructionsDiv=document.createElement('div');
instructionsDiv.style.margin='30px 0';
instructionsDiv.style.padding='15px';
instructionsDiv.style.textAlign='right';
instructionsDiv.style.direction='rtl';
instructionsDiv.innerHTML=`${additionalInstructions}`;
medsContainer.appendChild(instructionsDiv);
}
const nextVisitDiv=document.getElementById('printNextVisitDate');
if(nextVisitDate){
nextVisitDiv.innerHTML=`<strong>ميعاد الزيارة القادمة:</strong> ${nextVisitDate}`;
nextVisitDiv.style.display='block';
}else{
nextVisitDiv.style.display='none';
}
const printContainer=document.getElementById('printContainer');
printContainer.style.display='block';
setTimeout(()=>{
html2canvas(printContainer,{scale:2,useCORS:true,logging:false,backgroundColor:'#ffffff',allowTaint:true,removeContainer:false}).then(canvas=>{
printContainer.style.display='none';
const{jsPDF}=window.jspdf;
const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
const imgData=canvas.toDataURL('image/jpeg',1.0);
const pageWidth=doc.internal.pageSize.getWidth();
const pageHeight=doc.internal.pageSize.getHeight();
const imgWidth=pageWidth;
const imgHeight=(canvas.height*pageWidth)/canvas.width;
doc.addImage(imgData,'JPEG',0,0,imgWidth,imgHeight);
const fileName=`روشتة_${currentPatient.fullName}_${new Date().toLocaleDateString('ar-EG')}.pdf`;
doc.save(fileName);
alert('✅ تم إنشاء الروشتة بنجاح! تم حفظ الملف كـ PDF.');
}).catch(error=>{
console.error('خطأ في html2canvas:',error);
printContainer.style.display='none';
alert('حدث خطأ في إنشاء PDF. يرجى المحاولة مرة أخرى.');
});
},500);
}

function updatePatientPhone(){
if(currentPatient){
const phoneInput=document.getElementById('visitPhone');
if(phoneInput){
currentPatient.phone=phoneInput.value.trim();
const patientIndex=patients.findIndex(p=>p.id===currentPatient.id);
if(patientIndex!==-1){
patients[patientIndex].phone=currentPatient.phone;
saveToStorage();
}
}
}
}

function sendPrescriptionViaWhatsApp(){
if(currentPrescription.length===0){
alert('لا توجد أدوية في الروشتة للإرسال');
return;
}
if(!currentPatient.phone){
alert('لا يوجد رقم هاتف مسجل للمريض');
return;
}
const phoneNumber=currentPatient.phone.replace(/\D/g,'');
if(phoneNumber.length<10){
alert('رقم الهاتف غير صالح');
return;
}
generateWhatsAppPDF().then(pdfData=>{
const reader=new FileReader();
reader.onloadend=function(){
const base64PDF=reader.result.split(',')[1];
let message=`*روشتة طبية*\n`;
message+=`*الاسم:* ${currentPatient.fullName}\n`;
message+=`*رقم الملف:* ${currentPatient.fileNumber}\n`;
message+=`*العمر:* ${currentAgeDisplay}\n`;
message+=`*التاريخ:* ${new Date().toLocaleDateString('ar-EG')}\n\n`;
message+=`تم إرفاق الروشتة كملف PDF`;
const whatsappURL=`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
window.open(whatsappURL,'_blank');
};
reader.readAsDataURL(pdfData);
}).catch(error=>{
console.error('خطأ في إنشاء PDF:',error);
alert('حدث خطأ في إنشاء PDF للواتساب');
});
}

async function generateWhatsAppPDF(){
return new Promise((resolve,reject)=>{
try{
const nextVisitInput=document.getElementById('nextVisitDate');
let nextVisitDate='';
if(nextVisitInput&&nextVisitInput.value){
const date=new Date(nextVisitInput.value);
nextVisitDate=date.toLocaleDateString('ar-EG');
}
const printContainer=document.getElementById('printContainer');
document.getElementById('printName').textContent=currentPatient.fullName;
document.getElementById('printFileNo').textContent=currentPatient.fileNumber;
document.getElementById('printAge').textContent=currentAgeDisplay;
document.getElementById('printDate').textContent=new Date().toLocaleDateString('ar-EG');
document.getElementById('printClinicName').textContent=clinicSettings.clinicName;
document.getElementById('printDoctorName').textContent=clinicSettings.doctorName;
const medsContainer=document.getElementById('printMeds');
medsContainer.innerHTML='';
currentPrescription.forEach((med,index)=>{
const medDiv=document.createElement('div');
medDiv.style.marginBottom='15px';
medDiv.style.textAlign='center';
let doseText=med.dose;
if(med.ageUnit&&!doseText.includes(med.ageUnit)){
doseText+=' '+med.ageUnit;
}
const durationText=med.duration?med.duration:'';
const details=med.notes?`${doseText} ${med.frequency?med.frequency:''}${durationText?` ${durationText}`:''} - ${med.notes}`:`${doseText} ${med.frequency?med.frequency:''}${durationText?` ${durationText}`:''}`;
medDiv.innerHTML=`<div style="font-weight:bold;font-size:16px;margin-bottom:5px;color:#000;">R/ ${med.displayName||med.name}</div><div style="font-size:14px;color:#333;">${details}</div>`;
medsContainer.appendChild(medDiv);
});
if(additionalInstructions){
const instructionsDiv=document.createElement('div');
instructionsDiv.style.margin='30px 0';
instructionsDiv.style.padding='15px';
instructionsDiv.style.textAlign='right';
instructionsDiv.style.direction='rtl';
instructionsDiv.innerHTML=`${additionalInstructions}`;
medsContainer.appendChild(instructionsDiv);
}
const nextVisitDiv=document.getElementById('printNextVisitDate');
if(nextVisitDate){
nextVisitDiv.innerHTML=`<strong>ميعاد الزيارة القادمة:</strong> ${nextVisitDate}`;
nextVisitDiv.style.display='block';
}else{
nextVisitDiv.style.display='none';
}
printContainer.style.display='block';
setTimeout(()=>{
html2canvas(printContainer,{scale:2,useCORS:true,logging:false,backgroundColor:'#ffffff',allowTaint:true,removeContainer:false}).then(canvas=>{
printContainer.style.display='none';
const{jsPDF}=window.jspdf;
const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
const imgData=canvas.toDataURL('image/jpeg',1.0);
const pageWidth=doc.internal.pageSize.getWidth();
const pageHeight=doc.internal.pageSize.getHeight();
const imgWidth=pageWidth;
const imgHeight=(canvas.height*pageWidth)/canvas.width;
doc.addImage(imgData,'JPEG',0,0,imgWidth,imgHeight);
const pdfBlob=doc.output('blob');
resolve(pdfBlob);
}).catch(error=>{
printContainer.style.display='none';
reject(error);
});
},500);
}catch(error){
reject(error);
}
});
}

function searchPatients(){
const nameSearch=document.getElementById('searchPatient').value.toLowerCase();
const fileSearch=document.getElementById('searchFileNumber').value.toLowerCase();
const phoneSearch=document.getElementById('searchPhone').value.toLowerCase();
const filteredPatients=patients.filter(patient=>
(patient.fullName.toLowerCase().includes(nameSearch)||nameSearch==='')&&
(patient.fileNumber.toLowerCase().includes(fileSearch)||fileSearch==='')&&
(patient.phone&&patient.phone.includes(phoneSearch)||phoneSearch==='')
);
const tbody=document.getElementById('patientsList');
tbody.innerHTML='';
filteredPatients.forEach(patient=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${patient.fileNumber}</td><td>${patient.fullName}</td><td>${getAgeDisplay(patient)}</td><td>${patient.weight||'-'}</td><td>${patient.phone||'-'}</td><td><button class="action-btn record-btn" onclick="showPatientRecord(${patient.id})">السجل المرضي</button><button class="action-btn delete-btn" onclick="deletePatient(${patient.id})">حذف</button></td>`;
tbody.appendChild(tr);
});
}

function deletePatient(patientId){
if(confirm('هل أنت متأكد من حذف هذا المريض؟ سيتم حذف جميع زياراته أيضاً.')){
patients=patients.filter(p=>p.id!==patientId);
visits=visits.filter(v=>v.patientId!==patientId);
appointments=appointments.filter(a=>a.patientId!==patientId);
saveToStorage();
saveAppointments();
renderPatientsList();
updateStats();
alert('تم حذف المريض بنجاح!');
}
}

function renderMedicationsList(){
const tbody=document.getElementById('medicationsList');
tbody.innerHTML='';
medications.forEach(med=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${med.name}</td><td>${getMedicineTypeName(med.type)}</td><td>${med.concentration||0} ${med.concentrationUnit||''}</td><td>${med.dosePerKg||0} ${getArabicUnit(med.doseUnit||'')} / كجم</td><td>${med.frequency||'-'}</td><td><button class="action-btn edit-btn" onclick="editMedication(${med.id})">تعديل</button><button class="action-btn delete-btn" onclick="deleteMedication(${med.id})">حذف</button></td>`;
tbody.appendChild(tr);
});
}

function showAddMedicationModal(){
document.getElementById('addMedicationModal').style.display='block';
resetMedicationForm();
}

function updateMedicineFields(){
const type=document.getElementById('newMedType').value;
const volumeUnit=document.getElementById('newMedVolumeUnit');
const maxDoseUnit=document.getElementById('newMedMaxDoseUnit');
const volumeHelper=document.getElementById('volumeHelperText');
if(type==='Tab'||type==='Cap'||type==='Supp'||type==='Sachets'||type==='Oral Film'){
volumeUnit.value=type.toLowerCase();
volumeUnit.disabled=true;
maxDoseUnit.value=type.toLowerCase();
}else if(type==='cream'||type==='ointment'||type==='lotion'){
volumeUnit.value='gram';
volumeUnit.disabled=true;
maxDoseUnit.value='gram';
}else if(type==='Syrup'||type==='Suspension'||type==='Iv Fluid'){
volumeUnit.value='ml';
volumeUnit.disabled=false;
maxDoseUnit.value='ml';
}else if(type==='Ampule'||type==='Vial'){
volumeUnit.value='ml';
volumeUnit.disabled=false;
maxDoseUnit.value='ml';
}else{
volumeUnit.disabled=false;
maxDoseUnit.value='ml';
}
volumeHelper.textContent=type==='cream'||type==='ointment'||type==='lotion'?'سيتم عرض "دهان" كجرعة':'سيتم حساب الجرعة بناءً على هذا الحجم';
}

function updateVolumeField(){
const type=document.getElementById('newMedType').value;
const volumeUnit=document.getElementById('newMedVolumeUnit').value;
const volumeInput=document.getElementById('newMedVolume');
if(volumeUnit==='tab'||volumeUnit==='cap'||volumeUnit==='supp'||volumeUnit==='sachet'||volumeUnit==='oral film'){
volumeInput.value=1;
volumeInput.disabled=true;
}else{
volumeInput.disabled=false;
}
}

function resetMedicationForm(){
document.getElementById('newMedName').value='';
document.getElementById('newMedType').selectedIndex=0;
document.getElementById('newMedConcentration').value='';
document.getElementById('newMedConcentrationUnit').selectedIndex=0;
document.getElementById('newMedVolume').value='1';
document.getElementById('newMedVolumeUnit').selectedIndex=0;
document.getElementById('newMedScientificName').value='';
document.getElementById('newMedDose').value='';
document.getElementById('newMedDoseUnit').selectedIndex=0;
document.getElementById('newMedFrequency').selectedIndex=0;
document.getElementById('newMedDuration').selectedIndex=0;
document.getElementById('newMedDoseNotes').value='';
document.getElementById('newMedMaxDose').value='';
document.getElementById('newMedMaxDoseUnit').value='ml';
document.getElementById('doseCalculationType').value='weight';
document.getElementById('interactionsList').innerHTML='';
document.getElementById('interactionSearchResults').innerHTML='';
document.getElementById('interactionSearchResults').style.display='none';
currentInteractions=[];
ageDoseRows=[];
document.getElementById('ageDoseRows').innerHTML='';
toggleDoseCalculationType();
addDefaultAgeDoseRow();
}

function addDefaultAgeDoseRow(){
const container=document.getElementById('ageDoseRows');
const rowId='age-row-'+Date.now();
const row=document.createElement('div');
row.className='age-dose-row';
row.id=rowId;
row.innerHTML=`<div><label style="font-size:12px;">من عمر (سنوات)</label><input type="number" class="form-input" placeholder="0" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="0" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">إلى عمر (سنوات)</label><input type="number" class="form-input" placeholder="70" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="11" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">الجرعة</label><input type="number" class="form-input" placeholder="الجرعة" step="0.1" min="0" style="padding:6px;"></div><div><label style="font-size:12px;">تمييز الجرعة</label><select class="form-input" style="padding:6px;"><option value="ml">مل (ml)</option><option value="drops">نقطة (drops)</option><option value="tab">قرص (tab)</option><option value="cap">كبسولة (cap)</option><option value="supp">لبوسة (supp)</option><option value="gram">جرام (gram)</option><option value="sachet">كيس (sachet)</option><option value="oral film">لزقة في الفم (oral film)</option></select></div><div><label style="font-size:12px;">التكرار</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="كل 6 ساعات">كل 6 ساعات</option><option value="كل 8 ساعات">كل 8 ساعات</option><option value="كل 12 ساعة">كل 12 ساعة</option><option value="كل 24 ساعة">كل 24 ساعة</option></select></div><div><label style="font-size:12px;">المدة</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="لمدة 3 أيام">لمدة 3 أيام</option><option value="لمدة 5 أيام">لمدة 5 أيام</option><option value="لمدة اسبوع">لمدة اسبوع</option><option value="لمدة 10 أيام">لمدة 10 أيام</option></select></div><div><label style="font-size:12px;visibility:hidden;">إزالة</label><button type="button" class="remove-age-dose-btn" onclick="removeAgeDoseRowById('${rowId}')">-</button></div>`;
container.appendChild(row);
ageDoseRows.push(rowId);
}

function toggleDoseCalculationType(){
const type=document.getElementById('doseCalculationType').value;
const weightSection=document.getElementById('weightDoseSection');
const ageSection=document.getElementById('ageDoseSection');
if(type==='weight'){
weightSection.style.display='block';
ageSection.style.display='none';
}else{
weightSection.style.display='none';
ageSection.style.display='block';
}
}

function addAgeDoseRow(){
const container=document.getElementById('ageDoseRows');
const rowId='age-row-'+Date.now();
const row=document.createElement('div');
row.className='age-dose-row';
row.id=rowId;
row.innerHTML=`<div><label style="font-size:12px;">من عمر (سنوات)</label><input type="number" class="form-input" placeholder="0" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="0" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">إلى عمر (سنوات)</label><input type="number" class="form-input" placeholder="70" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="11" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">الجرعة</label><input type="number" class="form-input" placeholder="الجرعة" step="0.1" min="0" style="padding:6px;"></div><div><label style="font-size:12px;">تمييز الجرعة</label><select class="form-input" style="padding:6px;"><option value="ml">مل (ml)</option><option value="drops">نقطة (drops)</option><option value="tab">قرص (tab)</option><option value="cap">كبسولة (cap)</option><option value="supp">لبوسة (supp)</option><option value="gram">جرام (gram)</option><option value="sachet">كيس (sachet)</option><option value="oral film">لزقة في الفم (oral film)</option></select></div><div><label style="font-size:12px;">التكرار</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="كل 6 ساعات">كل 6 ساعات</option><option value="كل 8 ساعات">كل 8 ساعات</option><option value="كل 12 ساعة">كل 12 ساعة</option><option value="كل 24 ساعة">كل 24 ساعة</option></select></div><div><label style="font-size:12px;">المدة</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="لمدة 3 أيام">لمدة 3 أيام</option><option value="لمدة 5 أيام">لمدة 5 أيام</option><option value="لمدة اسبوع">لمدة اسبوع</option><option value="لمدة 10 أيام">لمدة 10 أيام</option></select></div><div><label style="font-size:12px;visibility:hidden;">إزالة</label><button type="button" class="remove-age-dose-btn" onclick="removeAgeDoseRowById('${rowId}')">-</button></div>`;
container.appendChild(row);
ageDoseRows.push(rowId);
}

function removeAgeDoseRow(button){
const row=button.closest('.age-dose-row');
if(row&&row.parentElement.children.length>1){
row.remove();
}
}

function removeAgeDoseRowById(rowId){
const row=document.getElementById(rowId);
if(row){
row.remove();
ageDoseRows=ageDoseRows.filter(id=>id!==rowId);
}
}

function addDrugInteraction(){
const searchInput=document.getElementById('interactionSearch');
const reasonInput=document.getElementById('interactionReason');
const scientificName=searchInput.value.trim();
const reason=reasonInput.value.trim();
if(!scientificName||!reason){
alert('الرجاء إدخال اسم المادة الفعالة وسبب التداخل');
return;
}
const selectedMed=medications.find(m=>m.scientificName===scientificName||m.name===scientificName);
if(!selectedMed){
alert('لم يتم العثور على الدواء في قاعدة البيانات');
return;
}
currentInteractions.push({
scientificName:selectedMed.scientificName||selectedMed.name,
reason:reason,
medId:selectedMed.id
});
updateInteractionsList();
searchInput.value='';
reasonInput.value='';
document.getElementById('interactionSearchResults').style.display='none';
}

function updateInteractionsList(){
const list=document.getElementById('interactionsList');
list.innerHTML='';
currentInteractions.forEach((interaction,index)=>{
const div=document.createElement('div');
div.className='interaction-item';
div.innerHTML=`<div class="interaction-item-header"><strong>${interaction.scientificName}</strong><button class="action-btn delete-btn" onclick="removeDrugInteraction(${index})">حذف</button></div><div class="interaction-item-details">${interaction.reason}</div>`;
list.appendChild(div);
});
}

function removeDrugInteraction(index){
currentInteractions.splice(index,1);
updateInteractionsList();
}

function addNewMedication(){
const name=document.getElementById('newMedName').value.trim();
const type=document.getElementById('newMedType').value;
const concentration=parseFloat(document.getElementById('newMedConcentration').value)||0;
const concentrationUnit=document.getElementById('newMedConcentrationUnit').value;
const volume=parseFloat(document.getElementById('newMedVolume').value)||1;
const volumeUnit=document.getElementById('newMedVolumeUnit').value;
const scientificName=document.getElementById('newMedScientificName').value.trim();
const doseCalculationType=document.getElementById('doseCalculationType').value;
if(!name||!type){
alert('الرجاء إدخال اسم الدواء ونوعه');
return;
}
const medication={
id:Date.now(),
name:name,
type:type,
concentration:concentration,
concentrationUnit:concentrationUnit,
volume:volume,
volumeUnit:volumeUnit,
scientificName:scientificName,
doseCalculationType:doseCalculationType,
interactions:[...currentInteractions],
createdAt:new Date().toISOString()
};
if(doseCalculationType==='weight'){
medication.dosePerKg=parseFloat(document.getElementById('newMedDose').value)||0;
medication.doseUnit=document.getElementById('newMedDoseUnit').value;
medication.frequency=document.getElementById('newMedFrequency').value;
medication.duration=document.getElementById('newMedDuration').value;
medication.doseNotes=document.getElementById('newMedDoseNotes').value.trim();
}else{
medication.ageDoses=[];
document.querySelectorAll('#ageDoseRows .age-dose-row').forEach(row=>{
const inputs=row.querySelectorAll('input');
const selects=row.querySelectorAll('select');
const fromYears=parseInt(inputs[0].value)||0;
const fromMonths=parseInt(inputs[1].value)||0;
const toYears=parseInt(inputs[2].value)||70;
const toMonths=parseInt(inputs[3].value)||11;
const dose=parseFloat(inputs[4].value)||0;
const unit=selects[0].value||'ml';
const frequency=selects[1].value||'';
const duration=selects[2].value||'';
medication.ageDoses.push({
fromYears:fromYears,
fromMonths:fromMonths,
toYears:toYears,
toMonths:toMonths,
dose:dose,
unit:unit,
frequency:frequency,
duration:duration
});
});
}
medication.maxDose=parseFloat(document.getElementById('newMedMaxDose').value)||0;
medication.maxDoseUnit=document.getElementById('newMedMaxDoseUnit').value;
medications.push(medication);
saveToStorage();
renderMedicationsList();
updateStats();
alert('تم إضافة الدواء بنجاح!');
closeModal('addMedicationModal');
}

function showEditMedicationModal(){
document.getElementById('editMedicationModal').style.display='block';
searchMedicationsEdit();
}

function searchMedicationsEdit(){
const searchTerm=document.getElementById('searchMedication').value.toLowerCase();
const listDiv=document.getElementById('medicationEditList');
const filteredMeds=medications.filter(med=>
med.name.toLowerCase().includes(searchTerm)||
(med.scientificName&&med.scientificName.toLowerCase().includes(searchTerm))
);
let content='';
if(filteredMeds.length===0){
content='<p style="text-align:center;color:#666;padding:20px;">لا توجد نتائج</p>';
}else{
filteredMeds.forEach(med=>{
content+=`<div class="medication-edit-item"><div><strong>${med.name}</strong><div style="font-size:12px;color:#666;">${getMedicineTypeName(med.type)} - ${med.concentration||0}${med.concentrationUnit||''}</div></div><div><button class="action-btn edit-btn" onclick="editMedication(${med.id})">تعديل</button><button class="action-btn delete-btn" onclick="deleteMedication(${med.id})">حذف</button></div></div>`;
});
}
listDiv.innerHTML=content;
}

function editMedication(id){
editingMedicationId=id;
const med=medications.find(m=>m.id===id);
if(!med)return;
document.getElementById('editMedName').value=med.name;
document.getElementById('editMedType').value=med.type;
document.getElementById('editMedConcentration').value=med.concentration||'';
document.getElementById('editMedConcentrationUnit').value=med.concentrationUnit||'';
document.getElementById('editMedVolume').value=med.volume||1;
document.getElementById('editMedVolumeUnit').value=med.volumeUnit||'';
document.getElementById('editMedScientificName').value=med.scientificName||'';
document.getElementById('editDoseCalculationType').value=med.doseCalculationType||'weight';
document.getElementById('editMedMaxDose').value=med.maxDose||'';
document.getElementById('editMedMaxDoseUnit').value=med.maxDoseUnit||'ml';
currentEditInteractions=med.interactions||[];
updateEditInteractionsList();
if(med.doseCalculationType==='weight'){
document.getElementById('editMedDose').value=med.dosePerKg||'';
document.getElementById('editMedDoseUnit').value=med.doseUnit||'';
document.getElementById('editMedFrequency').value=med.frequency||'';
document.getElementById('editMedDuration').value=med.duration||'';
document.getElementById('editMedDoseNotes').value=med.doseNotes||'';
}else{
editAgeDoseRows=med.ageDoses||[];
updateEditAgeDoseRows();
}
toggleEditDoseCalculationType();
document.getElementById('editSingleMedModal').style.display='block';
}

function updateEditAgeDoseRows(){
const container=document.getElementById('editAgeDoseRows');
container.innerHTML='';
editAgeDoseRows.forEach((dose,index)=>{
const rowId='edit-age-row-'+Date.now()+index;
const row=document.createElement('div');
row.className='age-dose-row';
row.id=rowId;
row.innerHTML=`<div><label style="font-size:12px;">من عمر (سنوات)</label><input type="number" class="form-input" value="${dose.fromYears||0}" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" value="${dose.fromMonths||0}" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">إلى عمر (سنوات)</label><input type="number" class="form-input" value="${dose.toYears||70}" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" value="${dose.toMonths||11}" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">الجرعة</label><input type="number" class="form-input" value="${dose.dose||0}" step="0.1" min="0" style="padding:6px;"></div><div><label style="font-size:12px;">تمييز الجرعة</label><select class="form-input" style="padding:6px;"><option value="ml" ${dose.unit==='ml'?'selected':''}>مل (ml)</option><option value="drops" ${dose.unit==='drops'?'selected':''}>نقطة (drops)</option><option value="tab" ${dose.unit==='tab'?'selected':''}>قرص (tab)</option><option value="cap" ${dose.unit==='cap'?'selected':''}>كبسولة (cap)</option><option value="supp" ${dose.unit==='supp'?'selected':''}>لبوسة (supp)</option><option value="gram" ${dose.unit==='gram'?'selected':''}>جرام (gram)</option><option value="sachet" ${dose.unit==='sachet'?'selected':''}>كيس (sachet)</option><option value="oral film" ${dose.unit==='oral film'?'selected':''}>لزقة في الفم (oral film)</option></select></div><div><label style="font-size:12px;">التكرار</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="كل 6 ساعات" ${dose.frequency==='كل 6 ساعات'?'selected':''}>كل 6 ساعات</option><option value="كل 8 ساعات" ${dose.frequency==='كل 8 ساعات'?'selected':''}>كل 8 ساعات</option><option value="كل 12 ساعة" ${dose.frequency==='كل 12 ساعة'?'selected':''}>كل 12 ساعة</option><option value="كل 24 ساعة" ${dose.frequency==='كل 24 ساعة'?'selected':''}>كل 24 ساعة</option></select></div><div><label style="font-size:12px;">المدة</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="لمدة 3 أيام" ${dose.duration==='لمدة 3 أيام'?'selected':''}>لمدة 3 أيام</option><option value="لمدة 5 أيام" ${dose.duration==='لمدة 5 أيام'?'selected':''}>لمدة 5 أيام</option><option value="لمدة اسبوع" ${dose.duration==='لمدة اسبوع'?'selected':''}>لمدة اسبوع</option><option value="لمدة 10 أيام" ${dose.duration==='لمدة 10 أيام'?'selected':''}>لمدة 10 أيام</option></select></div><div><label style="font-size:12px;visibility:hidden;">إزالة</label><button type="button" class="remove-age-dose-btn" onclick="removeEditAgeDoseRowById('${rowId}')">-</button></div>`;
container.appendChild(row);
});
}

function addEditAgeDoseRow(){
const container=document.getElementById('editAgeDoseRows');
const rowId='edit-age-row-'+Date.now();
const row=document.createElement('div');
row.className='age-dose-row';
row.id=rowId;
row.innerHTML=`<div><label style="font-size:12px;">من عمر (سنوات)</label><input type="number" class="form-input" placeholder="0" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="0" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">إلى عمر (سنوات)</label><input type="number" class="form-input" placeholder="70" min="0" max="70" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">(شهور)</label><input type="number" class="form-input" placeholder="11" min="0" max="11" step="1" style="padding:6px;"></div><div><label style="font-size:12px;">الجرعة</label><input type="number" class="form-input" placeholder="الجرعة" step="0.1" min="0" style="padding:6px;"></div><div><label style="font-size:12px;">تمييز الجرعة</label><select class="form-input" style="padding:6px;"><option value="ml">مل (ml)</option><option value="drops">نقطة (drops)</option><option value="tab">قرص (tab)</option><option value="cap">كبسولة (cap)</option><option value="supp">لبوسة (supp)</option><option value="gram">جرام (gram)</option><option value="sachet">كيس (sachet)</option><option value="oral film">لزقة في الفم (oral film)</option></select></div><div><label style="font-size:12px;">التكرار</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="كل 6 ساعات">كل 6 ساعات</option><option value="كل 8 ساعات">كل 8 ساعات</option><option value="كل 12 ساعة">كل 12 ساعة</option><option value="كل 24 ساعة">كل 24 ساعة</option></select></div><div><label style="font-size:12px;">المدة</label><select class="form-input" style="padding:6px;"><option value="">اختر</option><option value="لمدة 3 أيام">لمدة 3 أيام</option><option value="لمدة 5 أيام">لمدة 5 أيام</option><option value="لمدة اسبوع">لمدة اسبوع</option><option value="لمدة 10 أيام">لمدة 10 أيام</option></select></div><div><label style="font-size:12px;visibility:hidden;">إزالة</label><button type="button" class="remove-age-dose-btn" onclick="removeEditAgeDoseRowById('${rowId}')">-</button></div>`;
container.appendChild(row);
}

function removeEditAgeDoseRowById(rowId){
const row=document.getElementById(rowId);
if(row){
row.remove();
}
}

function toggleEditDoseCalculationType(){
const type=document.getElementById('editDoseCalculationType').value;
const weightSection=document.getElementById('editWeightDoseSection');
const ageSection=document.getElementById('editAgeDoseSection');
if(type==='weight'){
weightSection.style.display='block';
ageSection.style.display='none';
}else{
weightSection.style.display='none';
ageSection.style.display='block';
}
}

function updateEditInteractionsList(){
const list=document.getElementById('editInteractionsList');
list.innerHTML='';
currentEditInteractions.forEach((interaction,index)=>{
const div=document.createElement('div');
div.className='interaction-item';
div.innerHTML=`<div class="interaction-item-header"><strong>${interaction.scientificName}</strong><button class="action-btn delete-btn" onclick="removeEditDrugInteraction(${index})">حذف</button></div><div class="interaction-item-details">${interaction.reason}</div>`;
list.appendChild(div);
});
}

function addEditDrugInteraction(){
const searchInput=document.getElementById('editInteractionSearch');
const reasonInput=document.getElementById('editInteractionReason');
const scientificName=searchInput.value.trim();
const reason=reasonInput.value.trim();
if(!scientificName||!reason){
alert('الرجاء إدخال اسم المادة الفعالة وسبب التداخل');
return;
}
const selectedMed=medications.find(m=>m.scientificName===scientificName||m.name===scientificName);
if(!selectedMed){
alert('لم يتم العثور على الدواء في قاعدة البيانات');
return;
}
currentEditInteractions.push({
scientificName:selectedMed.scientificName||selectedMed.name,
reason:reason,
medId:selectedMed.id
});
updateEditInteractionsList();
searchInput.value='';
reasonInput.value='';
document.getElementById('editInteractionSearchResults').style.display='none';
}

function removeEditDrugInteraction(index){
currentEditInteractions.splice(index,1);
updateEditInteractionsList();
}

function updateEditMedicineFields(){
const type=document.getElementById('editMedType').value;
const volumeUnit=document.getElementById('editMedVolumeUnit');
const maxDoseUnit=document.getElementById('editMedMaxDoseUnit');
if(type==='Tab'||type==='Cap'||type==='Supp'||type==='Sachets'||type==='Oral Film'){
volumeUnit.value=type.toLowerCase();
volumeUnit.disabled=true;
maxDoseUnit.value=type.toLowerCase();
}else if(type==='cream'||type==='ointment'||type==='lotion'){
volumeUnit.value='gram';
volumeUnit.disabled=true;
maxDoseUnit.value='gram';
}else if(type==='Syrup'||type==='Suspension'||type==='Iv Fluid'){
volumeUnit.value='ml';
volumeUnit.disabled=false;
maxDoseUnit.value='ml';
}else if(type==='Ampule'||type==='Vial'){
volumeUnit.value='ml';
volumeUnit.disabled=false;
maxDoseUnit.value='ml';
}else{
volumeUnit.disabled=false;
maxDoseUnit.value='ml';
}
}

function updateEditVolumeField(){
const type=document.getElementById('editMedType').value;
const volumeUnit=document.getElementById('editMedVolumeUnit').value;
const volumeInput=document.getElementById('editMedVolume');
if(volumeUnit==='tab'||volumeUnit==='cap'||volumeUnit==='supp'||volumeUnit==='sachet'||volumeUnit==='oral film'){
volumeInput.value=1;
volumeInput.disabled=true;
}else{
volumeInput.disabled=false;
}
}

function updateMedication(){
const medIndex=medications.findIndex(m=>m.id===editingMedicationId);
if(medIndex===-1)return;
const name=document.getElementById('editMedName').value.trim();
const type=document.getElementById('editMedType').value;
const concentration=parseFloat(document.getElementById('editMedConcentration').value)||0;
const concentrationUnit=document.getElementById('editMedConcentrationUnit').value;
const volume=parseFloat(document.getElementById('editMedVolume').value)||1;
const volumeUnit=document.getElementById('editMedVolumeUnit').value;
const scientificName=document.getElementById('editMedScientificName').value.trim();
const doseCalculationType=document.getElementById('editDoseCalculationType').value;
if(!name||!type){
alert('الرجاء إدخال اسم الدواء ونوعه');
return;
}
const updatedMed={
...medications[medIndex],
name:name,
type:type,
concentration:concentration,
concentrationUnit:concentrationUnit,
volume:volume,
volumeUnit:volumeUnit,
scientificName:scientificName,
doseCalculationType:doseCalculationType,
interactions:[...currentEditInteractions],
updatedAt:new Date().toISOString()
};
if(doseCalculationType==='weight'){
updatedMed.dosePerKg=parseFloat(document.getElementById('editMedDose').value)||0;
updatedMed.doseUnit=document.getElementById('editMedDoseUnit').value;
updatedMed.frequency=document.getElementById('editMedFrequency').value;
updatedMed.duration=document.getElementById('editMedDuration').value;
updatedMed.doseNotes=document.getElementById('editMedDoseNotes').value.trim();
delete updatedMed.ageDoses;
}else{
updatedMed.ageDoses=[];
document.querySelectorAll('#editAgeDoseRows .age-dose-row').forEach(row=>{
const inputs=row.querySelectorAll('input');
const selects=row.querySelectorAll('select');
const fromYears=parseInt(inputs[0].value)||0;
const fromMonths=parseInt(inputs[1].value)||0;
const toYears=parseInt(inputs[2].value)||70;
const toMonths=parseInt(inputs[3].value)||11;
const dose=parseFloat(inputs[4].value)||0;
const unit=selects[0].value||'ml';
const frequency=selects[1].value||'';
const duration=selects[2].value||'';
updatedMed.ageDoses.push({
fromYears:fromYears,
fromMonths:fromMonths,
toYears:toYears,
toMonths:toMonths,
dose:dose,
unit:unit,
frequency:frequency,
duration:duration
});
});
delete updatedMed.dosePerKg;
delete updatedMed.doseUnit;
delete updatedMed.frequency;
delete updatedMed.duration;
delete updatedMed.doseNotes;
}
updatedMed.maxDose=parseFloat(document.getElementById('editMedMaxDose').value)||0;
updatedMed.maxDoseUnit=document.getElementById('editMedMaxDoseUnit').value;
medications[medIndex]=updatedMed;
saveToStorage();
renderMedicationsList();
alert('تم تحديث الدواء بنجاح!');
closeModal('editSingleMedModal');
}

function deleteMedication(medId){
if(confirm('هل أنت متأكد من حذف هذا الدواء؟')){
medications=medications.filter(m=>m.id!==medId);
saveToStorage();
renderMedicationsList();
updateStats();
alert('تم حذف الدواء بنجاح!');
}
}

function updateStats(){
document.getElementById('totalPatients').textContent=patients.length;
document.getElementById('totalMedications').textContent=medications.length;
const today=new Date().toLocaleDateString('ar-EG');
const todayVisits=visits.filter(v=>v.date===today);
document.getElementById('todayVisits').textContent=todayVisits.length;
}

function showFormatPrescriptionModal(){
if(currentPrescription.length===0){
alert('لا توجد أدوية في الروشتة لتنسيقها');
return;
}
updateFormattingContainer();
document.getElementById('formatPrescriptionModal').style.display='block';
loadFormatTemplates();
updateFormattingPreview();
}

function updateFormattingContainer(){
const formattingContainer=document.getElementById('formattingContainer');
if(!formattingContainer||!currentPatient)return;
const defaultFormat=prescriptionFormats.find(f=>f.isDefault)||prescriptionFormats[0]||currentFormat;
let content='';
content+=`<div style="text-align:center;margin-bottom:30px;font-family:'${defaultFormat.fontFamily||'Cairo'}';font-size:${defaultFormat.fontSize||'16px'};color:${defaultFormat.fontColor||'#000000'}"><div style="display:flex;justify-content:space-around;margin-bottom:15px;"><div><strong>الاسم:</strong> ${currentPatient.fullName}</div><div><strong>رقم الملف:</strong> ${currentPatient.fileNumber}</div></div><div style="display:flex;justify-content:space-around;"><div><strong>العمر:</strong> ${currentAgeDisplay}</div><div><strong>تاريخ الزيارة:</strong> ${new Date().toLocaleDateString('ar-EG')}</div></div></div><hr style="border:1px solid #ccc;margin:20px 0;"><div style="text-align:center;margin:30px 0;">`;
currentPrescription.forEach((med,index)=>{
let doseText=med.dose;
if(med.ageUnit&&!doseText.includes(med.ageUnit)){
doseText+=' '+med.ageUnit;
}
const durationText=med.duration?med.duration:'';
content+=`<div style="margin-bottom:20px;"><div style="font-weight:bold;font-size:${parseInt(defaultFormat.fontSize||16)+2}px;margin-bottom:5px;color:${defaultFormat.fontColor||'#000000'}">R/ ${med.displayName||med.name}</div><div style="color:#555;font-size:${defaultFormat.fontSize||'16px'}">${doseText} ${med.frequency?med.frequency:''}${durationText?` ${durationText}`:''} ${med.notes?' - '+med.notes:''}</div></div>`;
});
content+=`</div>`;
if(additionalInstructions){
content+=`<div style="margin:40px 0;padding:20px;text-align:right;font-size:${defaultFormat.fontSize||'16px'};direction:rtl"><strong>تعليمات إضافية:</strong><br>${additionalInstructions}</div>`;
}
if(showNextVisitInFormat){
const nextVisitInput=document.getElementById('nextVisitDate');
if(nextVisitInput&&nextVisitInput.value){
const date=new Date(nextVisitInput.value);
content+=`<div style="text-align:right;margin:20px 0;font-size:14px;direction:rtl"><strong>ميعاد الزيارة القادمة:</strong> ${date.toLocaleDateString('ar-EG')}</div>`;
}
}
if(showSignatureInFormat){
content+=`<div style="text-align:right;margin:20px 0;direction:rtl"><div style="border-top:1px solid #000;width:200px;margin-right:0;margin-left:auto;padding-top:5px;"><strong>${clinicSettings.clinicName}</strong><br>${clinicSettings.doctorName}</div></div>`;
}
formattingContainer.innerHTML=content;
formattingContainer.style.fontFamily=defaultFormat.fontFamily||'Cairo';
formattingContainer.style.fontSize=defaultFormat.fontSize||'16px';
formattingContainer.style.color=defaultFormat.fontColor||'#000000';
updateFormattingPreview();
}

function applyFormat(command,value=null){
const container=document.getElementById('formattingContainer');
if(!container)return;
try{
document.execCommand('styleWithCSS',false,true);
if(command==='fontSize'){
document.execCommand('fontSize',false,value);
}else if(command==='foreColor'){
document.execCommand('foreColor',false,value);
}else if(command==='fontFamily'){
document.execCommand('fontName',false,value);
}else{
document.execCommand(command,false,value);
}
updateFormattingPreview();
saveCurrentFormatState();
}catch(error){
console.error('خطأ في تطبيق التنسيق:',error);
}
}

function toggleBold(){
applyFormat('bold');
}

function toggleItalic(){
applyFormat('italic');
}

function toggleUnderline(){
applyFormat('underline');
}

function toggleSignature(){
showSignatureInFormat=!showSignatureInFormat;
updateFormattingContainer();
updateFormattingPreview();
}

function toggleNextVisit(){
showNextVisitInFormat=!showNextVisitInFormat;
updateFormattingContainer();
updateFormattingPreview();
}

function updateFormattingPreview(){
const boldBtn=document.getElementById('boldBtn');
const italicBtn=document.getElementById('italicBtn');
const underlineBtn=document.getElementById('underlineBtn');
const signatureBtn=document.getElementById('signatureBtn');
const nextVisitBtn=document.getElementById('nextVisitBtn');
if(boldBtn){
boldBtn.classList.toggle('active',document.queryCommandState('bold'));
}
if(italicBtn){
italicBtn.classList.toggle('active',document.queryCommandState('italic'));
}
if(underlineBtn){
underlineBtn.classList.toggle('active',document.queryCommandState('underline'));
}
if(signatureBtn){
signatureBtn.classList.toggle('active',showSignatureInFormat);
}
if(nextVisitBtn){
nextVisitBtn.classList.toggle('active',showNextVisitInFormat);
}
}

function updatePrintMargins(){
currentFormat.topMargin=parseInt(document.getElementById('topMargin').value)||20;
currentFormat.bottomMargin=parseInt(document.getElementById('bottomMargin').value)||20;
currentFormat.leftMargin=parseInt(document.getElementById('leftMargin').value)||15;
currentFormat.rightMargin=parseInt(document.getElementById('rightMargin').value)||15;
}

function saveCurrentFormat(){
const formatName=document.getElementById('newFormatName').value.trim();
if(!formatName){
alert('الرجاء إدخال اسم للتنسيق');
return;
}
const format={
id:Date.now(),
name:formatName,
fontFamily:document.getElementById('fontFamily').value,
fontSize:document.getElementById('fontSize').value,
fontColor:document.getElementById('fontColor').value,
lineHeight:'1.5',
topMargin:currentFormat.topMargin,
bottomMargin:currentFormat.bottomMargin,
leftMargin:currentFormat.leftMargin,
rightMargin:currentFormat.rightMargin,
content:document.getElementById('formattingContainer').innerHTML,
isDefault:false,
createdAt:new Date().toISOString()
};
const existingIndex=prescriptionFormats.findIndex(f=>f.name===formatName);
if(existingIndex!==-1){
if(confirm('يوجد تنسيق بنفس الاسم. هل تريد استبداله؟')){
prescriptionFormats[existingIndex]=format;
}else{
return;
}
}else{
prescriptionFormats.push(format);
}
localStorage.setItem('prescriptionFormats',JSON.stringify(prescriptionFormats));
loadFormatTemplates();
alert('تم حفظ التنسيق بنجاح!');
document.getElementById('newFormatName').value='';
}

function loadFormatTemplates(){
const select=document.getElementById('savedFormats');
select.innerHTML='<option value="">اختر تنسيق محفوظ</option>';
prescriptionFormats.forEach(format=>{
const option=document.createElement('option');
option.value=format.id;
option.textContent=format.name+(format.isDefault?' ⭐ (افتراضي)':'');
select.appendChild(option);
});
}

function loadFormatTemplate(){
const select=document.getElementById('savedFormats');
const formatId=parseInt(select.value);
if(!formatId)return;
const format=prescriptionFormats.find(f=>f.id===formatId);
if(!format)return;
document.getElementById('fontFamily').value=format.fontFamily||'Cairo';
document.getElementById('fontSize').value=parseInt(format.fontSize)||16;
document.getElementById('fontColor').value=format.fontColor||'#000000';
document.getElementById('topMargin').value=format.topMargin||20;
document.getElementById('bottomMargin').value=format.bottomMargin||20;
document.getElementById('leftMargin').value=format.leftMargin||15;
document.getElementById('rightMargin').value=format.rightMargin||15;
currentFormat={...format};
document.getElementById('formattingContainer').innerHTML=format.content;
updateFormattingPreview();
alert('تم تحميل التنسيق: '+format.name);
}

function deleteFormat(){
const select=document.getElementById('savedFormats');
const formatId=parseInt(select.value);
if(!formatId){
alert('الرجاء اختيار تنسيق لحذفه');
return;
}
if(confirm('هل أنت متأكد من حذف هذا التنسيق؟')){
prescriptionFormats=prescriptionFormats.filter(f=>f.id!==formatId);
localStorage.setItem('prescriptionFormats',JSON.stringify(prescriptionFormats));
loadFormatTemplates();
alert('تم حذف التنسيق بنجاح');
}
}

function setAsDefaultFormat(){
const select=document.getElementById('savedFormats');
const formatId=parseInt(select.value);
if(!formatId){
alert('الرجاء اختيار تنسيق لتعيينه كافتراضي');
return;
}
prescriptionFormats.forEach(format=>{
format.isDefault=false;
});
const format=prescriptionFormats.find(f=>f.id===formatId);
if(format){
format.isDefault=true;
localStorage.setItem('prescriptionFormats',JSON.stringify(prescriptionFormats));
localStorage.setItem('defaultPrintFormat',JSON.stringify(format));
loadFormatTemplates();
alert('تم تعيين التنسيق كافتراضي للطباعة المباشرة!');
}
}

function restoreSystemDefaultFormat(){
if(confirm('هل تريد استعادة تنسيق النظام الافتراضي؟ سيتم حذف أي تنسيق افتراضي آخر.')){
prescriptionFormats.forEach(format=>{
format.isDefault=false;
});
const defaultSystemFormat={
id:1,
name:'التنسيق الافتراضي',
fontFamily:'Cairo',
fontSize:'16',
fontColor:'#000000',
lineHeight:'1.5',
topMargin:20,
bottomMargin:20,
leftMargin:15,
rightMargin:15,
content:'',
isDefault:true,
createdAt:new Date().toISOString()
};
const existingIndex=prescriptionFormats.findIndex(f=>f.id===1);
if(existingIndex!==-1){
prescriptionFormats[existingIndex]=defaultSystemFormat;
}else{
prescriptionFormats.push(defaultSystemFormat);
}
localStorage.setItem('prescriptionFormats',JSON.stringify(prescriptionFormats));
localStorage.removeItem('defaultPrintFormat');
loadFormatTemplates();
document.getElementById('fontFamily').value=defaultSystemFormat.fontFamily;
document.getElementById('fontSize').value=defaultSystemFormat.fontSize;
document.getElementById('fontColor').value=defaultSystemFormat.fontColor;
document.getElementById('topMargin').value=defaultSystemFormat.topMargin;
document.getElementById('bottomMargin').value=defaultSystemFormat.bottomMargin;
document.getElementById('leftMargin').value=defaultSystemFormat.leftMargin;
document.getElementById('rightMargin').value=defaultSystemFormat.rightMargin;
currentFormat={...defaultSystemFormat};
updateFormattingContainer();
alert('تم استعادة تنسيق النظام الافتراضي بنجاح!');
}
}

function clearFormatting(){
const container=document.getElementById('formattingContainer');
container.innerHTML=container.innerText;
updateFormattingPreview();
}

function setQuickColor(color){
document.getElementById('fontColor').value=color;
applyFormat('foreColor',color);
}

function insertImageIntoFormat(){
document.getElementById('imageInsertInput').click();
document.getElementById('imageInsertInput').onchange=function(e){
if(e.target.files&&e.target.files[0]){
const reader=new FileReader();
reader.onload=function(e){
const img=new Image();
img.src=e.target.result;
img.className='resizable';
img.style.maxWidth='100%';
img.style.cursor='move';
img.onload=function(){
const formattingContainer=document.getElementById('formattingContainer');
const sel=window.getSelection();
const range=sel.getRangeAt(0);
range.insertNode(img);
range.collapse(false);
sel.removeAllRanges();
sel.addRange(range);
addImageHandles(img);
};
};
reader.readAsDataURL(e.target.files[0]);
}
};
}

function addImageHandles(img){
const handles=['top-left','top-right','bottom-left','bottom-right'];
handles.forEach(pos=>{
const handle=document.createElement('div');
handle.className=`resize-handle ${pos}`;
handle.style.position='absolute';
if(pos==='top-left'){handle.style.top='-4px';handle.style.left='-4px';}
if(pos==='top-right'){handle.style.top='-4px';handle.style.right='-4px';}
if(pos==='bottom-left'){handle.style.bottom='-4px';handle.style.left='-4px';}
if(pos==='bottom-right'){handle.style.bottom='-4px';handle.style.right='-4px';}
handle.addEventListener('mousedown',startResize);
img.parentNode.appendChild(handle);
imageHandles.push(handle);
});
const rotateHandle=document.createElement('div');
rotateHandle.className='rotate-handle';
rotateHandle.style.position='absolute';
rotateHandle.style.top='-25px';
rotateHandle.style.left='50%';
rotateHandle.style.transform='translateX(-50%)';
rotateHandle.addEventListener('mousedown',startRotate);
img.parentNode.appendChild(rotateHandle);
imageHandles.push(rotateHandle);
img.addEventListener('click',function(e){
e.stopPropagation();
selectImage(img);
});
img.isSelected=true;
selectImage(img);
}

function selectImage(img){
document.querySelectorAll('#formattingContainer img.resizable').forEach(i=>{
i.classList.remove('selected');
i.isSelected=false;
});
img.classList.add('selected');
img.isSelected=true;
resizingImage=img;
}

function startResize(e){
e.preventDefault();
e.stopPropagation();
const img=e.target.parentNode.querySelector('img');
if(!img)return;
const startX=e.clientX;
const startY=e.clientY;
const startWidth=parseInt(getComputedStyle(img).width);
const startHeight=parseInt(getComputedStyle(img).height);
const handlePos=e.target.className.split(' ')[1];
function resize(e){
const dx=e.clientX-startX;
const dy=e.clientY-startY;
let newWidth=startWidth;
let newHeight=startHeight;
if(handlePos.includes('left')){
newWidth=Math.max(50,startWidth-dx);
img.style.left=(parseInt(img.style.left)||0)+dx+'px';
}
if(handlePos.includes('right')){
newWidth=Math.max(50,startWidth+dx);
}
if(handlePos.includes('top')){
newHeight=Math.max(50,startHeight-dy);
img.style.top=(parseInt(img.style.top)||0)+dy+'px';
}
if(handlePos.includes('bottom')){
newHeight=Math.max(50,startHeight+dy);
}
img.style.width=newWidth+'px';
img.style.height=newHeight+'px';
}
function stopResize(){
document.removeEventListener('mousemove',resize);
document.removeEventListener('mouseup',stopResize);
}
document.addEventListener('mousemove',resize);
document.addEventListener('mouseup',stopResize);
}

function startRotate(e){
e.preventDefault();
e.stopPropagation();
const img=e.target.parentNode.querySelector('img');
if(!img)return;
const rect=img.getBoundingClientRect();
const centerX=rect.left+rect.width/2;
const centerY=rect.top+rect.height/2;
let startAngle=Math.atan2(e.clientY-centerY,e.clientX-centerX);
let currentRotation=parseFloat(img.style.transform.replace('rotate(','').replace('deg)',''))||0;
function rotate(e){
const currentAngle=Math.atan2(e.clientY-centerY,e.clientX-centerX);
const angleDiff=currentAngle-startAngle;
const newRotation=(currentRotation+angleDiff*700/Math.PI)%360;
img.style.transform=`rotate(${newRotation}deg)`;
}
function stopRotate(){
document.removeEventListener('mousemove',rotate);
document.removeEventListener('mouseup',stopRotate);
}
document.addEventListener('mousemove',rotate);
document.addEventListener('mouseup',stopRotate);
}

function saveCurrentFormatState(){
const format={
id:Date.now(),
name:'تنسيق غير محفوظ',
fontFamily:document.getElementById('fontFamily').value,
fontSize:document.getElementById('fontSize').value,
fontColor:document.getElementById('fontColor').value,
lineHeight:'1.5',
topMargin:currentFormat.topMargin,
bottomMargin:currentFormat.bottomMargin,
leftMargin:currentFormat.leftMargin,
rightMargin:currentFormat.rightMargin,
content:document.getElementById('formattingContainer').innerHTML,
isDefault:false,
createdAt:new Date().toISOString()
};
localStorage.setItem('currentFormatTemp',JSON.stringify(format));
}

function generateFormattedPDF(){
const content=document.getElementById('formattingContainer').innerHTML;
html2canvas(document.getElementById('formattingContainer'),{scale:2,useCORS:true,logging:false,backgroundColor:'#ffffff'}).then(canvas=>{
const{jsPDF}=window.jspdf;
const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
const imgData=canvas.toDataURL('image/jpeg',1.0);
const pageWidth=doc.internal.pageSize.getWidth();
const pageHeight=doc.internal.pageSize.getHeight();
const imgWidth=pageWidth-(currentFormat.leftMargin+currentFormat.rightMargin);
const imgHeight=(canvas.height*imgWidth)/canvas.width;
let yPos=currentFormat.topMargin;
if(imgHeight>(pageHeight-currentFormat.topMargin-currentFormat.bottomMargin)){
let remainingHeight=imgHeight;
let currentY=yPos;
while(remainingHeight>0){
const pageImgHeight=Math.min(remainingHeight,pageHeight-currentFormat.topMargin-currentFormat.bottomMargin);
const tempCanvas=document.createElement('canvas');
tempCanvas.width=canvas.width;
tempCanvas.height=(pageImgHeight/imgHeight)*canvas.height;
const ctx=tempCanvas.getContext('2d');
const sourceY=((imgHeight-remainingHeight)/imgHeight)*canvas.height;
ctx.drawImage(canvas,0,sourceY,canvas.width,tempCanvas.height,0,0,canvas.width,tempCanvas.height);
const pageImgData=tempCanvas.toDataURL('image/jpeg',1.0);
doc.addImage(pageImgData,'JPEG',currentFormat.leftMargin,currentY,imgWidth,pageImgHeight);
remainingHeight-=pageImgHeight;
currentY=currentFormat.topMargin;
if(remainingHeight>0){
doc.addPage();
}
}
}else{
doc.addImage(imgData,'JPEG',currentFormat.leftMargin,yPos,imgWidth,imgHeight);
}
const fileName=`روشتة_${currentPatient.fullName}_${new Date().toLocaleDateString('ar-EG')}.pdf`;
doc.save(fileName);
alert('✅ تم إنشاء PDF بنجاح!');
}).catch(error=>{
console.error('خطأ في html2canvas:',error);
alert('حدث خطأ في إنشاء PDF. يرجى المحاولة مرة أخرى.');
});
}

function printCurrentFormatPreview(){
const content=document.getElementById('formattingContainer').innerHTML;
const printWindow=window.open('','_blank');
const printContent=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>@page {margin: ${currentFormat.topMargin}mm ${currentFormat.rightMargin}mm ${currentFormat.bottomMargin}mm ${currentFormat.leftMargin}mm;}body {font-family:'${currentFormat.fontFamily||'Cairo'}',sans-serif;font-size:${currentFormat.fontSize||'16px'};color:${currentFormat.fontColor||'#000000'};line-height:1.5;margin:0;padding:0;direction:rtl;}.prescription-content {padding:10mm;}@media print {body {-webkit-print-color-adjust:exact;print-color-adjust:exact;}.prescription-content {padding:0;} #commIcon, .comm-modal { display: none !important; }}</style></head><body><div class="prescription-content">${content}</div><script>window.onload=function(){window.print();setTimeout(function(){window.close();},500);};<\/script></body></html>`;
printWindow.document.write(printContent);
printWindow.document.close();
}

function renderSavedPrescriptions(){
const grid=document.getElementById('savedPrescriptionsGrid');
if(!grid)return;
grid.innerHTML='';
if(prescriptionTemplates.length===0){
grid.innerHTML='<p style="text-align:center;color:#666;padding:20px;grid-column:1/-1;">لا توجد روشتات محفوظة بعد</p>';
return;
}
prescriptionTemplates.forEach(prescription=>{
const card=document.createElement('div');
card.className='saved-prescription-card';
card.innerHTML=`<div class="saved-prescription-header"><div class="prescription-name">${prescription.name}</div><div><button class="action-btn edit-btn" onclick="editPrescriptionTemplate(${prescription.id})">تعديل</button><button class="action-btn delete-btn" onclick="deletePrescriptionTemplate(${prescription.id})">حذف</button></div></div><div class="prescription-meds-list">${prescription.medications.map(med=>`<div class="prescription-med-item"><span>${med.name}</span><span style="color:#888;font-size:11px;">${med.dosePerKg} ${med.doseUnit||''}</span></div>`).join('')}</div>`;
grid.appendChild(card);
});
}

function showAddPrescriptionModal(){
const list=document.getElementById('availableMedicationsList');
list.innerHTML='';
medications.forEach(med=>{
const div=document.createElement('div');
div.style.display='flex';
div.style.alignItems='center';
div.style.marginBottom='10px';
div.style.padding='10px';
div.style.border='1px solid #eee';
div.style.borderRadius='5px';
div.innerHTML=`<input type="checkbox" id="med_${med.id}" value="${med.id}" style="margin-left:10px;"><label for="med_${med.id}" style="flex:1;cursor:pointer;"><strong>${med.name}</strong><div style="font-size:12px;color:#666;">${med.concentration?`التركيز: ${med.concentration} ${med.concentrationUnit}`:''}</div></label>`;
div.querySelector('input').addEventListener('change',function(){
updateSelectedMedicationsList();
});
list.appendChild(div);
});
document.getElementById('selectedMedicationsList').innerHTML='<p style="color:#666;text-align:center;">لم يتم اختيار أي أدوية بعد</p>';
document.getElementById('addPrescriptionModal').style.display='block';
}

function updateSelectedMedicationsList(){
const list=document.getElementById('selectedMedicationsList');
const selectedIds=[];
medications.forEach(med=>{
const checkbox=document.getElementById(`med_${med.id}`);
if(checkbox&&checkbox.checked){
selectedIds.push(med.id);
}
});
if(selectedIds.length===0){
list.innerHTML='<p style="color:#666;text-align:center;">لم يتم اختيار أي أدوية بعد</p>';
return;
}
list.innerHTML='';
selectedIds.forEach(id=>{
const med=medications.find(m=>m.id===id);
if(med){
const div=document.createElement('div');
div.style.padding='8px';
div.style.marginBottom='5px';
div.style.background='white';
div.style.borderRadius='4px';
div.style.border='1px solid #ddd';
div.innerHTML=`<strong>${med.name}</strong><span style="font-size:12px;color:#666;margin-right:10px;">${med.concentration?`(${med.concentration} ${med.concentrationUnit})`:''}</span>`;
list.appendChild(div);
}
});
}

function savePrescriptionTemplate(){
const name=document.getElementById('prescriptionName').value.trim();
if(!name){
alert('الرجاء إدخال اسم للروشتة');
return;
}
const selectedIds=[];
medications.forEach(med=>{
const checkbox=document.getElementById(`med_${med.id}`);
if(checkbox&&checkbox.checked){
selectedIds.push(med.id);
}
});
if(selectedIds.length===0){
alert('الرجاء اختيار أدوية للروشتة');
return;
}
const prescription={
id:Date.now(),
name:name,
medications:selectedIds.map(id=>{
const med=medications.find(m=>m.id===id);
return{
id:med.id,
name:med.name,
dosePerKg:med.dosePerKg,
doseUnit:med.doseUnit,
concentration:med.concentration,
concentrationUnit:med.concentrationUnit
};
}),
createdAt:new Date().toISOString()
};
prescriptionTemplates.push(prescription);
localStorage.setItem('prescriptionTemplates',JSON.stringify(prescriptionTemplates));
alert('تم حفظ الروشتة بنجاح!');
closeModal('addPrescriptionModal');
renderSavedPrescriptions();
}

function editPrescriptionTemplate(id){
const prescription=prescriptionTemplates.find(p=>p.id===id);
if(!prescription)return;
editingPrescriptionId=id;
document.getElementById('editPrescriptionName').value=prescription.name;
const list=document.getElementById('editAvailableMedicationsList');
list.innerHTML='';
medications.forEach(med=>{
const isSelected=prescription.medications.some(m=>m.id===med.id);
const div=document.createElement('div');
div.style.display='flex';
div.style.alignItems='center';
div.style.marginBottom='10px';
div.style.padding='10px';
div.style.border='1px solid #eee';
div.style.borderRadius='5px';
div.innerHTML=`<input type="checkbox" id="edit_med_${med.id}" value="${med.id}" ${isSelected?'checked':''} style="margin-left:10px;"><label for="edit_med_${med.id}" style="flex:1;cursor:pointer;"><strong>${med.name}</strong><div style="font-size:12px;color:#666;">${med.concentration?`التركيز: ${med.concentration} ${med.concentrationUnit}`:''}</div></label>`;
div.querySelector('input').addEventListener('change',function(){
updateEditSelectedMedicationsList();
});
list.appendChild(div);
});
updateEditSelectedMedicationsList();
document.getElementById('editPrescriptionModal').style.display='block';
}

function updateEditSelectedMedicationsList(){
const list=document.getElementById('editSelectedMedicationsList');
const selectedIds=[];
medications.forEach(med=>{
const checkbox=document.getElementById(`edit_med_${med.id}`);
if(checkbox&&checkbox.checked){
selectedIds.push(med.id);
}
});
if(selectedIds.length===0){
list.innerHTML='<p style="color:#666;text-align:center;">لم يتم اختيار أي أدوية بعد</p>';
return;
}
list.innerHTML='';
selectedIds.forEach(id=>{
const med=medications.find(m=>m.id===id);
if(med){
const div=document.createElement('div');
div.style.padding='8px';
div.style.marginBottom='5px';
div.style.background='white';
div.style.borderRadius='4px';
div.style.border='1px solid #ddd';
div.innerHTML=`<strong>${med.name}</strong><span style="font-size:12px;color:#666;margin-right:10px;">${med.concentration?`(${med.concentration} ${med.concentrationUnit})`:''}</span>`;
list.appendChild(div);
}
});
}

function updatePrescriptionTemplate(){
const name=document.getElementById('editPrescriptionName').value.trim();
if(!name){
alert('الرجاء إدخال اسم للروشتة');
return;
}
const selectedIds=[];
medications.forEach(med=>{
const checkbox=document.getElementById(`edit_med_${med.id}`);
if(checkbox&&checkbox.checked){
selectedIds.push(med.id);
}
});
if(selectedIds.length===0){
alert('الرجاء اختيار أدوية للروشتة');
return;
}
const index=prescriptionTemplates.findIndex(p=>p.id===editingPrescriptionId);
if(index!==-1){
prescriptionTemplates[index]={
...prescriptionTemplates[index],
name:name,
medications:selectedIds.map(id=>{
const med=medications.find(m=>m.id===id);
return{
id:med.id,
name:med.name,
dosePerKg:med.dosePerKg,
doseUnit:med.doseUnit,
concentration:med.concentration,
concentrationUnit:med.concentrationUnit
};
}),
updatedAt:new Date().toISOString()
};
localStorage.setItem('prescriptionTemplates',JSON.stringify(prescriptionTemplates));
alert('تم تحديث الروشتة بنجاح!');
closeModal('editPrescriptionModal');
renderSavedPrescriptions();
}
}

function deletePrescriptionTemplate(id){
if(!id)id=editingPrescriptionId;
if(confirm('هل أنت متأكد من حذف هذه الروشتة المحفوظة؟')){
prescriptionTemplates=prescriptionTemplates.filter(p=>p.id!==id);
localStorage.setItem('prescriptionTemplates',JSON.stringify(prescriptionTemplates));
alert('تم حذف الروشتة بنجاح!');
if(editingPrescriptionId===id){
closeModal('editPrescriptionModal');
}
renderSavedPrescriptions();
}
}

function loadPrescriptionTemplate(){
const select=document.getElementById('savedPrescriptionsSelect');
const templateId=parseInt(select.value);
if(!templateId)return;
const template=prescriptionTemplates.find(p=>p.id===templateId);
if(!template)return;
if(!confirm(`هل تريد إضافة أدوية روشتة "${template.name}" إلى الروشتة الحالية؟`)){
select.value='';
return;
}
const weight=parseFloat(document.getElementById('visitWeight')?.value)||currentPatient.weight||0;
const ageYears=parseInt(currentPatient.ageYears)||0;
const ageMonths=parseInt(currentPatient.ageMonths)||0;
const totalMonths=(ageYears*12)+ageMonths;
template.medications.forEach(medData=>{
const med=medications.find(m=>m.id===medData.id);
if(med){
let doseInfo={};
let dose='';
let ageUnit='';
if(med.doseCalculationType==='age'&&med.ageDoses){
const ageDose=med.ageDoses.find(dose=>{
const fromMonths=(dose.fromYears*12)+dose.fromMonths;
const toMonths=(dose.toYears*12)+dose.toMonths;
return totalMonths>=fromMonths&&totalMonths<=toMonths;
});
if(ageDose){
dose=ageDose.dose;
ageUnit=getArabicUnit(ageDose.unit||'');
doseInfo={dose:ageDose.dose,unit:getArabicUnit(med.doseUnit||''),calculated:true};
}
}else{
doseInfo=calculateMedicationDose(med,weight);
dose=doseInfo.calculated?`${doseInfo.dose} ${doseInfo.unit}`:`${med.dosePerKg} ${getArabicUnit(med.doseUnit)}`;
}
const medication={
name:med.name,
displayName:generateMedicationDisplayName(med),
dose:dose,
frequency:med.doseCalculationType==='age'?(med.ageFrequency||''):(med.frequency||''),
duration:med.doseCalculationType==='age'?(med.ageDuration||''):(med.duration||''),
notes:med.doseNotes||'',
scientificName:med.scientificName||'',
type:med.type,
ageUnit:ageUnit
};
if(doseInfo.exceedsMax){
pendingMaxDoseMedication=medication;
showMaxDoseAlert(doseInfo);
}else if(checkDrugInteractions(medication)){
pendingMedication=medication;
showDrugInteractionAlert(medication);
}else{
currentPrescription.push(medication);
}
}
});
updatePrescriptionDisplay();
select.value='';
alert(`تم إضافة ${template.medications.length} دواء من الروشتة "${template.name}"`);
}

function checkDrugInteractions(newMed){
if(!newMed.scientificName||currentPrescription.length===0){
return false;
}
const newScientificName=newMed.scientificName.toLowerCase();
for(const existingMed of currentPrescription){
if(existingMed.scientificName){
const existingScientificName=existingMed.scientificName.toLowerCase();
if(newScientificName===existingScientificName){
return{
type:'نفس المادة الفعالة',
drug1:newMed.name,
drug2:existingMed.name,
scientificName:newScientificName,
reason:'نفس المادة الفعالة'
};
}
const newMedObj=medications.find(m=>m.scientificName&&m.scientificName.toLowerCase()===newScientificName);
const existingMedObj=medications.find(m=>m.scientificName&&m.scientificName.toLowerCase()===existingScientificName);
if(newMedObj&&newMedObj.interactions){
for(const interaction of newMedObj.interactions){
if(interaction.scientificName.toLowerCase()===existingScientificName){
return{
type:'تداخل دوائي',
drug1:newMed.name,
drug2:existingMed.name,
scientificName:existingScientificName,
reason:interaction.reason
};
}
}
}
if(existingMedObj&&existingMedObj.interactions){
for(const interaction of existingMedObj.interactions){
if(interaction.scientificName.toLowerCase()===newScientificName){
return{
type:'تداخل دوائي',
drug1:newMed.name,
drug2:existingMed.name,
scientificName:newScientificName,
reason:interaction.reason
};
}
}
}
}
}
return false;
}

function showDrugInteractionAlert(interaction){
const detailsDiv=document.getElementById('interactionDetails');
detailsDiv.innerHTML=`<p><strong>الدواء الجديد:</strong> ${pendingMedication.name}</p><p><strong>الدواء الموجود:</strong> ${interaction.drug2}</p><p><strong>نوع التنبيه:</strong> ${interaction.type}</p><p><strong>سبب التداخل:</strong> ${interaction.reason}</p>`;
document.getElementById('drugInteractionAlert').style.display='block';
}

function showMaxDoseAlert(doseInfo){
const detailsDiv=document.getElementById('maxDoseDetails');
detailsDiv.innerHTML=`<p><strong>الدواء:</strong> ${pendingMaxDoseMedication.name}</p><p><strong>الجرعة المحسوبة:</strong> ${doseInfo.dose} ${doseInfo.unit}</p><p><strong>الحد الأقصى المسموح:</strong> ${doseInfo.maxDose} ${doseInfo.unit}</p><p><strong>التنبيه:</strong> الجرعة المحسوبة تتجاوز الحد الأقصى المسموح به</p>`;
document.getElementById('maxDoseAlert').style.display='block';
}

function ignoreDrugInteraction(){
if(pendingMedication){
currentPrescription.push(pendingMedication);
updatePrescriptionDisplay();
pendingMedication=null;
}
document.getElementById('drugInteractionAlert').style.display='none';
}

function cancelDrugInteraction(){
pendingMedication=null;
document.getElementById('drugInteractionAlert').style.display='none';
}

function ignoreMaxDose(){
if(pendingMaxDoseMedication){
currentPrescription.push(pendingMaxDoseMedication);
updatePrescriptionDisplay();
pendingMaxDoseMedication=null;
}
document.getElementById('maxDoseAlert').style.display='none';
}

function cancelMaxDose(){
pendingMaxDoseMedication=null;
document.getElementById('maxDoseAlert').style.display='none';
}

function showPatientRecord(patientId){
const patient=patients.find(p=>p.id===patientId);
if(!patient)return;
const patientVisits=visits.filter(v=>v.patientId===patientId);
let content=`<div class="form-container"><h3>السجل المرضي - ${patient.fullName}</h3><div class="patient-info-grid"><div class="info-item"><div class="info-label">رقم الملف</div><div class="info-value">${patient.fileNumber}</div></div><div class="info-item"><div class="info-label">العمر</div><div class="info-value">${getAgeDisplay(patient)}</div></div><div class="info-item"><div class="info-label">الوزن</div><div class="info-value">${patient.weight||'-'} كجم</div></div><div class="info-item"><div class="info-label">الهاتف</div><div class="info-value">${patient.phone||'-'}</div></div></div><div class="visit-section"><h4>التاريخ المرضي المزمن</h4><p>${patient.chronicHistory||'لا توجد معلومات'}</p></div><div class="visit-section"><h4>الزيارات السابقة (${patientVisits.length})</h4>`;
if(patientVisits.length===0){
content+='<p style="text-align:center;color:#666;padding:20px;">لا توجد زيارات سابقة</p>';
}else{
patientVisits.forEach(visit=>{
content+=`<div class="visit-item"><div class="visit-header"><div class="visit-date">${visit.date}</div><button class="action-btn edit-btn" onclick="showVisitDetails(${visit.id})">عرض الزيارة</button></div><div class="visit-diagnosis"><strong>التشخيص:</strong> ${visit.diagnosis||'غير محدد'}</div></div>`;
});
}
content+=`</div></div>`;
document.getElementById('patientRecordContent').innerHTML=content;
document.getElementById('patientRecordModal').style.display='block';
}

function showVisitDetails(visitId){
const visit=visits.find(v=>v.id===visitId);
if(!visit)return;
let content=`<div class="form-container"><h3>تفاصيل الزيارة - ${visit.date}</h3><div class="patient-info-grid"><div class="info-item"><div class="info-label">اسم المريض</div><div class="info-value">${visit.patientName}</div></div><div class="info-item"><div class="info-label">العمر وقت الزيارة</div><div class="info-value">${visit.ageYears?visit.ageYears+' سنة':''} ${visit.ageMonths?'و '+visit.ageMonths+' شهر':''}</div></div><div class="info-item"><div class="info-label">الوزن</div><div class="info-value">${visit.weight||'-'} كجم</div></div><div class="info-item"><div class="info-label">الهاتف</div><div class="info-value">${visit.phone||'-'}</div></div></div><div class="visit-section"><h4>التاريخ المرضي للزيارة</h4><p style="white-space:pre-wrap">${visit.visitHistory||'لا توجد معلومات'}</p></div><div class="visit-section"><h4>التشخيص النهائي</h4><p style="white-space:pre-wrap">${visit.diagnosis||'غير محدد'}</p></div>`;
if(visit.prescription&&visit.prescription.length>0){
content+=`<div class="visit-section"><h4>الروشتة الطبية (${visit.prescription.length} دواء)</h4>`;
visit.prescription.forEach((med,index)=>{
let doseText=med.dose;
if(med.ageUnit&&!doseText.includes(med.ageUnit)){
doseText+=' '+med.ageUnit;
}
const durationText=med.duration?med.duration:'';
content+=`<div class="prescription-item"><div class="prescription-item-main">R/ ${med.displayName||med.name}</div><div class="prescription-item-details">${doseText} ${med.frequency?med.frequency:''}${durationText?` ${durationText}`:''} ${med.notes?' - '+med.notes:''}</div></div>`;
});
content+=`</div>`;
}
if(visit.additionalInstructions){
content+=`<div class="visit-section"><h4>تعليمات إضافية</h4><p style="white-space:pre-wrap">${visit.additionalInstructions}</p></div>`;
}
if(visit.nextVisit){
const nextVisitDate=new Date(visit.nextVisit).toLocaleDateString('ar-EG');
content+=`<div class="visit-section"><h4>ميعاد الزيارة القادمة</h4><p>${nextVisitDate}</p></div>`;
}
content+=`<div class="form-row" style="margin-top:20px;"><button class="login-btn" onclick="closeModal('visitDetailsModal')">إغلاق</button></div></div>`;
document.getElementById('visitDetailsContent').innerHTML=content;
document.getElementById('visitDetailsModal').style.display='block';
}

function showClinicSettings(){
document.getElementById('clinicNameInput').value=clinicSettings.clinicName;
document.getElementById('doctorNameInput').value=clinicSettings.doctorName;
document.getElementById('newUsername').value='';
document.getElementById('newPassword').value='';
document.getElementById('confirmPassword').value='';
document.getElementById('secretaryUsername').value=clinicSettings.secretaryUsername;
document.getElementById('secretaryPassword').value=clinicSettings.secretaryPassword;
document.getElementById('permPatients').checked=clinicSettings.permissions.patients;
document.getElementById('permAppointments').checked=clinicSettings.permissions.appointments;
document.getElementById('permMedications').checked=clinicSettings.permissions.medications;
document.getElementById('permReports').checked=clinicSettings.permissions.reports;
document.getElementById('currentClinicLogo').innerHTML=clinicSettings.clinicLogo||'👨‍⚕️';
document.getElementById('clinicSettingsModal').style.display='block';
}

// 1. حفظ بيانات العيادة (الاسم، الدكتور، اللوجو)
function saveClinicSettings() {
    const clinicName = document.getElementById('clinicNameInput').value.trim();
    const doctorName = document.getElementById('doctorNameInput').value.trim();
    const logoImg = document.getElementById('clinicLogoPreview');

    if (!clinicName || !doctorName) {
        alert('الرجاء إدخال جميع البيانات');
        return;
    }

    // تحديث المتغير العام
    clinicSettings.clinicName = clinicName;
    clinicSettings.doctorName = doctorName;
    if (logoImg) clinicSettings.logo = logoImg.src;

    // المزامنة السحابية والمحلية فوراً
    saveToStorage();

    // تحديث النصوص في كل واجهات السيستم (كما في كودك الأصلي)
    if(document.getElementById('loginClinicName')) document.getElementById('loginClinicName').textContent = clinicName;
    if(document.getElementById('loginDoctorName')) document.getElementById('loginDoctorName').textContent = doctorName;
    if(document.getElementById('dashboardClinicName')) document.getElementById('dashboardClinicName').textContent = clinicName + ' - نظام إدارة العيادة';
    if(document.getElementById('currentUser')) document.getElementById('currentUser').textContent = doctorName;
    if(document.getElementById('printClinicName')) document.getElementById('printClinicName').textContent = clinicName;
    if(document.getElementById('printDoctorName')) document.getElementById('printDoctorName').textContent = doctorName;

    alert('تم حفظ بيانات العيادة ومزامنتها بنجاح!');
    closeModal('clinicSettingsModal');
}

// 2. حفظ إعدادات السكرتير وصلاحياته
function saveSecretarySettings() {
    const secUser = document.getElementById('secretaryUsername').value.trim();
    const secPass = document.getElementById('secretaryPassword').value;

    if (!secUser || !secPass) {
        alert('الرجاء إدخال جميع البيانات');
        return;
    }

    clinicSettings.secretaryUsername = secUser;
    clinicSettings.secretaryPassword = secPass;
    
    // حفظ الصلاحيات بدقة كما كانت
    clinicSettings.permissions = {
        patients: document.getElementById('permPatients').checked,
        appointments: document.getElementById('permAppointments').checked,
        medications: document.getElementById('permMedications').checked,
        reports: document.getElementById('permReports').checked
    };

    saveToStorage(); // الرفع لجوجل لضمان تحديثها عند السكرتير
    alert('تم حفظ إعدادات وصلاحيات السكرتير بنجاح!');
}

// 3. تغيير بيانات دخول الطبيب (المستخدم الأساسي)
function changeLoginCredentials() {
    const newUsername = document.getElementById('newUsername').value.trim();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!newUsername || !newPassword) {
        alert('الرجاء إدخال جميع البيانات');
        return;
    }
    if (newPassword !== confirmPassword) {
        alert('كلمة المرور غير متطابقة');
        return;
    }

    clinicSettings.username = newUsername;
    clinicSettings.password = newPassword;

    saveToStorage(); // أهم خطوة لضمان الحفظ الدائم وعدم العودة للباسورد القديم
    
    alert('تم تغيير بيانات الدخول بنجاح! سيتم تسجيل الخروج لتأكيد البيانات الجديدة.');
    logout();
}
function updatePrescriptionWeight(){
const weightInput=document.getElementById('visitWeight');
if(weightInput){
const weight=parseFloat(weightInput.value);
if(weight&&weight>0){
currentPatient.weight=weight;
updateCurrentPrescriptionDoses();
}
}
}

function updateCurrentPrescriptionDoses(){
const weight=currentPatient.weight||0;
if(weight<=0)return;
updatePrescriptionDisplay();
}

function uploadClinicLogo(input){
if(input.files&&input.files[0]){
const reader=new FileReader();
reader.onload=function(e){
clinicSettings.clinicLogo=e.target.result;
updateClinicLogo();
localStorage.setItem('clinicSettings',JSON.stringify(clinicSettings));
};
reader.readAsDataURL(input.files[0]);
}
}

function openLogoSelection(){
const logoOptions=document.getElementById('logoOptions');
logoOptions.style.display=logoOptions.style.display==='flex'?'none':'flex';
}

function selectClinicLogo(logo){
clinicSettings.clinicLogo=logo;
updateClinicLogo();
localStorage.setItem('clinicSettings',JSON.stringify(clinicSettings));
document.getElementById('logoOptions').style.display='none';
}

function updateClinicLogo(){
const loginLogo=document.getElementById('loginClinicLogo');
const settingsLogo=document.getElementById('currentClinicLogo');
if(clinicSettings.clinicLogo&&clinicSettings.clinicLogo.startsWith('data:image')){
loginLogo.innerHTML='';
loginLogo.style.backgroundImage=`url(${clinicSettings.clinicLogo})`;
loginLogo.style.backgroundSize='cover';
settingsLogo.innerHTML='';
settingsLogo.style.backgroundImage=`url(${clinicSettings.clinicLogo})`;
settingsLogo.style.backgroundSize='cover';
}else{
loginLogo.style.backgroundImage='none';
loginLogo.innerHTML=clinicSettings.clinicLogo||'👨‍⚕️';
settingsLogo.style.backgroundImage='none';
settingsLogo.innerHTML=clinicSettings.clinicLogo||'👨‍⚕️';
}
}

document.getElementById('patientSearch').addEventListener('input',function(e){
const searchTerm=e.target.value;
const resultsDiv=document.getElementById('patientSearchResults');
resultsDiv.innerHTML='';
if(searchTerm.length<1){
resultsDiv.style.display='none';
return;
}
const filteredPatients=patients.filter(patient=>patient.fullName.toLowerCase().includes(searchTerm.toLowerCase()));
if(filteredPatients.length>0){
resultsDiv.style.display='block';
filteredPatients.forEach(patient=>{
const div=document.createElement('div');
div.className='autocomplete-item';
div.innerHTML=`<div><strong>${patient.fullName}</strong></div><div style="font-size:12px;color:var(--gray)">رقم الملف: ${patient.fileNumber} - الهاتف: ${patient.phone||'غير مسجل'}</div>`;
div.onclick=()=>{
document.getElementById('patientSearch').value=patient.fullName;
currentPatient=patient;
resultsDiv.style.display='none';
};
resultsDiv.appendChild(div);
});
}else{
resultsDiv.style.display='none';
}
});

document.getElementById('fileNumberSearch').addEventListener('input',function(e){
const searchTerm=e.target.value;
const resultsDiv=document.getElementById('fileNumberSearchResults');
resultsDiv.innerHTML='';
if(searchTerm.length<1){
resultsDiv.style.display='none';
return;
}
const filteredPatients=patients.filter(patient=>patient.fileNumber.toLowerCase().includes(searchTerm.toLowerCase()));
if(filteredPatients.length>0){
resultsDiv.style.display='block';
filteredPatients.forEach(patient=>{
const div=document.createElement('div');
div.className='autocomplete-item';
div.innerHTML=`<div><strong>${patient.fileNumber}</strong></div><div style="font-size:12px;color:var(--gray)">الاسم: ${patient.fullName} - الهاتف: ${patient.phone||'غير مسجل'}</div>`;
div.onclick=()=>{
document.getElementById('fileNumberSearch').value=patient.fileNumber;
currentPatient=patient;
resultsDiv.style.display='none';
};
resultsDiv.appendChild(div);
});
}else{
resultsDiv.style.display='none';
}
});

document.getElementById('phoneSearch').addEventListener('input',function(e){
const searchTerm=e.target.value;
const resultsDiv=document.getElementById('phoneSearchResults');
resultsDiv.innerHTML='';
if(searchTerm.length<1){
resultsDiv.style.display='none';
return;
}
const filteredPatients=patients.filter(patient=>patient.phone&&patient.phone.includes(searchTerm));
if(filteredPatients.length>0){
resultsDiv.style.display='block';
filteredPatients.forEach(patient=>{
const div=document.createElement('div');
div.className='autocomplete-item';
div.innerHTML=`<div><strong>${patient.phone}</strong></div><div style="font-size:12px;color:var(--gray)">الاسم: ${patient.fullName} - رقم الملف: ${patient.fileNumber}</div>`;
div.onclick=()=>{
document.getElementById('phoneSearch').value=patient.phone;
currentPatient=patient;
resultsDiv.style.display='none';
};
resultsDiv.appendChild(div);
});
}else{
resultsDiv.style.display='none';
}
});

document.addEventListener('click',(e)=>{
if(!e.target.matches('#patientSearch, #fileNumberSearch, #phoneSearch')){
document.getElementById('patientSearchResults').style.display='none';
document.getElementById('fileNumberSearchResults').style.display='none';
document.getElementById('phoneSearchResults').style.display='none';
}
});

document.getElementById('interactionSearch').addEventListener('input',function(e){
const searchTerm=e.target.value.toLowerCase();
const resultsDiv=document.getElementById('interactionSearchResults');
resultsDiv.innerHTML='';
if(searchTerm.length<1){
resultsDiv.style.display='none';
return;
}
const filteredMeds=medications.filter(med=>
med.name.toLowerCase().includes(searchTerm)||
(med.scientificName&&med.scientificName.toLowerCase().includes(searchTerm))
);
if(filteredMeds.length>0){
resultsDiv.style.display='block';
filteredMeds.forEach(med=>{
const div=document.createElement('div');
div.className='interaction-search-item';
div.innerHTML=`<div><strong>${med.name}</strong></div><div style="font-size:11px;color:#666">${med.scientificName||''}</div>`;
div.onclick=()=>{
document.getElementById('interactionSearch').value=med.scientificName||med.name;
resultsDiv.style.display='none';
};
resultsDiv.appendChild(div);
});
}else{
resultsDiv.style.display='none';
}
});

document.getElementById('editInteractionSearch').addEventListener('input',function(e){
const searchTerm=e.target.value.toLowerCase();
const resultsDiv=document.getElementById('editInteractionSearchResults');
resultsDiv.innerHTML='';
if(searchTerm.length<1){
resultsDiv.style.display='none';
return;
}
const filteredMeds=medications.filter(med=>
med.name.toLowerCase().includes(searchTerm)||
(med.scientificName&&med.scientificName.toLowerCase().includes(searchTerm))
);
if(filteredMeds.length>0){
resultsDiv.style.display='block';
filteredMeds.forEach(med=>{
const div=document.createElement('div');
div.className='interaction-search-item';
div.innerHTML=`<div><strong>${med.name}</strong></div><div style="font-size:11px;color:#666">${med.scientificName||''}</div>`;
div.onclick=()=>{
document.getElementById('editInteractionSearch').value=med.scientificName||med.name;
resultsDiv.style.display='none';
};
resultsDiv.appendChild(div);
});
}else{
resultsDiv.style.display='none';
}
});

document.addEventListener('click',(e)=>{
if(!e.target.matches('#interactionSearch, #editInteractionSearch')){
document.getElementById('interactionSearchResults').style.display='none';
document.getElementById('editInteractionSearchResults').style.display='none';
}
});


function showAddAppointmentModal(){
document.getElementById('addAppointmentModal').style.display='block';
resetAppointmentForm();
}

function resetAppointmentForm(){
document.getElementById('appointmentPatientSearch').value='';
document.getElementById('appointmentFileNumberSearch').value='';
document.getElementById('appointmentPhoneSearch').value='';
document.getElementById('appointmentPatientInfo').style.display='block';
document.getElementById('appointmentPatientName').value='';
document.getElementById('appointmentAgeYears').value='';
document.getElementById('appointmentAgeMonths').value='';
document.getElementById('appointmentWeight').value='';
document.getElementById('appointmentPhone').value='';
document.getElementById('appointmentFileNumber').value='P-'+(patients.length+1001);
document.getElementById('appointmentType').value='كشف';
currentAppointmentPatient=null;
}

function changeAppointmentDate(days){
const dateInput=document.getElementById('appointmentDate');
const currentDate=new Date(dateInput.value);
currentDate.setDate(currentDate.getDate()+days);
dateInput.value=currentDate.toISOString().split('T')[0];
loadAppointments();
}

function loadAppointments(){
const date=document.getElementById('appointmentDate').value;
const confirmedList=document.getElementById('confirmedAppointmentsList');
const pendingList=document.getElementById('pendingAppointmentsList');
const dateAppointments=appointments.filter(a=>a.date===date);
const confirmedAppointments=dateAppointments.filter(a=>a.status==='مؤكد'||a.status==='تمت الزيارة');
const pendingAppointments=dateAppointments.filter(a=>a.status==='منتظر');
confirmedList.innerHTML='';
pendingList.innerHTML='';
if(confirmedAppointments.length===0){
confirmedList.innerHTML='<p style="text-align:center;color:#666;padding:20px;">لا توجد حجوزات فعلية لهذا اليوم</p>';
}else{
confirmedAppointments.forEach((appointment,index)=>{
const item=document.createElement('div');
item.className='appointment-item '+(appointment.status==='تمت الزيارة'?'completed':'');
item.innerHTML=`<div class="appointment-item-header"><div><strong>${index+1}. ${appointment.patientName}</strong><div style="font-size:12px;color:#666">رقم الملف: ${appointment.fileNumber} - الهاتف: ${appointment.phone||'غير مسجل'}</div></div><div><span class="appointment-type">${appointment.type}</span><span class="appointment-status ${appointment.status}">${appointment.status}</span></div></div><div style="margin-top:10px"><span style="font-size:12px">العمر: ${appointment.ageYears||'0'} سنة ${appointment.ageMonths||'0'} شهر - الوزن: ${appointment.weight||'-'} كجم</span></div><div class="appointment-item-actions">`;
if(appointment.status!=='تمت الزيارة'){
if(currentUserType==='doctor'){
item.innerHTML+=`<button class="action-btn edit-btn" onclick="startVisitFromAppointment(${appointment.patientId})">بدء الزيارة</button>`;
}
item.innerHTML+=`<button class="action-btn delete-btn" onclick="deleteAppointment(${appointment.id})">حذف</button>`;
}else{
item.innerHTML+=`<span style="font-size:12px;color:var(--gray)">تمت الزيارة</span>`;
}
item.innerHTML+=`</div>`;
confirmedList.appendChild(item);
});
}
if(pendingAppointments.length===0){
pendingList.innerHTML='<p style="text-align:center;color:#666;padding:20px;">لا توجد حجوزات محتملة لهذا اليوم</p>';
}else{
pendingAppointments.forEach((appointment,index)=>{
const item=document.createElement('div');
item.className='appointment-item';
item.innerHTML=`<div class="appointment-item-header"><div><strong>${index+1}. ${appointment.patientName}</strong><div style="font-size:12px;color:#666">رقم الملف: ${appointment.fileNumber} - الهاتف: ${appointment.phone||'غير مسجل'}</div></div><div><span class="appointment-type">${appointment.type}</span><span class="appointment-status pending">منتظر</span></div></div><div style="margin-top:10px"><span style="font-size:12px">العمر: ${appointment.ageYears||'0'} سنة ${appointment.ageMonths||'0'} شهر - الوزن: ${appointment.weight||'-'} كجم</span></div><div class="appointment-item-actions"><button class="action-btn edit-btn" onclick="moveAppointmentToConfirmed(${appointment.id})">نقل للفعلية</button><button class="action-btn delete-btn" onclick="deleteAppointment(${appointment.id})">حذف</button></div>`;
pendingList.appendChild(item);
});
}
} // إغلاق الدالة السابقة

// --- 1. إصلاح الحجوزات والمريض الجديد مع المزامنة السحابية ---

function addAppointmentToConfirmed(){
    try {
        let patient = null;
        // جلب العناصر مع التأكد من وجودها (Safety Check)
        const elName = document.getElementById('appointmentPatientName');
        const elFile = document.getElementById('appointmentFileNumberSearch');
        const elPhone = document.getElementById('appointmentPhoneSearch');
        
        const patientName = elName ? elName.value.trim() : "";
        const fileNumberSearch = elFile ? elFile.value.trim() : "";
        const phoneNumberSearch = elPhone ? elPhone.value.trim() : "";
        
        // البحث عن المريض
        if(patientName){
            patient = patients.find(p => p.fullName === patientName);
        } else if(fileNumberSearch){
            patient = patients.find(p => p.fileNumber === fileNumberSearch);
        } else if(phoneNumberSearch){
            patient = patients.find(p => p.phone === phoneNumberSearch);
        }
        
        // إذا كان المريض جديداً
        if(!patient && patientName){
            patient = {
                id: Date.now(),
                fullName: patientName,
                ageYears: document.getElementById('appointmentAgeYears')?.value || "",
                ageMonths: document.getElementById('appointmentAgeMonths')?.value || "",
                weight: document.getElementById('appointmentWeight')?.value || "",
                phone: phoneNumberSearch,
                chronicHistory: '',
                fileNumber: fileNumberSearch || 'P-' + (patients.length + 1001),
                createdAt: new Date().toISOString()
            };
            patients.push(patient);
        }
        
        if(!patient){
            alert('الرجاء إدخال اسم المريض على الأقل');
            return;
        }
        
        // إنشاء الحجز
        const appointment = {
            id: Date.now() + Math.random(),
            patientId: patient.id,
            patientName: patient.fullName,
            date: document.getElementById('appointmentDate')?.value || new Date().toISOString().split('T')[0],
            type: document.getElementById('appointmentType')?.value || "كشف",
            status: 'مؤكد',
            ageYears: patient.ageYears,
            ageMonths: patient.ageMonths,
            weight: patient.weight,
            phone: patient.phone,
            fileNumber: patient.fileNumber
        };
        
        appointments.push(appointment);
        
        // الحفظ والتحديث (الخطوات التي كانت تتعطل)
        
        if(typeof loadAppointments === 'function') loadAppointments();
        
        // إغلاق النافذة فوراً
        closeModal('addAppointmentModal');
        
        alert('تم إضافة الحجز الفعلي بنجاح!');
        
    } catch (error) {
        console.error("خطأ في إضافة الحجز:", error);
        alert("حدث خطأ تقني، يرجى التأكد من ملء البيانات الأساسية");
        return;
    }
}
function addAppointmentToPending(){
    let patient=null;
    const patientName=document.getElementById('appointmentPatientName').value.trim();
    const fileNumber=document.getElementById('appointmentFileNumberSearch').value.trim();
    const phoneNumber=document.getElementById('appointmentPhoneSearch').value.trim();
    
    if(patientName){
        patient=patients.find(p=>p.fullName===patientName);
    }else if(fileNumber){
        patient=patients.find(p=>p.fileNumber===fileNumber);
    }else if(phoneNumber){
        patient=patients.find(p=>p.phone===phoneNumber);
    }
    
    if(!patient&&patientName){
        patient={
            id:Date.now(),
            fullName:patientName,
            ageYears:document.getElementById('appointmentAgeYears').value,
            ageMonths:document.getElementById('appointmentAgeMonths').value,
            weight:document.getElementById('appointmentWeight').value,
            phone:document.getElementById('appointmentPhone').value,
            chronicHistory:'',
            fileNumber:document.getElementById('appointmentFileNumber').value||'P-'+(patients.length+1001),
            createdAt:new Date().toLocaleDateString('ar-EG')
        };
        patients.push(patient);
        renderPatientsList();
    }
    
    if(!patient){
        alert('الرجاء إدخال بيانات المريض');
        return;
    }
    
    const appointment={
        id:Date.now() + Math.random(),
        patientId:patient.id,
        patientName:patient.fullName,
        date:document.getElementById('appointmentDate').value,
        type:document.getElementById('appointmentType').value,
        status:'منتظر',
        ageYears:patient.ageYears,
        ageMonths:patient.ageMonths,
        weight:patient.weight,
        phone:patient.phone,
        fileNumber:patient.fileNumber
    };
    
    appointments.push(appointment);
    
    // حفظ ومزامنة فورية لكل البيانات
    saveToStorage(); 
    
    loadAppointments();
    closeModal('addAppointmentModal');
    alert('تم إضافة الحجز المحتمل بنجاح!');
}

// دالة وسيطة لضمان أن أي حذف أو نقل حجز يتم رفعه للسحابة فوراً
function saveAppointments() {
    saveToStorage();
}

function moveAppointmentToConfirmed(appointmentId){
    const appointment=appointments.find(a=>a.id===appointmentId);
    if(appointment){
        appointment.status='مؤكد';
        saveAppointments();
        loadAppointments();
        alert('تم نقل الحجز للقائمة الفعلية بنجاح!');
    }
}

function deleteAppointment(appointmentId){
    const appointment=appointments.find(a=>a.id===appointmentId);
    if(!appointment)return;
    if(appointment.status==='تمت الزيارة'){
        alert('لا يمكن حذف حجز تمت زيارته بالفعل');
        return;
    }
    if(confirm('هل أنت متأكد من حذف هذا الحجز؟')){
        appointments=appointments.filter(a=>a.id!==appointmentId);
        saveAppointments();
        loadAppointments();
        alert('تم حذف الحجز بنجاح!');
    }
}

function startVisitFromAppointment(patientId){
    const patient=patients.find(p=>p.id===patientId);
    if(patient){
        currentPatient=patient;
        currentPrescription=[];
        additionalInstructions='';
        showVisitModal();
    }
}

// --- استكمال بقية وظائف البحث (كما هي دون تغيير) ---

document.getElementById('appointmentPatientSearch').addEventListener('input',function(e){
    const searchTerm=e.target.value;
    const resultsDiv=document.getElementById('appointmentPatientSearchResults');
    resultsDiv.innerHTML='';
    if(searchTerm.length<1){
        resultsDiv.style.display='none';
        return;
    }
    const filteredPatients=patients.filter(patient=>patient.fullName.toLowerCase().includes(searchTerm.toLowerCase()));
    if(filteredPatients.length>0){
        resultsDiv.style.display='block';
        filteredPatients.forEach(patient=>{
            const div=document.createElement('div');
            div.className='autocomplete-item';
            div.innerHTML=`<div><strong>${patient.fullName}</strong></div><div style="font-size:12px;color:var(--gray)">رقم الملف: ${patient.fileNumber} - الهاتف: ${patient.phone||'غير مسجل'}</div>`;
            div.onclick=()=>{
                document.getElementById('appointmentPatientSearch').value=patient.fullName;
                document.getElementById('appointmentPatientName').value=patient.fullName;
                document.getElementById('appointmentAgeYears').value=patient.ageYears||'';
                document.getElementById('appointmentAgeMonths').value=patient.ageMonths||'';
                document.getElementById('appointmentWeight').value=patient.weight||'';
                document.getElementById('appointmentPhone').value=patient.phone||'';
                document.getElementById('appointmentFileNumber').value=patient.fileNumber;
                resultsDiv.style.display='none';
            };
            resultsDiv.appendChild(div);
        });
    }else{
        resultsDiv.style.display='none';
    }
});

document.getElementById('appointmentFileNumberSearch').addEventListener('input',function(e){
    const searchTerm=e.target.value;
    const resultsDiv=document.getElementById('appointmentFileNumberSearchResults');
    resultsDiv.innerHTML='';
    if(searchTerm.length<1){
        resultsDiv.style.display='none';
        return;
    }
    const filteredPatients=patients.filter(patient=>patient.fileNumber.toLowerCase().includes(searchTerm.toLowerCase()));
    if(filteredPatients.length>0){
        resultsDiv.style.display='block';
        filteredPatients.forEach(patient=>{
            const div=document.createElement('div');
            div.className='autocomplete-item';
            div.innerHTML=`<div><strong>${patient.fileNumber}</strong></div><div style="font-size:12px;color:var(--gray)">الاسم: ${patient.fullName} - الهاتف: ${patient.phone||'غير مسجل'}</div>`;
            div.onclick=()=>{
                document.getElementById('appointmentFileNumberSearch').value=patient.fileNumber;
                document.getElementById('appointmentPatientName').value=patient.fullName;
                document.getElementById('appointmentAgeYears').value=patient.ageYears||'';
                document.getElementById('appointmentAgeMonths').value=patient.ageMonths||'';
                document.getElementById('appointmentWeight').value=patient.weight||'';
                document.getElementById('appointmentPhone').value=patient.phone||'';
                document.getElementById('appointmentFileNumber').value=patient.fileNumber;
                resultsDiv.style.display='none';
            };
            resultsDiv.appendChild(div);
        });
    }else{
        resultsDiv.style.display='none';
    }
});

document.getElementById('appointmentPhoneSearch').addEventListener('input',function(e){
    const searchTerm=e.target.value;
    const resultsDiv=document.getElementById('appointmentPhoneSearchResults');
    resultsDiv.innerHTML='';
    if(searchTerm.length<1){
        resultsDiv.style.display='none';
        return;
    }
    const filteredPatients=patients.filter(patient=>patient.phone&&patient.phone.includes(searchTerm));
    if(filteredPatients.length>0){
        resultsDiv.style.display='block';
        filteredPatients.forEach(patient=>{
            const div=document.createElement('div');
            div.className='autocomplete-item';
            div.innerHTML=`<div><strong>${patient.phone}</strong></div><div style="font-size:12px;color:var(--gray)">الاسم: ${patient.fullName} - رقم الملف: ${patient.fileNumber}</div>`;
            div.onclick=()=>{
                document.getElementById('appointmentPhoneSearch').value=patient.phone;
                document.getElementById('appointmentPatientName').value=patient.fullName;
                document.getElementById('appointmentAgeYears').value=patient.ageYears||'';
                document.getElementById('appointmentAgeMonths').value=patient.ageMonths||'';
                document.getElementById('appointmentWeight').value=patient.weight||'';
                document.getElementById('appointmentPhone').value=patient.phone||'';
                document.getElementById('appointmentFileNumber').value=patient.fileNumber;
                resultsDiv.style.display='none';
            };
            resultsDiv.appendChild(div);
        });
    }else{
        resultsDiv.style.display='none';
    }
});

document.addEventListener('click',(e)=>{
    if(!e.target.matches('#appointmentPatientSearch, #appointmentFileNumberSearch, #appointmentPhoneSearch')){
        document.getElementById('appointmentPatientSearchResults').style.display='none';
        document.getElementById('appointmentFileNumberSearchResults').style.display='none';
        document.getElementById('appointmentPhoneSearchResults').style.display='none';
    }
});

function printDirectPrescriptionWithDefaultFormat(){
    const defaultFormat=prescriptionFormats.find(f=>f.isDefault)||prescriptionFormats[0];
    if(defaultFormat){
        currentFormat={...defaultFormat};
        printCurrentFormatPreview();
    }else{
        printCurrentFormatPreview();
    }
}

// --- 2. إصلاح مزامنة المحادثة (Chat Sync) ---

function toggleCommModal(){
    const modal=document.getElementById('commModal');
    if(modal.style.display==='flex'){
        modal.style.display='none';
    }else{
        modal.style.display='flex';
        loadMessages();
        document.getElementById('commIcon').classList.remove('has-message');
    }
}

function loadMessages(){
    const container = document.getElementById('commMessages');
    if(!container) return;
    container.innerHTML = '';
    
    messages.forEach(msg => {
        const isMyMsg = msg.sender === currentUserType;
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${isMyMsg ? 'sender' : 'receiver'}`;
        
        // علامة الصح (صح واحد رمادي للإرسال، صحين زرق للقراءة)
        let statusHtml = '';
        if(isMyMsg) {
            statusHtml = msg.seen ? 
                '<span style="color:#3498db; margin-right:5px; font-weight:bold">✔✔</span>' : 
                '<span style="color:gray; margin-right:5px">✔</span>';
        }

        msgDiv.innerHTML = `
            <div class="message-content">
                ${msg.text}
                ${isMyMsg ? `<span onclick="deleteMessage(${msg.id})" style="cursor:pointer; opacity:0.4; margin-right:8px; font-size:10px">🗑️</span>` : ''}
            </div>
            <div class="message-time">${msg.time} - ${isMyMsg ? 'أنت' : 'الآخر'} ${statusHtml}</div>
        `;
        container.appendChild(msgDiv);
    });
    container.scrollTop = container.scrollHeight;
}

// 1. إرسال الرسالة مع تفعيل "لم تقرأ بعد"
function sendMessage(){
    const input = document.getElementById('commInput');
    const text = input.value.trim();
    if(!text) return;
    
    const message = {
        id: Date.now() + Math.random(), // ID فريد جداً للحذف بدقة
        sender: currentUserType,
        text: text,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
        seen: false // الرسالة تبدأ كـ غير مقروءة
    };
    
    messages.push(message);
    saveToStorage(); // المزامنة السحابية فوراً ليظهر التنبيه للطرف الآخر
    input.value = '';
    loadMessages();
}
function toggleCommModal() {
    const modal = document.getElementById('commModal');
    if (!modal) return;

    if (modal.style.display === 'flex') {
        modal.style.display = 'none';
    } else {
        modal.style.display = 'flex';
        
        // بمجرد فتح الشات: اجعل كل رسائل الطرف الآخر "مقروءة"
        let changed = false;
        messages.forEach(msg => {
            if (msg.sender !== currentUserType && !msg.seen) {
                msg.seen = true;
                changed = true;
            }
        });
        
        if (changed) saveToStorage(); // تحديث السحابة ليرى الطرف الآخر "صحين زرق"
        
        loadMessages(); // إعادة عرض الرسائل لتظهر علامات الصح
        
        // إزالة النقطة الحمراء (التنبيه)
        const icon = document.getElementById('commIcon');
        if (icon) icon.classList.remove('has-message');
    }
}
// 2. تحميل الرسائل من المتصفح (معدلة لتعمل مع المزامنة)
function loadMessagesFromStorage(){
    const saved = localStorage.getItem('clinicMessages');
    if(saved){
        messages = JSON.parse(saved);
        if(typeof loadMessages === "function") loadMessages();
    }
}
function deleteMessage(msgId) {
    if(confirm('هل تريد حذف هذه الرسالة من المحادثة؟ ستختفي من عند الطرفين أيضاً.')) {
        messages = messages.filter(m => m.id !== msgId);
        saveToStorage(); // مزامنة الحذف سحابياً
        loadMessages();
    }
}

document.addEventListener('keydown',function(e){
    if(e.key==='Delete'||e.key==='Backspace'){
        if(selectedHeaderElement){
            deleteSelectedHeaderElement();
        }else if(selectedFooterElement){
            deleteSelectedFooterElementNew();
        }else if(resizingImage){
            const formattingContainer=document.getElementById('formattingContainer');
            const selectedImage=formattingContainer.querySelector('img.resizable.selected');
            if(selectedImage){
                selectedImage.remove();
                imageHandles.forEach(h=>h.remove());
                imageHandles=[];
                resizingImage=null;
            }
        }
    }
    if(e.key==='Escape'){
        const modals=document.querySelectorAll('.modal, .text-editor-modal, .drug-interaction-alert');
        modals.forEach(modal=>{
            if(modal.style.display==='block'||modal.style.display==='flex'){
                modal.style.display='none';
            }
        });
    }
});

function showReportType(type){
    document.getElementById('dailyReport').style.display='none';
    document.getElementById('weeklyReport').style.display='none';
    document.getElementById('monthlyReport').style.display='none';
    if(type==='daily'){
        document.getElementById('dailyReport').style.display='block';
        generateDailyReport();
    }else if(type==='weekly'){
        document.getElementById('weeklyReport').style.display='block';
        generateWeeklyReport();
    }else if(type==='monthly'){
        document.getElementById('monthlyReport').style.display='block';
        generateMonthlyReport();
    }
}

function generateDailyReport(){
    const specificDay=document.getElementById('specificDay')?.value;
    const today=specificDay?new Date(specificDay).toLocaleDateString('ar-EG'):new Date().toLocaleDateString('ar-EG');
    const todayAppointments=appointments.filter(a=>a.date===today);
    const confirmedAppointments=todayAppointments.filter(a=>a.status==='مؤكد'||a.status==='تمت الزيارة');
    const checkups=confirmedAppointments.filter(a=>a.type==='كشف').length;
    const consultations=confirmedAppointments.filter(a=>a.type==='استشارة').length;
    const todayVisits=visits.filter(v=>v.date===today);
    const newPatients=patients.filter(p=>{
        const patientDate=new Date(p.createdAt).toLocaleDateString('ar-EG');
        return patientDate===today;
    });
    const content=`<div class="form-row"><div class="form-container" style="text-align:center"><h4>الحجوزات الفعلية</h4><div style="font-size:48px;color:var(--primary);font-weight:bold">${confirmedAppointments.length}</div><div style="font-size:14px;color:#666">كشف: ${checkups} - استشارة: ${consultations}</div></div><div class="form-container" style="text-align:center"><h4>الزيارات اليوم</h4><div style="font-size:48px;color:var(--accent);font-weight:bold">${todayVisits.length}</div><div style="font-size:14px;color:#666">كشف: ${todayVisits.filter(v=>!v.type||v.type==='كشف').length} - استشارة: ${todayVisits.filter(v=>v.type==='استشارة').length}</div></div><div class="form-container" style="text-align:center"><h4>مرضى جدد</h4><div style="font-size:48px;color:var(--secondary);font-weight:bold">${newPatients.length}</div></div></div><div class="form-container"><h4>تفاصيل الحجوزات الفعلية</h4><div id="dailyAppointmentsList"></div></div><div class="form-container"><h4>تفاصيل الزيارات</h4><div id="dailyVisitsList"></div></div>`;
    document.getElementById('dailyReportContent').innerHTML=content;
    const dailyAppointmentsList=document.getElementById('dailyAppointmentsList');
    dailyAppointmentsList.innerHTML='';
    if(confirmedAppointments.length===0){
        dailyAppointmentsList.innerHTML='<p style="text-align:center;color:#666;padding:20px">لا توجد حجوزات فعلية لهذا اليوم</p>';
    }else{
        confirmedAppointments.forEach((appointment,index)=>{
            const div=document.createElement('div');
            div.className='appointment-item';
            div.innerHTML=`<div><strong>${appointment.patientName}</strong> - ${appointment.type} - <span class="appointment-status ${appointment.status}">${appointment.status}</span></div><div style="font-size:12px;color:#666">الهاتف: ${appointment.phone||'غير مسجل'} - العمر: ${appointment.ageYears||0}س ${appointment.ageMonths||0}ش - الوزن: ${appointment.weight||'-'}كجم</div>`;
            dailyAppointmentsList.appendChild(div);
        });
    }
    const dailyVisitsList=document.getElementById('dailyVisitsList');
    dailyVisitsList.innerHTML='';
    if(todayVisits.length===0){
        dailyVisitsList.innerHTML='<p style="text-align:center;color:#666;padding:20px">لا توجد زيارات لهذا اليوم</p>';
    }else{
        todayVisits.forEach(visit=>{
            const div=document.createElement('div');
            div.className='visit-item';
            div.innerHTML=`<div><strong>${visit.patientName}</strong></div><div style="font-size:12px;color:#666">التشخيص: ${visit.diagnosis||'غير محدد'} - النوع: ${visit.type||'كشف'}</div>`;
            dailyVisitsList.appendChild(div);
        });
    }
}

function generateWeeklyReport(){
    const specificWeek=document.getElementById('specificWeek')?.value;
    let weekStart,weekEnd;
    if(specificWeek){
        const [year,week]=specificWeek.split('-W');
        weekStart=new Date(year,0,(week-1)*7+1);
        weekEnd=new Date(year,0,(week-1)*7+7);
    }else{
        const today=new Date();
        const dayOfWeek=today.getDay();
        const diff=today.getDate()-dayOfWeek+(dayOfWeek===0?-6:1);
        weekStart=new Date(today.setDate(diff));
        weekEnd=new Date(today.setDate(diff+6));
    }
    const weekAppointments=appointments.filter(a=>{
        const appDate=new Date(a.date);
        return appDate>=weekStart&&appDate<=weekEnd;
    });
    const weekVisits=visits.filter(v=>{
        const visitDate=new Date(v.date);
        return visitDate>=weekStart&&visitDate<=weekEnd;
    });
    const weekPatients=patients.filter(p=>{
        const patientDate=new Date(p.createdAt);
        return patientDate>=weekStart&&patientDate<=weekEnd;
    });
    const content=`<div class="form-row"><div class="form-container" style="text-align:center"><h4>إجمالي الحجوزات</h4><div style="font-size:48px;color:var(--primary);font-weight:bold">${weekAppointments.length}</div></div><div class="form-container" style="text-align:center"><h4>إجمالي الزيارات</h4><div style="font-size:48px;color:var(--accent);font-weight:bold">${weekVisits.length}</div><div style="font-size:14px;color:#666">كشف: ${weekVisits.filter(v=>!v.type||v.type==='كشف').length} - استشارة: ${weekVisits.filter(v=>v.type==='استشارة').length}</div></div><div class="form-container" style="text-align:center"><h4>مرضى جدد</h4><div style="font-size:48px;color:var(--secondary);font-weight:bold">${weekPatients.length}</div></div></div><div class="form-container"><h4>إحصائيات يومية</h4><div id="weeklyStatsChart"></div></div>`;
    document.getElementById('weeklyReportContent').innerHTML=content;
}

function generateMonthlyReport(){
    const specificMonth=document.getElementById('specificMonth')?.value;
    let monthStart,monthEnd;
    if(specificMonth){
        const [year,month]=specificMonth.split('-');
        monthStart=new Date(year,month-1,1);
        monthEnd=new Date(year,month,0);
    }else{
        const today=new Date();
        monthStart=new Date(today.getFullYear(),today.getMonth(),1);
        monthEnd=new Date(today.getFullYear(),today.getMonth()+1,0);
    }
    const monthAppointments=appointments.filter(a=>{
        const appDate=new Date(a.date);
        return appDate>=monthStart&&appDate<=monthEnd;
    });
    const monthVisits=visits.filter(v=>{
        const visitDate=new Date(v.date);
        return visitDate>=monthStart&&visitDate<=monthEnd;
    });
    const monthPatients=patients.filter(p=>{
        const patientDate=new Date(p.createdAt);
        return patientDate>=monthStart&&patientDate<=monthEnd;
    });
    const content=`<div class="form-row"><div class="form-container" style="text-align:center"><h4>إجمالي الحجوزات</h4><div style="font-size:48px;color:var(--primary);font-weight:bold">${monthAppointments.length}</div></div><div class="form-container" style="text-align:center"><h4>إجمالي الزيارات</h4><div style="font-size:48px;color:var(--accent);font-weight:bold">${monthVisits.length}</div><div style="font-size:14px;color:#666">كشف: ${monthVisits.filter(v=>!v.type||v.type==='كشف').length} - استشارة: ${monthVisits.filter(v=>v.type==='استشارة').length}</div></div><div class="form-container" style="text-align:center"><h4>مرضى جدد</h4><div style="font-size:48px;color:var(--secondary);font-weight:bold">${monthPatients.length}</div></div></div><div class="form-container"><h4>إحصائيات أسبوعية</h4><div id="monthlyStatsChart"></div></div>`;
    document.getElementById('monthlyReportContent').innerHTML=content;
}

// --- المحرك الشامل المطور (Nabed Core - V2) ---
// --- 1. محرك الحفظ والمزامنة المطور (يدعم IndexedDB + Firebase) ---
async function saveToStorage() {
    try {
        const activeID = clinicID || localStorage.getItem('nabed_clinic_id');

        const clinicData = {
            patients: typeof patients !== 'undefined' ? patients : [],
            visits: typeof visits !== 'undefined' ? visits : [],
            appointments: typeof appointments !== 'undefined' ? appointments : [],
            inventory: typeof inventory !== 'undefined' ? inventory : [],
            medications: typeof medications !== 'undefined' ? medications : [],
            messages: typeof messages !== 'undefined' ? messages : [],
            clinicSettings: typeof clinicSettings !== 'undefined' ? clinicSettings : {},
            prescriptionTemplates: typeof prescriptionTemplates !== 'undefined' ? prescriptionTemplates : [],
            prescriptionFormats: typeof prescriptionFormats !== 'undefined' ? prescriptionFormats : [],
            lastUpdate: new Date().toISOString()
        };

        // 1. الحفظ السريع (LocalStorage)
        localStorage.setItem('clinicData', JSON.stringify(clinicData));

        // 2. الحفظ في المستودع العملاق (IndexedDB) - للعمل أوفلاين لسنوات
        if (typeof saveToPermanentStorage === 'function') {
            await saveToPermanentStorage('clinicData', clinicData);
        }

        // 3. الرفع السحابي (Firebase)
        if (activeID && activeID !== "default") {
            db.collection('Clinics').doc(activeID).set(clinicData, { merge: true })
                .then(() => console.log("تمت المزامنة السحابية بنجاح: " + activeID))
                .catch(err => console.error("خطأ مزامنة سحابية:", err));
        }
            
    } catch (e) {
        console.error("Save Error:", e);
    }
}

// --- 2. محرك الاستقبال الذكي ومعالجة التعارض (The Smart Sync Engine) ---
async function syncFromCloud() {
    const activeID = clinicID || localStorage.getItem('nabed_clinic_id');
    if (!activeID) return;

    // أولاً: تحميل النسخة المحلية (IndexedDB) فوراً عند الفتح (للسرعة والأوفلاين)
    if (typeof getFromPermanentStorage === 'function') {
        const localData = await getFromPermanentStorage('clinicData');
        if (localData) {
            applyDataToSystem(localData, true); // true تعني بيانات محلية فقط
            console.log("تم تحميل البيانات المحلية بنجاح");
        }
    }

    // ثانياً: الاتصال بالسحاب والدمج الذكي لمنع ضياع بيانات الأوفلاين
    db.collection('Clinics').doc(activeID).onSnapshot(async (doc) => {
        if (doc.exists) {
            const cloudData = doc.data();
            const localData = await getFromPermanentStorage('clinicData');
            
            // استدعاء دالة الدمج لمقارنة المحلي بالسحابي
            const mergedData = mergeClinicData(localData, cloudData);
            
            applyDataToSystem(mergedData, false);
            console.log("تم الدمج والمزامنة مع السحاب بنجاح");

            // تحديث المخزن المحلي بالنسخة المدمجة الجديدة
            if (typeof saveToPermanentStorage === 'function') {
                await saveToPermanentStorage('clinicData', mergedData);
            }
        }
    }, (error) => {
        console.warn("تعذر الاتصال بالسحاب، أنت تعمل حالياً على النسخة المحلية فقط");
    });
}

// دالة الدمج الذكية: تقارن المصفوفات وتضيف العناصر الناقصة بناءً على الـ ID
function mergeClinicData(local, cloud) {
    if (!local) return cloud;
    if (!cloud) return local;

    const mergeList = (localList, cloudList) => {
        const combined = [...cloudList];
        localList.forEach(localItem => {
            // البحث عن العنصر في السحاب، إذا لم يوجد (تمت إضافته أوفلاين) يتم دمجه
            if (!combined.find(cloudItem => cloudItem.id === localItem.id)) {
                combined.push(localItem);
            }
        });
        return combined;
    };

    return {
        ...cloud,
        patients: mergeList(local.patients || [], cloud.patients || []),
        visits: mergeList(local.visits || [], cloud.visits || []),
        appointments: mergeList(local.appointments || [], cloud.appointments || []),
        inventory: mergeList(local.inventory || [], cloud.inventory || []),
        messages: mergeList(local.messages || [], cloud.messages || []),
        medications: mergeList(local.medications || [], cloud.medications || []),
        lastUpdate: new Date().toISOString()
    };
}

// دالة تطبيق البيانات وتحديث الواجهة
function applyDataToSystem(data, isLocalOnly) {
    if (!data) return;
    patients = data.patients || [];
    visits = data.visits || [];
    appointments = data.appointments || [];
    inventory = data.inventory || [];
    messages = data.messages || [];
    medications = data.medications || [];
    if(data.clinicSettings) clinicSettings = data.clinicSettings;

    // تحديث كل أجزاء الواجهة البرمجية
    renderPatientsList();
    loadAppointments();
    updateStats();
    if(typeof renderMedicationsList === 'function') renderMedicationsList();
    if(typeof loadMessages === 'function') loadMessages();
    
    const clinicNameDisplay = document.getElementById('dashboardClinicName');
    if(clinicNameDisplay) clinicNameDisplay.innerText = "عيادة: " + (clinicID || "جاري التحميل...");
    
    // إذا كان هناك إنترنت وتم الدمج، نرفع النسخة النهائية للسحاب ليراها باقي الأجهزة
    if (!isLocalOnly && typeof saveToStorage === 'function') {
        setTimeout(saveToStorage, 2000); 
    }
}

// --- 3. تشغيل المزامنة عند فتح الصفحة ---
window.addEventListener('load', function() {
    syncFromCloud();
});
</script>
<script>
// كود تحريك أيقونة المحادثة
(function() {
    const dragItem = document.querySelector("#commIcon");
    if (!dragItem) return;
    let active = false, currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

    dragItem.addEventListener("touchstart", dragStart, false);
    document.addEventListener("touchend", dragEnd, false);
    document.addEventListener("touchmove", drag, false);
    dragItem.addEventListener("mousedown", dragStart, false);
    document.addEventListener("mouseup", dragEnd, false);
    document.addEventListener("mousemove", drag, false);

    function dragStart(e) {
        if (e.type === "touchstart") {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }
        if (e.target === dragItem) active = true;
    }
    function dragEnd() { initialX = currentX; initialY = currentY; active = false; }
    function drag(e) {
        if (active) {
            e.preventDefault();
            let clientX = e.type === "touchmove" ? e.touches[0].clientX : e.clientX;
            let clientY = e.type === "touchmove" ? e.touches[0].clientY : e.clientY;
            currentX = clientX - initialX;
            currentY = clientY - initialY;
            xOffset = currentX; yOffset = currentY;
            dragItem.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
        }
    }
})();
</script><script>
// ==========================================
// محرك "نابض" للهوية والتخزين المستقبلي (IndexedDB)
// ==========================================
const dbName = "NabedClinicDB";
const storeName = "clinicData";

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName);
            }
        };
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e.target.error);
    });
}

async function saveToPermanentStorage(key, data) {
    try {
        const db = await openDB();
        const tx = db.transaction(storeName, "readwrite");
        tx.objectStore(storeName).put(data, key);
        return tx.complete;
    } catch (e) { console.error("Error saving to IndexedDB", e); }
}

async function getFromPermanentStorage(key) {
    try {
        const db = await openDB();
        return new Promise((resolve) => {
            const request = db.transaction(storeName).objectStore(storeName).get(key);
            request.onsuccess = () => resolve(request.result);
        });
    } catch (e) { console.error("Error loading from IndexedDB", e); }
}

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const CACHE_NAME = 'nabed-fortress-v1';
        const ASSETS_TO_CACHE = [
            window.location.pathname,
            window.location.href,
            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css',
            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css',
            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'
        ];

        const swCode = `
            const CACHE_NAME = '${CACHE_NAME}';
            const ASSETS = ${JSON.stringify(ASSETS_TO_CACHE)};

            self.addEventListener('install', (e) => {
                e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)));
                self.skipWaiting();
            });

            self.addEventListener('activate', (e) => {
                e.waitUntil(clients.claim());
            });

            self.addEventListener('fetch', (e) => {
                e.respondWith(
                    caches.match(e.request).then(res => {
                        return res || fetch(e.request).then(fetchRes => {
                            return caches.open(CACHE_NAME).then(cache => {
                                if(e.request.url.startsWith('http')) cache.put(e.request, fetchRes.clone());
                                return fetchRes;
                            });
                        });
                    }).catch(() => caches.match(window.location.href))
                );
            });
        `;

        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl)
            .then(() => console.log('تم تفعيل حصن "نابض" للعمل أوفلاين لسنوات'))
            .catch((err) => console.log('SW Registration Failed:', err));
    });
}

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    console.log('النظام جاهز للتثبيت بنجاح');
});

document.addEventListener('DOMContentLoaded', function() {
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) {
        loginBtn.addEventListener('click', function() {
            patients = []; visits = []; appointments = []; 
            inventory = []; messages = []; medications = [];
            
            const idInput = document.getElementById('clinicIdInput').value.trim();
            if (idInput) {
                clinicID = idInput;
                setTimeout(() => {
                    if (typeof syncFromCloud === 'function') syncFromCloud();
                }, 500);
            }
        }, true);
    }
});

function updateMessageBadge() {
    const chatIcon = document.querySelector('.comm-icon');
    if (!chatIcon) return;

    let badge = document.querySelector('.chat-badge');
    if (!badge) {
        badge = document.createElement('span');
        badge.className = 'chat-badge';
        badge.style = "position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:18px; height:18px; font-size:11px; display:flex; align-items:center; justify-content:center; border:2px solid white; z-index:1001;";
        chatIcon.appendChild(badge);
    }

    const chatModal = document.getElementById('commModal');
    const isChatOpen = chatModal && chatModal.style.display === 'flex';

    if (typeof messages !== 'undefined' && messages.length > 0) {
        const unreadCount = messages.filter(m => m.sender !== currentUserType && !m.seen).length;
        if (unreadCount > 0 && !isChatOpen) {
            badge.style.display = 'flex';
            badge.textContent = unreadCount;
        } else {
            badge.style.display = 'none';
        }
    } else {
        badge.style.display = 'none';
    }
}
setInterval(updateMessageBadge, 3000);
</script></body>
</html>